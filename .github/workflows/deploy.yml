name: Deploy to GitHub Pages

on:
  push:
    branches: [ main ]
  workflow_dispatch:

# GitHub Pagesã¸ã®ãƒ‡ãƒ—ãƒ­ã‚¤æ¨©é™
permissions:
  contents: read
  pages: write
  id-token: write

# åŒæ™‚å®Ÿè¡Œã®åˆ¶å¾¡ï¼ˆåŒæ™‚ã«1ã¤ã®ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆã®ã¿ï¼‰
concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  # E2Eãƒ†ã‚¹ãƒˆãŒæˆåŠŸã—ãŸå ´åˆã®ã¿ãƒ‡ãƒ—ãƒ­ã‚¤
  validate-before-deploy:
    runs-on: ubuntu-latest
    outputs:
      should-deploy: ${{ steps.check.outputs.result }}
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Install Playwright
      run: npx playwright install chromium

    - name: Run critical E2E tests
      id: check
      run: |
        # ãƒ‡ãƒ—ãƒ­ã‚¤å‰ã«é‡è¦ãªãƒ†ã‚¹ãƒˆã®ã¿å®Ÿè¡Œ
        npx playwright test tests/e2e/game-startup.spec.js tests/e2e/core-html-functionality.spec.js --reporter=json > deploy-test-results.json
        
        if [ $? -eq 0 ]; then
          echo "result=true" >> $GITHUB_OUTPUT
          echo "âœ… Critical tests passed - Ready for deployment" >> $GITHUB_STEP_SUMMARY
        else
          echo "result=false" >> $GITHUB_OUTPUT
          echo "âŒ Critical tests failed - Deployment blocked" >> $GITHUB_STEP_SUMMARY
          exit 1
        fi

    - name: Upload pre-deploy test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: pre-deploy-tests
        path: deploy-test-results.json
        retention-days: 7

  # ãƒ“ãƒ«ãƒ‰ã¨ãƒ‡ãƒ—ãƒ­ã‚¤
  deploy:
    needs: validate-before-deploy
    if: needs.validate-before-deploy.outputs.should-deploy == 'true'
    runs-on: ubuntu-latest
    
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Prepare deployment directory
      run: |
        mkdir -p _site
        
        # docsãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®å†…å®¹ã‚’ã‚³ãƒ”ãƒ¼
        if [ -d "docs" ]; then
          cp -r docs/* _site/
        fi
        
        # README.mdã‚’index.mdã¨ã—ã¦ã‚³ãƒ”ãƒ¼ï¼ˆGitHub Pagesç”¨ï¼‰
        if [ -f "README.md" ]; then
          cp README.md _site/README.md
        fi
        
        # ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆæƒ…å ±ã‚’è¿½åŠ 
        echo "<!-- Deployed on $(date) from commit ${{ github.sha }} -->" >> _site/game.html

    - name: Add deployment metadata
      run: |
        # ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆæƒ…å ±ã®JSONãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆ
        cat > _site/deployment-info.json << EOF
        {
          "deployedAt": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
          "commit": "${{ github.sha }}",
          "branch": "${{ github.ref_name }}",
          "runId": "${{ github.run_id }}",
          "runNumber": "${{ github.run_number }}",
          "actor": "${{ github.actor }}",
          "repository": "${{ github.repository }}"
        }
        EOF

    - name: Optimize for production
      run: |
        # HTMLãƒ•ã‚¡ã‚¤ãƒ«ã®æœ€é©åŒ–ï¼ˆã‚³ãƒ¡ãƒ³ãƒˆé™¤å»ã€ç©ºç™½æœ€å°åŒ–ï¼‰
        if command -v npx &> /dev/null; then
          # html-minifierãŒåˆ©ç”¨å¯èƒ½ãªå ´åˆã¯æœ€é©åŒ–
          npx html-minifier --collapse-whitespace --remove-comments --input-dir _site --output-dir _site --file-ext html || echo "HTML optimization skipped"
        fi
        
        # ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºãƒ¬ãƒãƒ¼ãƒˆã®ç”Ÿæˆ
        echo "## Deployment File Sizes" > _site/file-sizes.txt
        find _site -type f -exec ls -lh {} \; | awk '{print $5 " " $9}' >> _site/file-sizes.txt

    - name: Setup Pages
      uses: actions/configure-pages@v4

    - name: Upload to GitHub Pages
      uses: actions/upload-pages-artifact@v3
      with:
        path: '_site'

    - name: Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4

    - name: Post-deployment verification
      run: |
        # ãƒ‡ãƒ—ãƒ­ã‚¤å¾Œã®åŸºæœ¬çš„ãªæ¤œè¨¼
        url="${{ steps.deployment.outputs.page_url }}"
        echo "Verifying deployment at: $url"
        
        # 30ç§’å¾…æ©Ÿã—ã¦ã‹ã‚‰ã‚¢ã‚¯ã‚»ã‚¹ç¢ºèª
        sleep 30
        
        # HTTP ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚³ãƒ¼ãƒ‰ã®ç¢ºèª
        status_code=$(curl -s -o /dev/null -w "%{http_code}" "$url" || echo "000")
        
        if [ "$status_code" = "200" ]; then
          echo "âœ… Deployment verification successful" >> $GITHUB_STEP_SUMMARY
          echo "ğŸ® Game is live at: $url" >> $GITHUB_STEP_SUMMARY
        else
          echo "âŒ Deployment verification failed (HTTP $status_code)" >> $GITHUB_STEP_SUMMARY
        fi

  # ãƒ‡ãƒ—ãƒ­ã‚¤å¾Œã®ã‚¹ãƒ¢ãƒ¼ã‚¯ãƒ†ã‚¹ãƒˆ
  post-deploy-test:
    needs: deploy
    runs-on: ubuntu-latest
    if: always() && needs.deploy.result == 'success'
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Install Playwright
      run: npx playwright install chromium

    - name: Run smoke tests on deployed site
      run: |
        # ãƒ‡ãƒ—ãƒ­ã‚¤ã•ã‚ŒãŸã‚µã‚¤ãƒˆã«å¯¾ã—ã¦ã‚¹ãƒ¢ãƒ¼ã‚¯ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œ
        DEPLOYED_URL="${{ needs.deploy.outputs.page_url || 'https://github.com/pages/' }}"
        
        # Playwrightãƒ†ã‚¹ãƒˆã‚’æœ¬ç•ªURL againstå®Ÿè¡Œ
        PLAYWRIGHT_BASE_URL="$DEPLOYED_URL" npx playwright test tests/e2e/game-startup.spec.js --reporter=json > smoke-test-results.json || echo "Smoke tests completed"
        
        echo "## Post-Deployment Smoke Test Results" >> $GITHUB_STEP_SUMMARY
        if grep -q '"status": "passed"' smoke-test-results.json; then
          echo "âœ… Smoke tests passed on production deployment" >> $GITHUB_STEP_SUMMARY
        else
          echo "âš ï¸ Some smoke tests failed - please check deployment" >> $GITHUB_STEP_SUMMARY
        fi

    - name: Upload smoke test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: smoke-test-results
        path: smoke-test-results.json
        retention-days: 7

    - name: Create deployment summary
      run: |
        echo "## ğŸš€ Deployment Summary" >> $GITHUB_STEP_SUMMARY
        echo "- **Repository**: ${{ github.repository }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Branch**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Deployed by**: ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Deployment time**: $(date)" >> $GITHUB_STEP_SUMMARY
        echo "- **URL**: ${{ needs.deploy.outputs.page_url || 'Not available' }}" >> $GITHUB_STEP_SUMMARY