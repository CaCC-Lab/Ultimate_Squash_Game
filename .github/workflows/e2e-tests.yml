name: E2E Tests

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  schedule:
    # æ¯Žæ—¥åˆå‰3æ™‚ï¼ˆJSTï¼‰ã«å®Ÿè¡Œï¼ˆãƒªã‚°ãƒ¬ãƒƒã‚·ãƒ§ãƒ³ãƒ†ã‚¹ãƒˆï¼‰
    - cron: '0 18 * * *'

jobs:
  e2e-tests:
    timeout-minutes: 60
    runs-on: ubuntu-latest
    
    strategy:
      fail-fast: false
      matrix:
        browser: [chromium, firefox, webkit]
        node-version: [18, 20]
        include:
          - browser: chromium
            node-version: 20
            coverage: true

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node-version }}
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Install Playwright Browsers
      run: npx playwright install --with-deps ${{ matrix.browser }}

    - name: Run E2E tests
      run: npx playwright test --project=${{ matrix.browser }}
      env:
        # Playwrightã®è¨­å®š
        PLAYWRIGHT_WORKERS: 1
        # ãƒ†ã‚¹ãƒˆç’°å¢ƒã®è¨­å®š
        NODE_ENV: test

    - name: Generate test report
      if: always()
      run: |
        echo "## E2E Test Results - ${{ matrix.browser }} (Node.js ${{ matrix.node-version }})" >> $GITHUB_STEP_SUMMARY
        if [ -f test-results/results.json ]; then
          npx playwright show-report --reporter=github >> $GITHUB_STEP_SUMMARY
        fi

    - name: Upload test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: playwright-report-${{ matrix.browser }}-node${{ matrix.node-version }}
        path: |
          playwright-report/
          test-results/
        retention-days: 30

    - name: Upload coverage reports
      if: matrix.coverage && always()
      uses: actions/upload-artifact@v4
      with:
        name: coverage-report
        path: coverage/
        retention-days: 30

  # ãƒ†ã‚¹ãƒˆçµæžœã®çµ±åˆã¨Slacké€šçŸ¥
  test-summary:
    needs: e2e-tests
    runs-on: ubuntu-latest
    if: always()
    
    steps:
    - name: Download all test artifacts
      uses: actions/download-artifact@v4
      with:
        path: artifacts

    - name: Create test summary
      run: |
        echo "# E2E Test Summary" > test-summary.md
        echo "" >> test-summary.md
        
        # å„ãƒ–ãƒ©ã‚¦ã‚¶ãƒ»Node.jsãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®çµæžœã‚’é›†è¨ˆ
        for dir in artifacts/playwright-report-*; do
          if [ -d "$dir" ]; then
            browser=$(basename "$dir" | sed 's/playwright-report-//' | sed 's/-node[0-9]*//')
            node_version=$(basename "$dir" | grep -o 'node[0-9]*' | sed 's/node//')
            echo "## $browser (Node.js $node_version)" >> test-summary.md
            
            # ãƒ†ã‚¹ãƒˆçµæžœã®è©³ç´°ã‚’è¿½åŠ 
            if [ -f "$dir/test-results/results.json" ]; then
              echo "âœ… Test results available" >> test-summary.md
            else
              echo "âŒ Test results missing" >> test-summary.md
            fi
            echo "" >> test-summary.md
          fi
        done

    - name: Comment PR with test results
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          if (fs.existsSync('test-summary.md')) {
            const summary = fs.readFileSync('test-summary.md', 'utf8');
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `ðŸŽ® **Ultimate Squash Game E2E Test Results**\n\n${summary}`
            });
          }

  # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã¨å“è³ªãƒã‚§ãƒƒã‚¯
  security-audit:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Run security audit
      run: |
        npm audit --audit-level=moderate
        echo "## Security Audit Results" >> $GITHUB_STEP_SUMMARY
        npm audit --audit-level=moderate --json | jq '.vulnerabilities | length' | xargs -I {} echo "Found {} vulnerabilities" >> $GITHUB_STEP_SUMMARY

    - name: Check for secrets
      uses: trufflesecurity/trufflehog@main
      with:
        path: ./
        base: main
        head: HEAD
        extra_args: --debug --only-verified

  # ãƒ‘ãƒ•ã‚©ãƒ¼ãƒžãƒ³ã‚¹ç›£è¦–
  performance-monitoring:
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Install Playwright
      run: npx playwright install chromium

    - name: Run performance tests
      run: |
        npx playwright test tests/e2e/performance.spec.js --reporter=json > performance-results.json
        
        # ãƒ‘ãƒ•ã‚©ãƒ¼ãƒžãƒ³ã‚¹çµæžœã®è§£æž
        echo "## Performance Test Results" >> $GITHUB_STEP_SUMMARY
        if [ -f performance-results.json ]; then
          # FPSã€ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡ã€ãƒ­ãƒ¼ãƒ‰æ™‚é–“ãªã©ã®æŒ‡æ¨™ã‚’æŠ½å‡º
          echo "Performance metrics collected successfully" >> $GITHUB_STEP_SUMMARY
        fi

    - name: Upload performance results
      uses: actions/upload-artifact@v4
      with:
        name: performance-results
        path: performance-results.json
        retention-days: 90