# Ultimate Squash Game - 実装計画

作成日: 2025-01-13
最終更新: 2025-01-13
担当者: Claude Code + Gemini CLI [AI-PAIRED]

## 概要
**段階的ハイブリッド移行戦略**: 既存Tkinter版MVCパターンを完成させつつ、Pygame-CE + WASM版への移行を並行実施
要件定義書v1.1に基づく新技術スタック対応と個人開発規約遵守を両立

## 前提条件
- [x] プロジェクト構成ファイルの確認 → 完了（要件書v1.1発見）
- [x] 要件定義書v1.1の分析 → Pygame-CE + WASM移行が必要
- [x] 開発実装計画書v1.1の分析 → 90人日規模を個人開発に調整
- [ ] 技術移行戦略の確定（Tkinter → Pygame-CE段階移行）
- [ ] Python環境移行計画（3.6 → 3.12）
- [ ] 新技術スタックの学習（Pyodide, Vercel Functions）

## 実装チェックリスト

### フェーズ1: プロジェクト基盤整備（見積もり: 2h）✅ 完了
- [x] プロジェクト構成ファイルの作成
  - [x] technologystack.md の作成
  - [x] directorystructure.md の作成  
  - [x] test-strategy.md の作成
- [x] ディレクトリ構造のリファクタリング
  - [x] src/ ディレクトリの作成
  - [x] 既存ファイルの適切な配置（game_engine.py → src/game/engine.py）
  - [x] tests/ ディレクトリの構築
- [x] 基本テスト環境の構築
  - [x] pytest のセットアップ
  - [x] 初期テストファイルの作成

### フェーズ1.5: engine.pyリファクタリング（見積もり: 3h）✅ 完了
- [x] 特性化テスト（Characterization Test）の作成
  - [x] 現在のengine.pyの動作を記録するテスト（11テスト成功）
  - [x] ゲーム状態変化のスナップショット保存
  - [x] UI表示内容の期待値記録
- [x] Model抽出（MVCパターン移行）
  - [x] GameStateクラスの作成（純粋データクラス）
  - [x] Ball, Racket, Scoreエンティティの分離（18テスト成功）
  - [x] 物理計算ロジックのModel移動
  - [x] Observerパターンの実装（Model→View通知）
- [x] View分離
  - [x] GameViewクラスの作成（描画専用）
  - [x] GameObserverインターフェースの実装
  - [x] tkinter描画処理の分離
  - [x] エラーハンドリング（3要素準拠）
- [x] Controller分離
  - [x] GameControllerクラスの作成（5テスト成功）
  - [x] イベント処理の分離（マウス、クリック、キー）
  - [x] Model-View連携の実装（Observerパターン管理）
  - [x] ゲームループ制御の実装

### フェーズ2A: 現行Tkinter版完成（見積もり: 3h）✅ 完了
- [x] ユニットテストの作成（TDD実践）
  - [x] GameStateの詳細テスト
    - [x] ボール物理演算のテスト（速度、角度、反射）✅ 5テスト作成・成功
      - [x] ボール速度の大きさ計算（ADA機能基盤）
      - [x] ボール速度の角度計算（反射角度調整基盤）
      - [x] 壁反射角度の精密テスト（物理法則準拠）
      - [x] ボール境界衝突精密テスト
    - [x] 衝突検出のテスト（ラケット、壁、境界）✅ 2テスト作成・成功
      - [x] ラケット端での衝突検出テスト
      - [x] 画面角での複合衝突処理テスト
    - [x] スコア計算のテスト（ポイント、コンボシステム）✅ 既存テスト活用
  - [x] GameViewの描画テスト✅ 22テスト作成・成功
    - [x] 描画更新のテスト（通常状態、ポーズ状態、ゲームオーバー状態）
    - [x] Observer通知のテスト（パターン実装確認、スコア表示更新）
    - [x] エラーハンドリングテスト✅ 4テスト追加（カバー行63-72, 199-201, 212）
    - [x] サウンドシステムテスト✅ 3テスト追加（Windows環境・例外処理カバー）
  - [x] GameControllerの統合テスト✅ 30テスト作成・成功
    - [x] イベント処理のテスト（マウス、クリック、ポーズ切り替え）
    - [x] Model-View協調のテスト（Observer統合、ゲームループサイクル）
    - [x] 完全エラーハンドリングテスト✅ 14テスト追加（100%カバレッジ達成）
- [x] 実装（TDD手法）
  - [x] ADA機能基盤メソッドの実装✅ `get_ball_speed()`, `get_ball_angle()`
  - [x] ラケット衝突判定の精密化✅ `future_y >= self.RACKET_Y`
  - [x] コンボシステムの完全実装✅ 数学的検証含む
  - [x] パフォーマンス最適化✅ 物理演算精密化
  - [x] エラーハンドリング強化✅ 3要素準拠・完全カバレッジ
- [x] 品質確認
  - [x] テストカバレッジ84%達成✅ GameState 91%、GameView 99%、GameController 100%
  - [x] 統合テスト: ゲーム全体動作確認✅ 91テスト全成功

### フェーズ2B: Pygame-CE移行準備（見積もり: 4h）
- [ ] 新技術環境構築
  - [ ] Python 3.12環境セットアップ
  - [ ] Pygame-CE 2.5インストールと動作確認
  - [ ] Pyodide 0.28環境構築
- [ ] 並行ブランチ作成
  - [ ] feature/pygame-wasm-migration ブランチ作成
  - [ ] 新ディレクトリ構造設計（pygame_version/）
- [ ] MVCパターン移植実験
  - [ ] GameState → Pygame-CE対応版の作成
  - [ ] 基本描画システムの実装（Pygame Surface）
  - [ ] 入力システムの実装（Pygame Events）
- [ ] 技術検証
  - [ ] Pyodide WASMビルドテスト
  - [ ] ブラウザ動作確認

### フェーズ3: ハイブリッド開発・技術統合（見積もり: 5h）
- [ ] 両バージョンの知見統合
  - [ ] Tkinter版の物理計算ロジックをPygame版に移植
  - [ ] テストケースの共通化（抽象テストクラス）
  - [ ] 共通GameStateインターフェースの設計
- [ ] Pygame版MVCパターン完成
  - [ ] PygameGameState（Model）の完全実装
  - [ ] PygameGameView（View）の描画システム
  - [ ] PygameGameController（Controller）のイベント処理
- [ ] 基本AI機能の実装（段階1）
  - [ ] シンプルなAIクライアント（Ollama未使用）
  - [ ] ローカル難易度調整システム（ADAプロトタイプ）

### フェーズ4: 新機能実装・要件書対応（見積もり: 8h）
- [ ] AI Dynamic Adjustment（ADA）実装
  - [ ] ミス率測定システム
  - [ ] 速度・角度調整アルゴリズム
  - [ ] リアルタイム難易度変更
- [ ] Procedural Content Generation（PCG）実装
  - [ ] シード値ベースステージ生成
  - [ ] 障害物・壁配置アルゴリズム
  - [ ] 週替わりチャレンジ用シード管理
- [ ] アクセシビリティ対応
  - [ ] 色覚対応（3モード）
  - [ ] 高コントラストモード
  - [ ] キーボード操作対応
- [ ] サウンドシステム
  - [ ] BGM/SE実装（Pygame Mixer）
  - [ ] 8-bitスタイルサウンド

### フェーズ5: WASM化・PWA・デプロイ（見積もり: 6h）
- [ ] WASM化
  - [ ] pyodide buildによるWASMコンパイル
  - [ ] ブラウザ最適化
  - [ ] パフォーマンス調整（60fps確保）
- [ ] PWA化
  - [ ] Service Worker実装
  - [ ] manifest.json作成
  - [ ] オフライン対応
- [ ] Vercel統合
  - [ ] API Functions実装（Python）
  - [ ] オンラインランキングシステム
  - [ ] Edge KV統合
- [ ] 最終品質確認
  - [ ] クロスブラウザテスト
  - [ ] アクセシビリティ監査（WCAG 2.2 AA）
  - [ ] パフォーマンステスト（Core Web Vitals）

## 進捗メモ

### 2025-01-13 14:00
- プロジェクト構成ファイル不在を確認
- Gemini CLIと連携してプロジェクト計画を策定
- 個人開発規約に準拠した実装方針を決定
- TODO.md作成完了

### 2025-01-13 15:30
- フェーズ1完了: プロジェクト基盤整備
- ディレクトリ構造リファクタリング完了（MVC分離）
- pytest環境構築（3つの基本テスト成功）
- ゲーム起動確認（新構造で正常動作）
- 技術スタック調整（Python 3.6環境対応）

### 2025-01-13 17:45
- フェーズ1.5完了: engine.pyリファクタリング（MVCパターン移行）
- 特性化テスト: 11テスト成功（元の動作を記録）
- GameStateクラス: 18テスト成功（純粋なModel層）
- GameViewクラス: Observerパターン実装（UI描画分離）
- GameControllerクラス: 5テスト成功（イベント処理・協調管理）
- リファクタリング検証: 既存29テスト全成功（デグレードなし）
- MVCパターン完成: Model-View-Controller分離達成

### 2025-01-14 00:44
- **重要発見**: docs/内に要件定義書v1.1・開発実装計画書v1.1を発見
- **技術移行決定**: TkinterからPygame-CE + Pyodide/WASMへの完全移行が必要
- **戦略変更**: 段階的ハイブリッド移行戦略を採用
  - Phase 2A: 現行Tkinter版完成（既存MVC活用）
  - Phase 2B: Pygame-CE移行準備（並行開発）
  - Phase 3-5: 新機能統合（ADA、PCG、PWA等）
- **規模調整**: 90人日規模要件を個人開発に適合調整
- **Geminiクォータ枯渇**: Claude単独で戦略決定・TODO.md更新完了

### 2025-01-14 01:20
- **Phase 2A開始**: 物理演算精密化テストの作成・実装完了
- **新テストクラス作成**: TestPhysicsCalculationPrecision（5テスト）、TestCollisionBoundaryValues（2テスト）
- **ADA機能基盤実装**: get_ball_speed()・get_ball_angle()メソッド追加
- **衝突判定改善**: ラケット衝突条件を`future_y >= self.RACKET_Y`に修正
- **テスト品質**: 全25テスト成功、物理法則準拠の精密テスト実装
- **TDD実践**: テストファースト→実装→リファクタリング→テスト成功のサイクル完了
- **個人開発規約遵守**: モック禁止・エラー3要素・TDD必須の原則維持

## 課題・リスク

### 技術移行リスク
- [ ] **Tkinter → Pygame-CE移行の技術習得**
  - 影響度：高
  - 対応策：段階的移行、既存MVCパターン設計活用
- [ ] **Pyodide/WASM環境の学習コスト**
  - 影響度：高
  - 対応策：Phase 2Bで小さな実験から開始
- [ ] **Python 3.6 → 3.12環境移行**
  - 影響度：中
  - 対応策：pyenvでの環境分離、互換性確認

### 機能・品質リスク
- [ ] **90人日規模要件の個人開発適合**
  - 影響度：高
  - 対応策：機能優先度付け、段階的実装
- [ ] **WASM環境での60fps性能確保**
  - 影響度：中
  - 対応策：早期プロトタイプでの性能検証
- [ ] **アクセシビリティ要件（WCAG 2.2 AA）の実装**
  - 影響度：中
  - 対応策：専門ツールでの段階的検証

### 開発プロセスリスク
- [ ] **並行開発（Tkinter版 + Pygame版）の複雑性**
  - 影響度：中
  - 対応策：共通インターフェース設計、テスト共通化
- [ ] **新技術スタック下でのTDD実践**
  - 影響度：中
  - 対応策：既存テスト設計パターンの移植活用

## 学んだこと・改善点

- **要件書の重要性**: プロジェクト進行中の要件書発見により大幅な戦略転換が必要
- **段階的移行の有効性**: 急激な技術変更より、既存成果物を活かした段階的アプローチが最適
- **MVCパターンの再利用価値**: 異なる技術スタック間でも設計思想は移植可能
- **個人開発規約の厳格な遵守**: プロジェクト品質向上の基盤
- **TDD実践によるコード信頼性**: 技術移行時の品質確保に必須
- **AI連携フォールバック戦略**: Gemini枯渇時のClaude単独判断体制の重要性

## 完了条件

### Phase 2A完了条件（現行版）
- [ ] すべてのTkinter版実装チェックリストが完了
- [ ] テストカバレッジ90%以上達成
- [ ] ゲーム動作の品質確認完了

### Phase 2B完了条件（移行準備）
- [ ] Pygame-CE環境構築完了
- [ ] 基本MVCパターン移植成功
- [ ] WASM環境での動作確認完了

### 最終完了条件（Phase 5）
- [ ] ブラウザ版60fps動作確認
- [ ] アクセシビリティ監査（WCAG 2.2 AA）合格
- [ ] 新機能（ADA、PCG）の動作検証完了
- [ ] 個人開発規約遵守の最終確認