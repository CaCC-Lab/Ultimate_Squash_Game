<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Ultimate Squash Game - Python/Pyodide WebAssemblyç‰ˆã€‚ãƒ–ãƒ©ã‚¦ã‚¶ã§å‹•ä½œã™ã‚‹è»½é‡(25KB)ã‚²ãƒ¼ãƒ ">
    <meta name="keywords" content="squash,game,python,pyodide,webassembly,pygame">
    <meta name="author" content="Ultimate Squash Game Team">
    
    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:title" content="Ultimate Squash Game - WebAssemblyç‰ˆ">
    <meta property="og:description" content="ãƒ–ãƒ©ã‚¦ã‚¶ã§å‹•ä½œã™ã‚‹è»½é‡(25KB)ã‚¹ã‚«ãƒƒã‚·ãƒ¥ã‚²ãƒ¼ãƒ ">
    <meta property="og:url" content="https://your-domain.com/ultimate-squash">
    
    <!-- Twitter -->
    <meta name="twitter:card" content="summary">
    <meta name="twitter:title" content="Ultimate Squash Game">
    <meta name="twitter:description" content="ãƒ–ãƒ©ã‚¦ã‚¶ã§å‹•ä½œã™ã‚‹è»½é‡ã‚¹ã‚«ãƒƒã‚·ãƒ¥ã‚²ãƒ¼ãƒ ">
    
    <title>Ultimate Squash Game - WebAssemblyç‰ˆ</title>
    
    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzIiIGhlaWdodD0iMzIiIHZpZXdCb3g9IjAgMCAzMiAzMiIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjMyIiBoZWlnaHQ9IjMyIiBmaWxsPSIjMDA0Mjc0Ii8+CjxjaXJjbGUgY3g9IjE2IiBjeT0iMTYiIHI9IjQiIGZpbGw9IiNmZmZmZmYiLz4KPHJlY3QgeD0iMTQiIHk9IjI0IiB3aWR0aD0iNCIgaGVpZ2h0PSI2IiBmaWxsPSIjMDBmZjAwIi8+Cjwvc3ZnPgo=">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0c0c0c 0%, #1a1a2e 50%, #16213e 100%);
            color: #ffffff;
            overflow: hidden;
            height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        
        .game-container {
            max-width: 800px;
            width: 100%;
            text-align: center;
            position: relative;
        }
        
        .header {
            margin-bottom: 20px;
            opacity: 0;
            animation: fadeInUp 1s ease-out 0.5s forwards;
        }
        
        .title {
            font-size: 2.5rem;
            font-weight: bold;
            background: linear-gradient(45deg, #ff6b6b, #4ecdc4, #45b7d1);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 10px;
            text-shadow: 0 0 30px rgba(255, 255, 255, 0.3);
        }
        
        .subtitle {
            font-size: 1rem;
            color: #b0b0b0;
            font-weight: 300;
        }
        
        .canvas-wrapper {
            position: relative;
            display: inline-block;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            opacity: 0;
            animation: scaleIn 1s ease-out 1s forwards;
        }
        
        #gameCanvas {
            background: #000;
            display: block;
            border: 3px solid #333;
            border-radius: 12px;
        }
        
        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border-radius: 12px;
            transition: opacity 0.5s ease-out;
        }
        
        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 3px solid #333;
            border-top: 3px solid #4ecdc4;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }
        
        .loading-text {
            font-size: 1.2rem;
            color: #4ecdc4;
            margin-bottom: 10px;
        }
        
        .loading-progress {
            font-size: 0.9rem;
            color: #888;
        }
        
        .controls {
            margin-top: 20px;
            opacity: 0;
            animation: fadeInUp 1s ease-out 1.5s forwards;
        }
        
        .control-info {
            display: flex;
            justify-content: center;
            gap: 30px;
            font-size: 0.9rem;
            color: #999;
        }
        
        .control-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .key {
            background: #333;
            padding: 4px 8px;
            border-radius: 4px;
            font-family: monospace;
            border: 1px solid #555;
        }
        
        .performance-info {
            position: absolute;
            top: 10px;
            left: 10px;
            font-size: 0.8rem;
            color: #666;
            background: rgba(0, 0, 0, 0.7);
            padding: 8px 12px;
            border-radius: 6px;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .game-container:hover .performance-info {
            opacity: 1;
        }
        
        .error-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        
        .error-content {
            background: #1a1a2e;
            padding: 30px;
            border-radius: 12px;
            border: 2px solid #ff6b6b;
            max-width: 500px;
            text-align: center;
        }
        
        .error-title {
            color: #ff6b6b;
            font-size: 1.5rem;
            margin-bottom: 15px;
        }
        
        .error-message {
            color: #ccc;
            margin-bottom: 20px;
            line-height: 1.5;
        }
        
        .error-button {
            background: #ff6b6b;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1rem;
            transition: background 0.3s ease;
        }
        
        .error-button:hover {
            background: #ff5252;
        }
        
        /* ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚¹ã‚¿ã‚¤ãƒ« */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        
        .modal-content {
            background: #1a1a2e;
            padding: 30px;
            border-radius: 12px;
            border: 2px solid #4ecdc4;
            max-width: 500px;
            text-align: center;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .modal-title {
            color: #4ecdc4;
            font-size: 1.5rem;
            margin-bottom: 20px;
        }
        
        .modal-input {
            width: 80%;
            padding: 10px;
            margin: 10px 0;
            border: 1px solid #4ecdc4;
            border-radius: 5px;
            background: #333;
            color: white;
            font-size: 1rem;
        }
        
        .modal-button {
            background: #4ecdc4;
            color: #1a1a2e;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1rem;
            margin: 5px;
            transition: background 0.3s ease;
        }
        
        .modal-button:hover {
            background: #45b7d1;
        }
        
        .ranking-list {
            text-align: left;
            margin: 20px 0;
        }
        
        .ranking-item {
            padding: 10px;
            margin: 5px 0;
            border-radius: 5px;
            background: rgba(255, 255, 255, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .ranking-item.highlight {
            background: rgba(78, 205, 196, 0.3);
            border: 1px solid #4ecdc4;
        }
        
        .ranking-rank {
            font-weight: bold;
            color: #4ecdc4;
            min-width: 30px;
        }
        
        .ranking-details {
            flex: 1;
            margin: 0 10px;
        }
        
        .ranking-name {
            font-weight: bold;
            margin-bottom: 2px;
        }
        
        .ranking-meta {
            font-size: 0.8rem;
            color: #999;
        }
        
        .ranking-score {
            font-weight: bold;
            color: #ff6b6b;
        }
        
        /* ãƒ‘ãƒ¯ãƒ¼ã‚¢ãƒƒãƒ—è¡¨ç¤º */
        .powerup-display {
            position: absolute;
            top: 50px;
            left: 10px;
            background: rgba(0, 0, 0, 0.8);
            padding: 10px;
            border-radius: 8px;
            color: white;
            font-size: 0.9rem;
            min-width: 200px;
        }
        
        .powerup-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 5px 0;
            padding: 5px;
            border-radius: 4px;
        }
        
        .powerup-active {
            background: rgba(0, 255, 0, 0.2);
            border: 1px solid #00ff00;
        }
        
        .powerup-inactive {
            background: rgba(128, 128, 128, 0.2);
            border: 1px solid #666;
        }
        
        .powerup-timer {
            font-size: 0.8rem;
            color: #ffff00;
        }
        
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        @keyframes scaleIn {
            from {
                opacity: 0;
                transform: scale(0.9);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        @media (max-width: 768px) {
            .title {
                font-size: 2rem;
            }
            
            .control-info {
                flex-direction: column;
                gap: 10px;
            }
            
            #gameCanvas {
                width: 90vw;
                height: auto;
            }
        }
        
        /* ãƒ€ãƒ¼ã‚¯ãƒ†ãƒ¼ãƒã‚µãƒãƒ¼ãƒˆ */
        @media (prefers-color-scheme: dark) {
            body {
                background: linear-gradient(135deg, #000000 0%, #1a1a2e 50%, #16213e 100%);
            }
        }
    </style>
</head>
<body>
    <div class="game-container">
        <header class="header">
            <h1 class="title">Ultimate Squash Game</h1>
            <p class="subtitle">Python/Pyodide WebAssemblyç‰ˆ - è»½é‡25KB</p>
        </header>
        
        <div class="canvas-wrapper">
            <canvas id="gameCanvas" width="640" height="480"></canvas>
            <div class="loading-overlay" id="loadingOverlay">
                <div class="loading-spinner"></div>
                <div class="loading-text">ã‚²ãƒ¼ãƒ èª­ã¿è¾¼ã¿ä¸­...</div>
                <div class="loading-progress" id="loadingProgress">Pyodideã‚’åˆæœŸåŒ–ä¸­...</div>
            </div>
            <div class="performance-info" id="performanceInfo">
                FPS: <span id="fpsCounter">60</span> | 
                Memory: <span id="memoryUsage">1.2MB</span>
            </div>
            <div class="powerup-display" id="powerupDisplay" style="display: none;">
                <h4>ãƒ‘ãƒ¯ãƒ¼ã‚¢ãƒƒãƒ—çŠ¶æ³</h4>
                <div id="powerupList"></div>
            </div>
        </div>
        
        <div class="controls">
            <div class="control-info">
                <div class="control-item">
                    <span class="key">â†</span><span class="key">â†’</span>
                    <span>ãƒ©ã‚±ãƒƒãƒˆç§»å‹•</span>
                </div>
                <div class="control-item">
                    <span class="key">Space</span>
                    <span>ãƒãƒ¼ã‚º/å†é–‹</span>
                </div>
                <div class="control-item">
                    <span class="key">R</span>
                    <span>ãƒªã‚¹ã‚¿ãƒ¼ãƒˆ</span>
                </div>
                <div class="control-item">
                    <span class="key">H</span>
                    <span>ãƒ©ãƒ³ã‚­ãƒ³ã‚°è¡¨ç¤º</span>
                </div>
                <div class="control-item">
                    <span class="key">P</span>
                    <span>ãƒ‘ãƒ¯ãƒ¼ã‚¢ãƒƒãƒ—è¡¨ç¤º</span>
                </div>
            </div>
        </div>
    </div>
    
    <!-- ã‚¨ãƒ©ãƒ¼ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div class="error-modal" id="errorModal">
        <div class="error-content">
            <h2 class="error-title">ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ</h2>
            <p class="error-message" id="errorMessage">
                ã‚²ãƒ¼ãƒ ã®èª­ã¿è¾¼ã¿ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚
            </p>
            <button class="error-button" onclick="closeErrorModal()">å†è©¦è¡Œ</button>
        </div>
    </div>
    
    <!-- åå‰å…¥åŠ›ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div class="modal" id="nameInputModal">
        <div class="modal-content">
            <h2 class="modal-title">æ–°è¨˜éŒ²é”æˆï¼</h2>
            <p>ãŠã‚ã§ã¨ã†ã”ã–ã„ã¾ã™ï¼ãƒã‚¤ã‚¹ã‚³ã‚¢ã«ãƒ©ãƒ³ã‚¯ã‚¤ãƒ³ã—ã¾ã—ãŸã€‚</p>
            <p>ã‚¹ã‚³ã‚¢: <span id="newScoreValue">0</span></p>
            <input type="text" id="playerNameInput" class="modal-input" placeholder="ã‚ãªãŸã®åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„" maxlength="20" value="Player" onkeydown="if(event.key==='Enter') confirmScoreEntry()">
            <br>
            <button class="modal-button" onclick="confirmScoreEntry()">è¨˜éŒ²ã™ã‚‹</button>
            <button class="modal-button" onclick="cancelScoreEntry()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        </div>
    </div>
    
    <!-- ãƒ©ãƒ³ã‚­ãƒ³ã‚°è¡¨ç¤ºãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div class="modal" id="rankingModal">
        <div class="modal-content">
            <h2 class="modal-title">ğŸ† ãƒã‚¤ã‚¹ã‚³ã‚¢ ãƒ©ãƒ³ã‚­ãƒ³ã‚°</h2>
            <div id="rankingList" class="ranking-list">
                <!-- ãƒ©ãƒ³ã‚­ãƒ³ã‚°ãƒ‡ãƒ¼ã‚¿ãŒã“ã“ã«å‹•çš„ã«è¿½åŠ ã•ã‚Œã¾ã™ -->
            </div>
            <button class="modal-button" onclick="closeRankingModal()">é–‰ã˜ã‚‹</button>
            <button class="modal-button" onclick="clearRanking()">ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚¯ãƒªã‚¢</button>
        </div>
    </div>
    
    <!-- Pyodideèª­ã¿è¾¼ã¿ -->
    <script src="https://cdn.jsdelivr.net/pyodide/v0.26.4/full/pyodide.js"></script>
    
    <script>
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        let pyodide = null;
        let gameLoopId = null;  // gameLoop â†’ gameLoopIdã«å¤‰æ›´ã—ã¦redeclarationã‚¨ãƒ©ãƒ¼ã‚’å›é¿
        let gameState = null;
        let canvas = null;
        let ctx = null;
        let performanceMonitor = null;
        
        // æ–°æ©Ÿèƒ½ç”¨ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        let scoreRanking = null;
        let pendingScoreData = null;
        
        // ã‚¹ã‚³ã‚¢ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚·ã‚¹ãƒ†ãƒ 
        class ScoreRanking {
            constructor() {
                this.storageKey = 'ultimateSquashHighScores';
                this.maxScores = 10;
            }
            
            getHighScores() {
                const stored = localStorage.getItem(this.storageKey);
                return stored ? JSON.parse(stored) : [];
            }
            
            addScore(score, playerName = 'Player', combo = 0, powerUps = 0) {
                const scores = this.getHighScores();
                const newScore = {
                    score: score,
                    name: playerName,
                    date: new Date().toISOString(),
                    combo: combo,
                    powerUps: powerUps
                };
                
                scores.push(newScore);
                scores.sort((a, b) => b.score - a.score);
                scores.splice(this.maxScores);
                
                localStorage.setItem(this.storageKey, JSON.stringify(scores));
                return scores.findIndex(s => s === newScore) + 1;
            }
            
            isHighScore(score) {
                const scores = this.getHighScores();
                return (
                    scores.length < this.maxScores ||
                    score > (scores[scores.length - 1]?.score || 0)
                );
            }
            
            clearScores() {
                localStorage.removeItem(this.storageKey);
            }
        }

        // ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ç›£è¦–
        class PerformanceMonitor {
            constructor() {
                this.frameCount = 0;
                this.lastTime = performance.now();
                this.fps = 60;
                this.memoryUsage = 0;
            }
            
            update() {
                this.frameCount++;
                const currentTime = performance.now();
                
                if (currentTime - this.lastTime >= 1000) {
                    this.fps = Math.round(this.frameCount * 1000 / (currentTime - this.lastTime));
                    this.frameCount = 0;
                    this.lastTime = currentTime;
                    
                    // ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡ã‚’æ›´æ–°
                    if (performance.memory) {
                        this.memoryUsage = (performance.memory.usedJSHeapSize / 1024 / 1024).toFixed(1);
                    }
                    
                    this.updateDisplay();
                }
            }
            
            updateDisplay() {
                document.getElementById('fpsCounter').textContent = this.fps;
                document.getElementById('memoryUsage').textContent = this.memoryUsage + 'MB';
            }
        }
        
        // HTMLã‚¨ã‚¹ã‚±ãƒ¼ãƒ—é–¢æ•°ï¼ˆXSSå¯¾ç­–ï¼‰
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
        function showError(message, details = '') {
            console.error('Game Error:', message, details);
            document.getElementById('errorMessage').textContent = message;
            document.getElementById('errorModal').style.display = 'flex';
        }
        
        function closeErrorModal() {
            document.getElementById('errorModal').style.display = 'none';
            // å†è©¦è¡Œ
            initializeGame();
        }
        
        // ã‚¹ã‚³ã‚¢é–¢é€£ãƒ¢ãƒ¼ãƒ€ãƒ«æ©Ÿèƒ½
        function showNameInputModal(scoreData) {
            pendingScoreData = scoreData;
            document.getElementById('newScoreValue').textContent = scoreData.score;
            document.getElementById('playerNameInput').value = 'Player';
            document.getElementById('nameInputModal').style.display = 'flex';
            setTimeout(() => {
                document.getElementById('playerNameInput').focus();
                document.getElementById('playerNameInput').select();
            }, 100);
        }
        
        function confirmScoreEntry() {
            const playerName = document.getElementById('playerNameInput').value.trim() || 'Player';
            if (pendingScoreData && scoreRanking) {
                scoreRanking.addScore(
                    pendingScoreData.score,
                    playerName,
                    pendingScoreData.combo || 0,
                    pendingScoreData.powerUps || 0
                );
            }
            document.getElementById('nameInputModal').style.display = 'none';
            pendingScoreData = null;
            showRankingModal();
        }
        
        function cancelScoreEntry() {
            document.getElementById('nameInputModal').style.display = 'none';
            pendingScoreData = null;
            // Pythonå´ã®ãƒã‚¤ã‚¹ã‚³ã‚¢ãƒã‚§ãƒƒã‚¯ã‚‚ç¢ºå®Ÿã«ã‚¯ãƒªã‚¢
            if (pyodide) {
                pyodide.runPython('pending_high_score_check = None');
            }
        }
        
        function showRankingModal() {
            if (!scoreRanking) return;
            
            const scores = scoreRanking.getHighScores();
            const rankingList = document.getElementById('rankingList');
            
            if (scores.length === 0) {
                rankingList.innerHTML = '<p style="text-align: center; color: #999;">ã¾ã ã‚¹ã‚³ã‚¢ãŒè¨˜éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“</p>';
            } else {
                rankingList.innerHTML = scores.map((score, index) => {
                    const date = new Date(score.date);
                    const dateStr = date.toLocaleDateString('ja-JP', {
                        month: 'short',
                        day: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                    
                    return `
                        <div class="ranking-item">
                            <div class="ranking-rank">${index + 1}ä½</div>
                            <div class="ranking-details">
                                <div class="ranking-name">${escapeHtml(score.name)}</div>
                                <div class="ranking-meta">${dateStr} | ã‚³ãƒ³ãƒœ:${score.combo || 0} | ãƒ‘ãƒ¯ãƒ¼ã‚¢ãƒƒãƒ—:${score.powerUps || 0}</div>
                            </div>
                            <div class="ranking-score">${score.score.toLocaleString()}</div>
                        </div>
                    `;
                }).join('');
            }
            
            document.getElementById('rankingModal').style.display = 'flex';
        }
        
        function closeRankingModal() {
            document.getElementById('rankingModal').style.display = 'none';
        }
        
        function clearRanking() {
            if (confirm('æœ¬å½“ã«ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã™ã‹ï¼Ÿ')) {
                if (scoreRanking) {
                    scoreRanking.clearScores();
                }
                showRankingModal(); // ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥
            }
        }
        
        // ãƒ‘ãƒ¯ãƒ¼ã‚¢ãƒƒãƒ—è¡¨ç¤ºæ©Ÿèƒ½
        function togglePowerupDisplay() {
            const display = document.getElementById('powerupDisplay');
            if (display.style.display === 'none') {
                display.style.display = 'block';
                updatePowerupDisplay();
            } else {
                display.style.display = 'none';
            }
        }
        
        function updatePowerupDisplay() {
            if (!pyodide) return;
            
            try {
                const powerupData = pyodide.runPython(`
import json
powerup_info = {
    'multi_ball': {
        'active': getattr(game_state, 'multi_ball_active', False),
        'threshold': getattr(game_state, 'multi_ball_threshold', 5),
        'hits': getattr(game_state, 'consecutive_hits', 0)
    },
    'powerups': getattr(game_state, 'active_powerups', {})
}
json.dumps(powerup_info)
                `);
                
                const data = JSON.parse(powerupData);
                const powerupList = document.getElementById('powerupList');
                
                let html = `
                    <div class="powerup-item ${data.multi_ball.active ? 'powerup-active' : 'powerup-inactive'}">
                        <span>ãƒãƒ«ãƒãƒœãƒ¼ãƒ«</span>
                        <span>${data.multi_ball.hits}/${data.multi_ball.threshold}</span>
                    </div>
                `;
                
                const powerupTypes = {
                    'wide_racket': 'ãƒ¯ã‚¤ãƒ‰ãƒ©ã‚±ãƒƒãƒˆ',
                    'slow_ball': 'ã‚¹ãƒ­ãƒ¼ãƒœãƒ¼ãƒ«',
                    'extra_points': 'ã‚¨ã‚¯ã‚¹ãƒˆãƒ©ãƒã‚¤ãƒ³ãƒˆ',
                    'shield': 'ã‚·ãƒ¼ãƒ«ãƒ‰'
                };
                
                for (const [type, name] of Object.entries(powerupTypes)) {
                    const isActive = data.powerups[type] && data.powerups[type].active;
                    const remaining = isActive ? Math.ceil(data.powerups[type].remaining / 1000) : 0;
                    
                    html += `
                        <div class="powerup-item ${isActive ? 'powerup-active' : 'powerup-inactive'}">
                            <span>${name}</span>
                            <span class="powerup-timer">${isActive ? remaining + 's' : 'OFF'}</span>
                        </div>
                    `;
                }
                
                powerupList.innerHTML = html;
            } catch (error) {
                console.error('PowerUp display error:', error);
            }
        }
        
        // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°çŠ¶æ…‹ã®æ›´æ–°
        function updateLoadingProgress(text) {
            document.getElementById('loadingProgress').textContent = text;
        }
        
        function hideLoadingScreen() {
            const overlay = document.getElementById('loadingOverlay');
            overlay.style.opacity = '0';
            setTimeout(() => {
                overlay.style.display = 'none';
            }, 500);
        }
        
        // PyodideåˆæœŸåŒ–ã¨ã‚²ãƒ¼ãƒ é–‹å§‹
        async function initializeGame() {
            try {
                updateLoadingProgress('Pyodideã‚’åˆæœŸåŒ–ä¸­...');
                
                // PyodideåˆæœŸåŒ–
                pyodide = await loadPyodide({
                    indexURL: "https://cdn.jsdelivr.net/pyodide/v0.26.4/full/"
                });
                
                updateLoadingProgress('Pygame-CEã‚’èª­ã¿è¾¼ã¿ä¸­...');
                
                // å¿…è¦ãªãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
                await pyodide.loadPackage(["pygame-ce"]);
                
                updateLoadingProgress('ã‚²ãƒ¼ãƒ ã‚³ãƒ¼ãƒ‰ã‚’èª­ã¿è¾¼ã¿ä¸­...');
                
                // ã‚²ãƒ¼ãƒ ã‚³ãƒ¼ãƒ‰ã‚’èª­ã¿è¾¼ã¿ï¼ˆæœ€é©åŒ–ã•ã‚ŒãŸãƒãƒ¼ã‚¸ãƒ§ãƒ³ï¼‰
                await loadGameCode();
                
                updateLoadingProgress('ã‚²ãƒ¼ãƒ ã‚’åˆæœŸåŒ–ä¸­...');
                
                // Canvasã‚’åˆæœŸåŒ–
                canvas = document.getElementById('gameCanvas');
                ctx = canvas.getContext('2d');
                
                // ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ç›£è¦–ã‚’é–‹å§‹
                performanceMonitor = new PerformanceMonitor();
                
                // ã‚¹ã‚³ã‚¢ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚·ã‚¹ãƒ†ãƒ ã‚’åˆæœŸåŒ–
                scoreRanking = new ScoreRanking();
                
                // ã‚¿ãƒƒãƒã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®š
                setupTouchEvents();
                
                // ã‚²ãƒ¼ãƒ çŠ¶æ…‹ã‚’åˆæœŸåŒ–
                await initializeGameState();
                
                updateLoadingProgress('ã‚²ãƒ¼ãƒ é–‹å§‹æº–å‚™å®Œäº†');
                
                // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ç”»é¢ã‚’éè¡¨ç¤º
                hideLoadingScreen();
                
                // ãƒ¢ãƒã‚¤ãƒ«ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ã‚’è¿½åŠ 
                addMobileControls();
                
                // ã‚²ãƒ¼ãƒ ãƒ«ãƒ¼ãƒ—é–‹å§‹
                startGameLoop();
                
                console.log('ğŸ® Ultimate Squash Game loaded successfully!');
                
            } catch (error) {
                showError(
                    'ã‚²ãƒ¼ãƒ ã®åˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒ–ãƒ©ã‚¦ã‚¶ãŒæœ€æ–°ç‰ˆã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚',
                    error.message
                );
            }
        }
        
        // ã‚²ãƒ¼ãƒ ã‚³ãƒ¼ãƒ‰ã®èª­ã¿è¾¼ã¿
        async function loadGameCode() {
            // æœ€é©åŒ–ã•ã‚ŒãŸPythonã‚³ãƒ¼ãƒ‰ã‚’åŸ‹ã‚è¾¼ã¿
            const gameModules = {
                'model.pygame_game_state': `import time
from typing import List, Dict, Optional, Callable
from dataclasses import dataclass
import math

class PygameBall:
    def __init__(self, x: float = 320, y: float = 240, dx: float = 200, dy: float = 200, 
                 radius: float = 10, color: tuple = (255, 255, 255)):
        self.x = float(x)
        self.y = float(y)
        self.dx = float(dx)
        self.dy = float(dy)
        self.radius = float(radius)
        self.color = color
        self.trail = []
        self.max_trail_length = 10

class PygameRacket:
    def __init__(self, x: float = 295, y: float = 450, size: float = 50, 
                 height: float = 10, color: tuple = (0, 255, 0)):
        self.x = float(x)
        self.y = float(y)
        self.size = float(size)
        self.height = float(height)
        self.color = color
        self.speed = 300
        self.left_bound = 0
        self.right_bound = 640

class PygameScore:
    def __init__(self):
        self.player_score = 0
        self.level = 1
        self.hits = 0
        self.misses = 0
        self.start_time = time.time()

class PygameGameStateObserver:
    def on_game_state_changed(self, game_state: 'PygameGameState'):
        pass

class PygameGameState:
    def __init__(self):
        self.balls = [PygameBall()]
        self.racket = PygameRacket()
        self.score = PygameScore()
        self.is_paused = False
        self.is_gameover = False
        self.observers = []
        self.canvas_width = 640
        self.canvas_height = 480
        
        # ãƒãƒ«ãƒãƒœãƒ¼ãƒ«æ©Ÿèƒ½
        self.multi_ball_active = False
        self.multi_ball_threshold = 5  # 5é€£ç¶šãƒ’ãƒƒãƒˆã§ãƒãƒ«ãƒãƒœãƒ¼ãƒ«ç™ºå‹•
        self.consecutive_hits = 0
        self.max_balls = 3
        
        # ãƒ‘ãƒ¯ãƒ¼ã‚¢ãƒƒãƒ—ã‚·ã‚¹ãƒ†ãƒ 
        self.active_powerups = {}
        self.powerup_spawn_chance = 0.1  # 10%ã®ç¢ºç‡
        self.powerup_positions = []  # ãƒ‘ãƒ¯ãƒ¼ã‚¢ãƒƒãƒ—ã‚¢ã‚¤ãƒ†ãƒ ã®åº§æ¨™
    
    def add_observer(self, observer: PygameGameStateObserver):
        self.observers.append(observer)
    
    def notify_observers(self):
        for observer in self.observers:
            observer.on_game_state_changed(self)
    
    def activate_multi_ball(self):
        """ãƒãƒ«ãƒãƒœãƒ¼ãƒ«ãƒ¢ãƒ¼ãƒ‰ã‚’ç™ºå‹•"""
        self.multi_ball_active = True
        # æ–°ã—ã„ãƒœãƒ¼ãƒ«ã‚’2ã¤è¿½åŠ 
        for i in range(min(2, self.max_balls - len(self.balls))):
            new_ball = PygameBall(
                x=320 + (i - 0.5) * 100,  # å·¦å³ã«é…ç½®
                y=240,
                dx=150 * (1 if i == 0 else -1),  # ç•°ãªã‚‹æ–¹å‘
                dy=250,
                color=(255, 200, 0) if i == 0 else (0, 200, 255)  # ç•°ãªã‚‹è‰²
            )
            self.balls.append(new_ball)
    
    def activate_powerup(self, powerup_type):
        """ãƒ‘ãƒ¯ãƒ¼ã‚¢ãƒƒãƒ—ã‚’ç™ºå‹•"""
        import time
        
        if powerup_type == 'wide_racket':
            self.active_powerups['wide_racket'] = {
                'active': True,
                'start_time': time.time() * 1000,
                'duration': 10000,  # 10ç§’
                'remaining': 10000
            }
            self.racket.size = 100  # ãƒ©ã‚±ãƒƒãƒˆã‚µã‚¤ã‚º2å€
            
        elif powerup_type == 'slow_ball':
            if 'slow_ball' not in self.active_powerups:  # é‡è¤‡é˜²æ­¢
                self.active_powerups['slow_ball'] = {
                    'active': True,
                    'start_time': time.time() * 1000,
                    'duration': 8000,  # 8ç§’
                    'remaining': 8000
                }
                # ãƒœãƒ¼ãƒ«é€Ÿåº¦ã‚’30%ã«æ¸›é€Ÿ
                for ball in self.balls:
                    ball.dx *= 0.3
                    ball.dy *= 0.3
                
        elif powerup_type == 'extra_points':
            self.active_powerups['extra_points'] = {
                'active': True,
                'start_time': time.time() * 1000,
                'duration': 15000,  # 15ç§’
                'remaining': 15000
            }
            
        elif powerup_type == 'shield':
            self.active_powerups['shield'] = {
                'active': True,
                'uses': 1  # 1å›ä½¿ç”¨å¯èƒ½
            }
    
    def update_powerups(self):
        """ãƒ‘ãƒ¯ãƒ¼ã‚¢ãƒƒãƒ—ã®æ™‚é–“ç®¡ç†"""
        import time
        current_time = time.time() * 1000
        
        for powerup_type, powerup in list(self.active_powerups.items()):
            if powerup.get('active', False):
                if 'duration' in powerup:
                    elapsed = current_time - powerup['start_time']
                    powerup['remaining'] = max(0, powerup['duration'] - elapsed)
                    
                    if elapsed >= powerup['duration']:
                        # ãƒ‘ãƒ¯ãƒ¼ã‚¢ãƒƒãƒ—çµ‚äº†
                        if powerup_type == 'wide_racket':
                            self.racket.size = 50  # å…ƒã®ã‚µã‚¤ã‚ºã«æˆ»ã™
                        elif powerup_type == 'slow_ball':
                            # ãƒœãƒ¼ãƒ«é€Ÿåº¦ã‚’å…ƒã«æˆ»ã™
                            for ball in self.balls:
                                ball.dx /= 0.3
                                ball.dy /= 0.3
                        
                        powerup['active'] = False

    def update_ball_position(self, ball: PygameBall, dt: float = 0.016):
        ball.x += ball.dx * dt
        ball.y += ball.dy * dt
        
        if ball.x <= ball.radius or ball.x >= self.canvas_width - ball.radius:
            ball.dx = -ball.dx
        if ball.y <= ball.radius:
            ball.dy = -ball.dy
        if ball.y >= self.canvas_height - ball.radius:
            # ã‚·ãƒ¼ãƒ«ãƒ‰ãƒ‘ãƒ¯ãƒ¼ã‚¢ãƒƒãƒ—ã®ãƒã‚§ãƒƒã‚¯
            if self.active_powerups.get('shield', {}).get('active', False):
                ball.dy = -abs(ball.dy)  # è·³ã­è¿”ã™
                self.active_powerups['shield']['active'] = False  # ã‚·ãƒ¼ãƒ«ãƒ‰æ¶ˆè²»
            else:
                self.is_gameover = True
        
        if (ball.y + ball.radius >= self.racket.y and 
            ball.x >= self.racket.x and ball.x <= self.racket.x + self.racket.size):
            ball.dy = -abs(ball.dy)
            self.score.hits += 1
            self.consecutive_hits += 1
            
            # ã‚¨ã‚¯ã‚¹ãƒˆãƒ©ãƒã‚¤ãƒ³ãƒˆåŠ¹æœ
            points = 10
            if self.active_powerups.get('extra_points', {}).get('active', False):
                points *= 2
            self.score.player_score += points
            
            # ãƒãƒ«ãƒãƒœãƒ¼ãƒ«åˆ¤å®š
            if (self.consecutive_hits >= self.multi_ball_threshold and 
                not self.multi_ball_active and len(self.balls) == 1):
                self.activate_multi_ball()
                
            # ãƒ‘ãƒ¯ãƒ¼ã‚¢ãƒƒãƒ—ã‚¹ãƒãƒ¼ãƒ³åˆ¤å®š
            import random
            if random.random() < self.powerup_spawn_chance:
                self.spawn_powerup()
        else:
            # ãƒ’ãƒƒãƒˆã—ãªã‹ã£ãŸå ´åˆã¯é€£ç¶šãƒ’ãƒƒãƒˆãƒªã‚»ãƒƒãƒˆ
            if ball.y >= self.canvas_height - ball.radius:
                self.consecutive_hits = 0
        
        # ãƒ‘ãƒ¯ãƒ¼ã‚¢ãƒƒãƒ—æ›´æ–°
        self.update_powerups()
        
        self.notify_observers()
    
    def spawn_powerup(self):
        """ãƒ‘ãƒ¯ãƒ¼ã‚¢ãƒƒãƒ—ã‚¢ã‚¤ãƒ†ãƒ ã‚’ã‚¹ãƒãƒ¼ãƒ³"""
        import random
        powerup_types = ['wide_racket', 'slow_ball', 'extra_points', 'shield']
        powerup_type = random.choice(powerup_types)
        
        powerup_item = {
            'type': powerup_type,
            'x': random.randint(50, self.canvas_width - 50),
            'y': random.randint(100, 300),
            'collected': False
        }
        self.powerup_positions.append(powerup_item)
    
    def check_powerup_collision(self):
        """ãƒ‘ãƒ¯ãƒ¼ã‚¢ãƒƒãƒ—ã‚¢ã‚¤ãƒ†ãƒ ã¨ãƒœãƒ¼ãƒ«ã®è¡çªåˆ¤å®š"""
        for ball in self.balls:
            for powerup in self.powerup_positions[:]:
                if not powerup['collected']:
                    dist = ((ball.x - powerup['x'])**2 + (ball.y - powerup['y'])**2)**0.5
                    if dist < 20:  # è¡çªåˆ¤å®š
                        powerup['collected'] = True
                        self.activate_powerup(powerup['type'])
                        self.powerup_positions.remove(powerup)
    
    def update_racket_position(self, x: float):
        self.racket.x = max(0, min(x, self.canvas_width - self.racket.size))
        self.notify_observers()`,
                
                'view.optimized_web_game_view': `import json
from typing import Dict, List
# ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚¤ãƒ³ãƒãƒ¼ãƒˆã‚’å‰Šé™¤ - ç›´æ¥ã‚¯ãƒ©ã‚¹å®šç¾©ã‚’ä½¿ç”¨

class PygameGameStateObserver:
    def on_game_state_changed(self, game_state):
        pass

class OptimizedWebCanvasView(PygameGameStateObserver):
    def __init__(self, canvas_id: str = "gameCanvas"):
        self.canvas_id = canvas_id
        self.canvas_width = 640
        self.canvas_height = 480
        self.frame_data = {}
        
    def on_game_state_changed(self, game_state: PygameGameState):
        self.frame_data = self._convert_to_canvas_data(game_state)
    
    def _convert_to_canvas_data(self, game_state: PygameGameState) -> Dict:
        draw_commands = []
        
        draw_commands.append({
            'type': 'fillRect',
            'x': 0, 'y': 0,
            'width': self.canvas_width,
            'height': self.canvas_height,
            'color': '#000000'
        })
        
        for ball in game_state.balls:
            draw_commands.append({
                'type': 'fillCircle',
                'x': ball.x, 'y': ball.y,
                'radius': ball.radius,
                'color': f'rgb{ball.color}'
            })
        
        if game_state.racket:
            draw_commands.append({
                'type': 'fillRect',
                'x': game_state.racket.x,
                'y': game_state.racket.y,
                'width': game_state.racket.size,
                'height': game_state.racket.height,
                'color': f'rgb{game_state.racket.color}'
            })
        
        # ãƒ‘ãƒ¯ãƒ¼ã‚¢ãƒƒãƒ—ã‚¢ã‚¤ãƒ†ãƒ ã®æç”»
        for powerup in game_state.powerup_positions:
            if not powerup['collected']:
                color_map = {
                    'wide_racket': '#00ff00',
                    'slow_ball': '#00ffff',
                    'extra_points': '#ffff00',
                    'shield': '#ff00ff'
                }
                draw_commands.append({
                    'type': 'fillCircle',
                    'x': powerup['x'], 'y': powerup['y'],
                    'radius': 15,
                    'color': color_map.get(powerup['type'], '#ffffff')
                })
                # ãƒ‘ãƒ¯ãƒ¼ã‚¢ãƒƒãƒ—ã‚¿ã‚¤ãƒ—ã®ãƒ†ã‚­ã‚¹ãƒˆ
                draw_commands.append({
                    'type': 'fillText',
                    'text': powerup['type'][0].upper(),
                    'x': powerup['x'] - 5, 'y': powerup['y'] + 5,
                    'color': 'black',
                    'font': '12px Arial'
                })
        
        # ã‚¹ã‚³ã‚¢è¡¨ç¤ºï¼ˆãƒãƒ«ãƒãƒœãƒ¼ãƒ«æƒ…å ±ã‚‚å«ã‚€ï¼‰
        score_text = f'Score: {game_state.score.player_score} | Level: {game_state.score.level}'
        if game_state.multi_ball_active:
            score_text += f' | Multi-Ball! Hits: {game_state.consecutive_hits}'
        elif game_state.consecutive_hits > 0:
            score_text += f' | Combo: {game_state.consecutive_hits}/{game_state.multi_ball_threshold}'
            
        draw_commands.append({
            'type': 'fillText',
            'text': score_text,
            'x': 10, 'y': 30,
            'color': 'white',
            'font': '20px Arial'
        })
        
        return {
            'canvas_id': self.canvas_id,
            'draw_commands': draw_commands,
            'game_state': {
                'paused': game_state.is_paused,
                'gameover': game_state.is_gameover
            }
        }
    
    def get_javascript_interface_data(self) -> str:
        return json.dumps(self.frame_data, ensure_ascii=False)`
            };
            
            for (const [moduleName, moduleCode] of Object.entries(gameModules)) {
                pyodide.runPython(moduleCode);
            }
        }
        
        // ã‚²ãƒ¼ãƒ çŠ¶æ…‹ã®åˆæœŸåŒ–
        async function initializeGameState() {
            pyodide.runPython(`
# ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚¤ãƒ³ãƒãƒ¼ãƒˆã‚’å‰Šé™¤ã—ã¦ã€ç›´æ¥ã‚¯ãƒ©ã‚¹å®šç¾©ã‚’ä½¿ç”¨
game_state = PygameGameState()
game_view = OptimizedWebCanvasView()
game_state.add_observer(game_view)

def update_game(dt=0.016):
    if not game_state.is_paused and not game_state.is_gameover:
        for ball in game_state.balls[:]:  # ã‚³ãƒ”ãƒ¼ã‚’ä½œæˆï¼ˆå‰Šé™¤ã«å¯¾å¿œï¼‰
            game_state.update_ball_position(ball, dt)
        
        # ãƒ‘ãƒ¯ãƒ¼ã‚¢ãƒƒãƒ—ã‚¢ã‚¤ãƒ†ãƒ ã¨ã®è¡çªåˆ¤å®š
        game_state.check_powerup_collision()
        
        # ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼æ™‚ã«ã‚¹ã‚³ã‚¢è¨˜éŒ²
        if game_state.is_gameover:
            check_high_score()
            
    return game_view.get_javascript_interface_data()

def check_high_score():
    """ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼æ™‚ã®ãƒã‚¤ã‚¹ã‚³ã‚¢ãƒã‚§ãƒƒã‚¯"""
    # ãƒã‚¤ã‚¹ã‚³ã‚¢ã®å ´åˆã®ã¿pending_high_score_checkã‚’è¨­å®š
    import json
    global pending_high_score_check
    
    # ã‚¹ã‚³ã‚¢ãŒ0ä»¥ä¸‹ã®å ´åˆã¯ä½•ã‚‚ã—ãªã„
    if game_state.score.player_score <= 0:
        return
    
    # ä¸€åº¦ã ã‘ãƒã‚¤ã‚¹ã‚³ã‚¢ãƒã‚§ãƒƒã‚¯ã‚’å®Ÿè¡Œï¼ˆé‡è¤‡é˜²æ­¢ï¼‰
    if pending_high_score_check is None:
        pending_high_score_check = json.dumps({
            'score': game_state.score.player_score,
            'combo': game_state.consecutive_hits,
            'powerUps': len([p for p in game_state.active_powerups.values() if p.get("active", False)])
        })
    
def get_pending_high_score():
    """JavaScriptå´ã‹ã‚‰å‘¼ã³å‡ºã•ã‚Œã‚‹é–¢æ•°"""
    global pending_high_score_check
    return pending_high_score_check

pending_high_score_check = None

def handle_key_input(key):
    if key == 'ArrowLeft' and game_state.racket.x > 0:
        game_state.update_racket_position(game_state.racket.x - 20)
    elif key == 'ArrowRight' and game_state.racket.x < 590:
        game_state.update_racket_position(game_state.racket.x + 20)
    elif key == ' ':
        game_state.is_paused = not game_state.is_paused
    elif key == 'r' or key == 'R':
        restart_game()
    elif key == 'h' or key == 'H':
        # ãƒ©ãƒ³ã‚­ãƒ³ã‚°è¡¨ç¤ºã‚’JavaScriptã§å®Ÿè¡Œ
        return 'show_ranking'
    elif key == 'p' or key == 'P':
        # ãƒ‘ãƒ¯ãƒ¼ã‚¢ãƒƒãƒ—è¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆã‚’JavaScriptã§å®Ÿè¡Œ
        return 'toggle_powerup'
    return None

def restart_game():
    global game_state, pending_high_score_check
    pending_high_score_check = None  # ãƒªã‚¹ã‚¿ãƒ¼ãƒˆæ™‚ã«ãƒã‚¤ã‚¹ã‚³ã‚¢ãƒã‚§ãƒƒã‚¯ã‚’ã‚¯ãƒªã‚¢
    game_state = PygameGameState()
    game_state.add_observer(game_view)
            `);
        }
        
        // Canvasæç”»é–¢æ•°
        function drawFrame(frameData) {
            try {
                const data = JSON.parse(frameData);
                const commands = data.draw_commands || [];
                
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                
                for (const cmd of commands) {
                    switch (cmd.type) {
                        case 'fillRect':
                            ctx.fillStyle = cmd.color;
                            ctx.fillRect(cmd.x, cmd.y, cmd.width, cmd.height);
                            break;
                        case 'fillCircle':
                            ctx.fillStyle = cmd.color;
                            ctx.beginPath();
                            ctx.arc(cmd.x, cmd.y, cmd.radius, 0, 2 * Math.PI);
                            ctx.fill();
                            break;
                        case 'fillText':
                            ctx.fillStyle = cmd.color;
                            ctx.font = cmd.font;
                            ctx.fillText(cmd.text, cmd.x, cmd.y);
                            break;
                    }
                }
            } catch (error) {
                console.error('Draw error:', error);
            }
        }
        
        // ã‚²ãƒ¼ãƒ ãƒ«ãƒ¼ãƒ—
        function gameLoop() {
            try {
                const frameData = pyodide.runPython('update_game()');
                drawFrame(frameData);
                performanceMonitor.update();
                
                // ãƒ‘ãƒ¯ãƒ¼ã‚¢ãƒƒãƒ—è¡¨ç¤ºã‚’å®šæœŸçš„ã«æ›´æ–°
                if (Math.random() < 0.1) { // 10%ã®ç¢ºç‡ã§æ›´æ–°ï¼ˆè² è·è»½æ¸›ï¼‰
                    updatePowerupDisplay();
                }
                
                // ãƒã‚¤ã‚¹ã‚³ã‚¢ãƒã‚§ãƒƒã‚¯
                checkPendingHighScore();
            } catch (error) {
                console.error('Game loop error:', error);
            }
            
            gameLoopId = requestAnimationFrame(gameLoop);
        }
        
        // ä¿ç•™ä¸­ã®ãƒã‚¤ã‚¹ã‚³ã‚¢ãƒã‚§ãƒƒã‚¯ã‚’å‡¦ç†
        function checkPendingHighScore() {
            try {
                const pending = pyodide.runPython('get_pending_high_score()');
                if (pending && pending !== 'None' && pending !== 'null') {
                    const scoreData = JSON.parse(pending);
                    // å®Ÿéš›ã«ãƒã‚¤ã‚¹ã‚³ã‚¢ã‹ã©ã†ã‹ãƒã‚§ãƒƒã‚¯
                    if (scoreRanking && scoreRanking.isHighScore(scoreData.score)) {
                        showNameInputModal(scoreData);
                    }
                    // ãƒã‚¤ã‚¹ã‚³ã‚¢ã§ã‚‚ãã†ã§ãªãã¦ã‚‚ã€ãƒã‚§ãƒƒã‚¯æ¸ˆã¿ãªã®ã§Pythonå´ã§ã‚¯ãƒªã‚¢
                    pyodide.runPython('pending_high_score_check = None');
                }
            } catch (error) {
                // ã‚¨ãƒ©ãƒ¼ã¯ç„¡è¦–ï¼ˆpending_high_score_checkãŒNoneã®å ´åˆãªã©ï¼‰
            }
        }
        
        function startGameLoop() {
            if (gameLoopId) {
                cancelAnimationFrame(gameLoopId);
            }
            gameLoopId = requestAnimationFrame(gameLoop);
        }
        
        // ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã‚¤ãƒ™ãƒ³ãƒˆ
        document.addEventListener('keydown', function(event) {
            if (pyodide) {
                try {
                    const result = pyodide.runPython(`handle_key_input('${event.key}')`);
                    
                    // ç‰¹æ®Šãªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã®å‡¦ç†
                    if (result === 'show_ranking') {
                        showRankingModal();
                    } else if (result === 'toggle_powerup') {
                        togglePowerupDisplay();
                    }
                    
                    // Rã‚­ãƒ¼ã§ãƒªã‚¹ã‚¿ãƒ¼ãƒˆã—ãŸå ´åˆã€JavaScriptå´ã§ã‚‚ç¢ºå®Ÿã«ã‚¯ãƒªã‚¢
                    if (event.key === 'r' || event.key === 'R') {
                        pyodide.runPython('pending_high_score_check = None');
                    }
                } catch (error) {
                    console.error('Key input error:', error);
                }
            }
        });
        
        // ã‚¿ãƒƒãƒã‚¤ãƒ™ãƒ³ãƒˆã®è¨­å®š
        function setupTouchEvents() {
            if (!canvas) return;
            
            let touchStartX = null;
            let touchStartTime = null;
            
            canvas.addEventListener('touchstart', function(event) {
                event.preventDefault();
                const touch = event.touches[0];
                const rect = canvas.getBoundingClientRect();
                touchStartX = touch.clientX - rect.left;
                touchStartTime = Date.now();
                
                // ã‚¿ãƒƒãƒä½ç½®ã«åŸºã¥ã„ã¦ãƒ©ã‚±ãƒƒãƒˆã‚’ç§»å‹•
                if (pyodide) {
                    try {
                        const racketX = Math.max(0, Math.min(touchStartX - 30, canvas.width - 60));
                        pyodide.runPython(`game_state.update_racket_position(${racketX})`);
                    } catch (error) {
                        console.error('Touch input error:', error);
                    }
                }
            });
            
            canvas.addEventListener('touchmove', function(event) {
                event.preventDefault();
                const touch = event.touches[0];
                const rect = canvas.getBoundingClientRect();
                const touchX = touch.clientX - rect.left;
                
                // ã‚¿ãƒƒãƒç§»å‹•ã«è¿½å¾“ã—ã¦ãƒ©ã‚±ãƒƒãƒˆã‚’ç§»å‹•
                if (pyodide) {
                    try {
                        const racketX = Math.max(0, Math.min(touchX - 30, canvas.width - 60));
                        pyodide.runPython(`game_state.update_racket_position(${racketX})`);
                    } catch (error) {
                        console.error('Touch move error:', error);
                    }
                }
            });
            
            canvas.addEventListener('touchend', function(event) {
                event.preventDefault();
                const touchEndTime = Date.now();
                const touchDuration = touchEndTime - touchStartTime;
                
                // ãƒ€ãƒ–ãƒ«ã‚¿ãƒƒãƒ—ã§ã‚²ãƒ¼ãƒ å†é–‹/ä¸€æ™‚åœæ­¢
                if (touchDuration < 300) {
                    if (event.timeStamp - (window.lastTapTime || 0) < 300) {
                        // ãƒ€ãƒ–ãƒ«ã‚¿ãƒƒãƒ—æ¤œå‡º
                        if (pyodide) {
                            try {
                                pyodide.runPython('game_state.is_paused = not game_state.is_paused');
                            } catch (error) {
                                console.error('Double tap error:', error);
                            }
                        }
                    }
                    window.lastTapTime = event.timeStamp;
                }
            });
        }
        
        // ãƒ¢ãƒã‚¤ãƒ«ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒœã‚¿ãƒ³ã®è¿½åŠ 
        function addMobileControls() {
            const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
            
            if (isMobile) {
                // ãƒ¢ãƒã‚¤ãƒ«ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒ‘ãƒãƒ«ã‚’ä½œæˆ
                const controlPanel = document.createElement('div');
                controlPanel.id = 'mobileControls';
                controlPanel.style.cssText = `
                    position: fixed;
                    bottom: 20px;
                    left: 50%;
                    transform: translateX(-50%);
                    display: flex;
                    gap: 10px;
                    z-index: 1000;
                `;
                
                // ãƒªã‚¹ã‚¿ãƒ¼ãƒˆãƒœã‚¿ãƒ³
                const restartBtn = document.createElement('button');
                restartBtn.textContent = 'ğŸ”„ ãƒªã‚¹ã‚¿ãƒ¼ãƒˆ';
                restartBtn.style.cssText = `
                    padding: 10px 20px;
                    font-size: 16px;
                    background: #007BFF;
                    color: white;
                    border: none;
                    border-radius: 5px;
                    touch-action: manipulation;
                `;
                restartBtn.addEventListener('click', function() {
                    if (pyodide) {
                        pyodide.runPython('restart_game()');
                        pyodide.runPython('pending_high_score_check = None');
                    }
                });
                
                // ãƒ©ãƒ³ã‚­ãƒ³ã‚°ãƒœã‚¿ãƒ³
                const rankingBtn = document.createElement('button');
                rankingBtn.textContent = 'ğŸ† ãƒ©ãƒ³ã‚­ãƒ³ã‚°';
                rankingBtn.style.cssText = `
                    padding: 10px 20px;
                    font-size: 16px;
                    background: #28A745;
                    color: white;
                    border: none;
                    border-radius: 5px;
                    touch-action: manipulation;
                `;
                rankingBtn.addEventListener('click', function() {
                    showRankingModal();
                });
                
                controlPanel.appendChild(restartBtn);
                controlPanel.appendChild(rankingBtn);
                document.body.appendChild(controlPanel);
                
                // ã‚²ãƒ¼ãƒ èª¬æ˜ã«ã‚¿ãƒƒãƒæ“ä½œã®èª¬æ˜ã‚’è¿½åŠ 
                const touchHelp = document.createElement('div');
                touchHelp.style.cssText = `
                    position: absolute;
                    top: 65px;
                    left: 10px;
                    color: #999;
                    font-size: 12px;
                `;
                touchHelp.textContent = 'ã‚¿ãƒƒãƒ: ãƒ©ã‚±ãƒƒãƒˆç§»å‹• | ãƒ€ãƒ–ãƒ«ã‚¿ãƒƒãƒ—: ä¸€æ™‚åœæ­¢';
                canvas.parentElement.appendChild(touchHelp);
            }
        }
        
        // ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ç®¡ç†
        document.addEventListener('visibilitychange', function() {
            if (document.hidden && pyodide) {
                pyodide.runPython('game_state.is_paused = True');
            }
        });
        
        // ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒ©ãƒ¼
        window.addEventListener('error', function(event) {
            showError('äºˆæœŸã—ãªã„ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ', event.error?.message || '');
        });
        
        window.addEventListener('unhandledrejection', function(event) {
            showError('ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼ã¾ãŸã¯èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ', event.reason);
        });
        
        // ã‚²ãƒ¼ãƒ åˆæœŸåŒ–é–‹å§‹
        initializeGame();
    </script>
</body>
</html>