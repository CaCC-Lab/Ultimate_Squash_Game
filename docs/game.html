<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Ultimate Squash Game - Python/Pyodide WebAssemblyÁâà„ÄÇ„Éñ„É©„Ç¶„Ç∂„ÅßÂãï‰Ωú„Åô„ÇãËªΩÈáè(25KB)„Ç≤„Éº„É†">
    <meta name="keywords" content="squash,game,python,pyodide,webassembly,pygame">
    <meta name="author" content="Ultimate Squash Game Team">
    <meta name="theme-color" content="#004274">
    
    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:title" content="Ultimate Squash Game - WebAssemblyÁâà">
    <meta property="og:description" content="„Éñ„É©„Ç¶„Ç∂„ÅßÂãï‰Ωú„Åô„ÇãËªΩÈáè(25KB)„Çπ„Ç´„ÉÉ„Ç∑„É•„Ç≤„Éº„É†">
    <meta property="og:url" content="https://your-domain.com/ultimate-squash">
    
    <!-- Twitter -->
    <meta name="twitter:card" content="summary">
    <meta name="twitter:title" content="Ultimate Squash Game">
    <meta name="twitter:description" content="„Éñ„É©„Ç¶„Ç∂„ÅßÂãï‰Ωú„Åô„ÇãËªΩÈáè„Çπ„Ç´„ÉÉ„Ç∑„É•„Ç≤„Éº„É†">
    
    <title>Ultimate Squash Game - WebAssemblyÁâà</title>
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">
    
    <!-- PWA iOS Support -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Ultimate Squash">
    <link rel="apple-touch-icon" href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTgwIiBoZWlnaHQ9IjE4MCIgdmlld0JveD0iMCAwIDE4MCAxODAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIxODAiIGhlaWdodD0iMTgwIiByeD0iMjQiIGZpbGw9IiMwMDQyNzQiLz4KPGNpcmNsZSBjeD0iOTAiIGN5PSI5MCIgcj0iMjQiIGZpbGw9IiNmZmZmZmYiLz4KPHJlY3QgeD0iNzgiIHk9IjEzOCIgd2lkdGg9IjI0IiBoZWlnaHQ9IjM2IiByeD0iNCIgZmlsbD0iIzAwZmYwMCIvPgo8L3N2Zz4K">
    
    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzIiIGhlaWdodD0iMzIiIHZpZXdCb3g9IjAgMCAzMiAzMiIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjMyIiBoZWlnaHQ9IjMyIiBmaWxsPSIjMDA0Mjc0Ii8+CjxjaXJjbGUgY3g9IjE2IiBjeT0iMTYiIHI9IjQiIGZpbGw9IiNmZmZmZmYiLz4KPHJlY3QgeD0iMTQiIHk9IjI0IiB3aWR0aD0iNCIgaGVpZ2h0PSI2IiBmaWxsPSIjMDBmZjAwIi8+Cjwvc3ZnPgo=">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0c0c0c 0%, #1a1a2e 50%, #16213e 100%);
            color: #ffffff;
            overflow: hidden;
            height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        
        .game-container {
            max-width: 800px;
            width: 100%;
            text-align: center;
            position: relative;
        }
        
        .header {
            margin-bottom: 20px;
            opacity: 0;
            animation: fadeInUp 1s ease-out 0.5s forwards;
        }
        
        .title {
            font-size: 2.5rem;
            font-weight: bold;
            background: linear-gradient(45deg, #ff6b6b, #4ecdc4, #45b7d1);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 10px;
            text-shadow: 0 0 30px rgba(255, 255, 255, 0.3);
        }
        
        .subtitle {
            font-size: 1rem;
            color: #b0b0b0;
            font-weight: 300;
        }
        
        .canvas-wrapper {
            position: relative;
            display: inline-block;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            opacity: 0;
            animation: scaleIn 1s ease-out 1s forwards;
        }
        
        #gameCanvas {
            background: #000;
            display: block;
            border: 3px solid #333;
            border-radius: 12px;
        }
        
        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border-radius: 12px;
            transition: opacity 0.5s ease-out;
        }
        
        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 3px solid #333;
            border-top: 3px solid #4ecdc4;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }
        
        .loading-text {
            font-size: 1.2rem;
            color: #4ecdc4;
            margin-bottom: 10px;
        }
        
        .loading-progress {
            font-size: 0.9rem;
            color: #888;
        }
        
        .controls {
            margin-top: 20px;
            opacity: 0;
            animation: fadeInUp 1s ease-out 1.5s forwards;
        }
        
        .control-info {
            display: flex;
            justify-content: center;
            gap: 30px;
            font-size: 0.9rem;
            color: #999;
        }
        
        .control-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .key {
            background: #333;
            padding: 4px 8px;
            border-radius: 4px;
            font-family: monospace;
            border: 1px solid #555;
        }
        
        .performance-info {
            position: absolute;
            top: 10px;
            left: 10px;
            font-size: 0.8rem;
            color: #666;
            background: rgba(0, 0, 0, 0.7);
            padding: 8px 12px;
            border-radius: 6px;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .game-container:hover .performance-info {
            opacity: 1;
        }
        
        .error-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        
        .error-content {
            background: #1a1a2e;
            padding: 30px;
            border-radius: 12px;
            border: 2px solid #ff6b6b;
            max-width: 500px;
            text-align: center;
        }
        
        .error-title {
            color: #ff6b6b;
            font-size: 1.5rem;
            margin-bottom: 15px;
        }
        
        .error-message {
            color: #ccc;
            margin-bottom: 20px;
            line-height: 1.5;
        }
        
        .error-button {
            background: #ff6b6b;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1rem;
            transition: background 0.3s ease;
        }
        
        .error-button:hover {
            background: #ff5252;
        }
        
        /* „Ç¢„ÇØ„Çª„Ç∑„Éì„É™„ÉÜ„Ç£„Éë„Éç„É´ */
        .accessibility-panel {
            position: absolute;
            bottom: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.8);
            padding: 15px;
            border-radius: 8px;
            color: white;
            font-size: 0.9rem;
            min-width: 250px;
            display: none;
        }
        
        .accessibility-option {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 8px 0;
        }
        
        .accessibility-option label {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .accessibility-option select,
        .accessibility-option input[type="range"] {
            width: 100px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 4px;
            padding: 4px;
        }
        
        .accessibility-option input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }
        
        .accessibility-toggle {
            position: absolute;
            bottom: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.8);
            padding: 8px 12px;
            border-radius: 6px;
            color: white;
            font-size: 0.9rem;
            cursor: pointer;
            transition: background 0.3s ease;
        }
        
        .accessibility-toggle:hover {
            background: rgba(0, 0, 0, 0.9);
        }
        
        .install-button {
            position: absolute;
            bottom: 10px;
            right: 180px;
            background: #ff9800;
            color: white;
            padding: 8px 12px;
            border: none;
            border-radius: 5px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: background 0.3s ease;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        }
        
        .install-button:hover {
            background: #f57c00;
        }
        
        /* Ëâ≤Ë¶ö„É¢„Éº„ÉâÁî®„ÅÆ„Éï„Ç£„É´„Çø„Éº */
        .colorblind-protanopia {
            filter: url(#protanopia-filter);
        }
        
        .colorblind-deuteranopia {
            filter: url(#deuteranopia-filter);
        }
        
        .colorblind-tritanopia {
            filter: url(#tritanopia-filter);
        }
        
        .colorblind-achromatopsia {
            filter: grayscale(100%);
        }
        
        /* È´ò„Ç≥„É≥„Éà„É©„Çπ„Éà„É¢„Éº„Éâ */
        body.high-contrast {
            background: #000000 !important;
        }
        
        body.high-contrast .title {
            background: none !important;
            color: #FFFF00 !important;
            -webkit-text-fill-color: #FFFF00 !important;
        }
        
        body.high-contrast .subtitle {
            color: #FFFFFF !important;
        }
        
        body.high-contrast #gameCanvas {
            border-color: #FFFFFF !important;
        }
        
        body.high-contrast .key {
            background: #FFFFFF !important;
            color: #000000 !important;
            border-color: #FFFFFF !important;
        }
        
        body.high-contrast .control-item {
            color: #FFFFFF !important;
        }
        
        body.high-contrast .modal-content {
            background: #000000 !important;
            border-color: #FFFFFF !important;
        }
        
        body.high-contrast .modal-title {
            color: #FFFF00 !important;
        }
        
        body.high-contrast .modal-button {
            background: #FFFFFF !important;
            color: #000000 !important;
        }
        
        body.high-contrast .modal-button:hover {
            background: #FFFF00 !important;
        }
        
        /* „É¢„Éº„ÉÄ„É´„Çπ„Çø„Ç§„É´ */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        
        .modal-content {
            background: #1a1a2e;
            padding: 30px;
            border-radius: 12px;
            border: 2px solid #4ecdc4;
            max-width: 500px;
            text-align: center;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .modal-title {
            color: #4ecdc4;
            font-size: 1.5rem;
            margin-bottom: 20px;
        }
        
        .modal-input {
            width: 80%;
            padding: 10px;
            margin: 10px 0;
            border: 1px solid #4ecdc4;
            border-radius: 5px;
            background: #333;
            color: white;
            font-size: 1rem;
        }
        
        .modal-button {
            background: #4ecdc4;
            color: #1a1a2e;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1rem;
            margin: 5px;
            transition: background 0.3s ease;
        }
        
        .modal-button:hover {
            background: #45b7d1;
        }
        
        .ranking-list {
            text-align: left;
            margin: 20px 0;
        }
        
        .ranking-item {
            padding: 10px;
            margin: 5px 0;
            border-radius: 5px;
            background: rgba(255, 255, 255, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .ranking-item.highlight {
            background: rgba(78, 205, 196, 0.3);
            border: 1px solid #4ecdc4;
        }
        
        .ranking-rank {
            font-weight: bold;
            color: #4ecdc4;
            min-width: 30px;
        }
        
        .ranking-details {
            flex: 1;
            margin: 0 10px;
        }
        
        .ranking-name {
            font-weight: bold;
            margin-bottom: 2px;
        }
        
        .ranking-meta {
            font-size: 0.8rem;
            color: #999;
        }
        
        .ranking-score {
            font-weight: bold;
            color: #ff6b6b;
        }
        
        /* „Éë„ÉØ„Éº„Ç¢„ÉÉ„ÉóË°®Á§∫ */
        .powerup-display {
            position: absolute;
            top: 50px;
            left: 10px;
            background: rgba(0, 0, 0, 0.8);
            padding: 10px;
            border-radius: 8px;
            color: white;
            font-size: 0.9rem;
            min-width: 200px;
        }
        
        .powerup-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 5px 0;
            padding: 5px;
            border-radius: 4px;
        }
        
        .powerup-active {
            background: rgba(0, 255, 0, 0.2);
            border: 1px solid #00ff00;
        }
        
        .powerup-inactive {
            background: rgba(128, 128, 128, 0.2);
            border: 1px solid #666;
        }
        
        .powerup-timer {
            font-size: 0.8rem;
            color: #ffff00;
        }
        
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        @keyframes scaleIn {
            from {
                opacity: 0;
                transform: scale(0.9);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        @media (max-width: 768px) {
            .title {
                font-size: 2rem;
            }
            
            .control-info {
                flex-direction: column;
                gap: 10px;
            }
            
            #gameCanvas {
                width: 90vw;
                height: auto;
            }
        }
        
        /* „ÉÄ„Éº„ÇØ„ÉÜ„Éº„Éû„Çµ„Éù„Éº„Éà */
        @media (prefers-color-scheme: dark) {
            body {
                background: linear-gradient(135deg, #000000 0%, #1a1a2e 50%, #16213e 100%);
            }
        }
        
        /* „Çµ„Ç¶„É≥„Éâ„Ç≥„É≥„Éà„É≠„Éº„É´ */
        #soundToggle {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(26, 26, 46, 0.9);
            color: #4ecdc4;
            border: 2px solid #4ecdc4;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s ease;
            z-index: 100;
        }
        
        #soundToggle:hover {
            background: rgba(78, 205, 196, 0.2);
        }
        
        #soundToggle.muted {
            color: #666;
            border-color: #666;
        }
        
        /* WebSocketÊé•Á∂ö„Çπ„ÉÜ„Éº„Çø„Çπ */
        .connection-status {
            position: fixed;
            top: 70px;
            right: 20px;
            background: rgba(26, 26, 46, 0.9);
            color: #4ecdc4;
            border: 2px solid #4ecdc4;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 0.9rem;
            font-weight: 600;
            z-index: 99;
        }
        
        /* „ÉÅ„É£„É¨„É≥„Ç∏„Ç∑„Çπ„ÉÜ„É†UI */
        .challenge-container {
            position: fixed;
            top: 120px;
            right: 20px;
            z-index: 98;
        }
        
        .challenge-button {
            background: rgba(255, 193, 7, 0.9);
            color: #1a1a2e;
            border: 2px solid #ffc107;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        .challenge-button:hover {
            background: rgba(255, 193, 7, 1);
            transform: translateY(-2px);
        }
        
        .challenge-menu {
            position: absolute;
            top: 100%;
            right: 0;
            margin-top: 10px;
            background: rgba(26, 26, 46, 0.95);
            border: 2px solid #4ecdc4;
            border-radius: 12px;
            padding: 20px;
            min-width: 300px;
            max-width: 400px;
        }
        
        .challenge-selector h3 {
            color: #4ecdc4;
            margin: 0 0 15px 0;
            text-align: center;
        }
        
        .challenge-selector button {
            background: rgba(78, 205, 196, 0.2);
            color: #4ecdc4;
            border: 1px solid #4ecdc4;
            padding: 8px 16px;
            border-radius: 6px;
            margin: 5px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .challenge-selector button:hover {
            background: rgba(78, 205, 196, 0.4);
        }
        
        .challenge-item {
            margin: 10px 0;
            padding: 10px;
            background: rgba(78, 205, 196, 0.1);
            border-radius: 8px;
            border: 1px solid rgba(78, 205, 196, 0.3);
        }
        
        .challenge-item p {
            margin: 0 0 8px 0;
            color: #e0e6ed;
            font-size: 0.9rem;
        }
        
        .challenge-item button {
            background: rgba(255, 193, 7, 0.8);
            color: #1a1a2e;
            border: 1px solid #ffc107;
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: 600;
        }
        
        .challenge-item button:hover {
            background: rgba(255, 193, 7, 1);
        }
    </style>
    
    <!-- „É©„É≥„Ç≠„É≥„Ç∞„Ç∑„Çπ„ÉÜ„É†„ÅÆ„Çπ„ÇØ„É™„Éó„Éà -->
    <script type="module" src="js/ranking.js"></script>
    
    <!-- ÈÄ±Êõø„Çè„Çä„ÉÅ„É£„É¨„É≥„Ç∏„Ç∑„Çπ„ÉÜ„É†„ÅÆ„Çπ„ÇØ„É™„Éó„Éà -->
    <script src="js/weekly-challenge.js"></script>
    <script src="js/challenge-evaluator.js"></script>
    <script src="js/challenge-rewards.js"></script>
    <script type="module" src="js/bridge/python-js-bridge.js"></script>
    
    <!-- Phase 4: ‰∏¶ÂàóÂàùÊúüÂåñ„Ç∑„Çπ„ÉÜ„É†„ÅÆ„Çπ„ÇØ„É™„Éó„Éà -->
    <!-- Phase 5A: „Éñ„É©„Ç¶„Ç∂ÈÅ©Âøú„Çø„Ç§„É†„Ç¢„Ç¶„Éà„Ç∑„Çπ„ÉÜ„É† -->
    <script src="js/browser-adaptive-timeout.js"></script>
    
    <script src="js/parallel-initializer.js"></script>
    
    <!-- „Çπ„ÇØ„É™„Éó„ÉàË™≠„ÅøËæº„ÅøÁ¢∫Ë™çÁî® -->
    <script>
        // „Ç∞„É≠„Éº„Éê„É´„Å™„Çπ„ÇØ„É™„Éó„ÉàË™≠„ÅøËæº„ÅøÁä∂ÊÖã„ÅÆÁÆ°ÁêÜ
        window.scriptLoadingStatus = {
            browserAdaptiveTimeout: false,
            parallelInitializer: false,
            allLoaded: false
        };
        
        // „Çπ„ÇØ„É™„Éó„ÉàË™≠„ÅøËæº„ÅøÂÆå‰∫Ü„ÇíÁ¢∫Ë™ç„Åô„ÇãÈñ¢Êï∞
        window.checkScriptAvailability = function() {
            const status = window.scriptLoadingStatus;
            
            // BrowserAdaptiveTimeoutManager„ÅÆÁ¢∫Ë™ç
            if (typeof window.BrowserAdaptiveTimeoutManager === 'function' && 
                window.browserAdaptiveTimeout) {
                status.browserAdaptiveTimeout = true;
                console.log('[Script Check] ‚úÖ BrowserAdaptiveTimeoutManager loaded');
            }
            
            // ParallelInitializer„ÅÆÁ¢∫Ë™ç
            if (typeof window.ParallelInitializer === 'function') {
                status.parallelInitializer = true;
                console.log('[Script Check] ‚úÖ ParallelInitializer loaded');
            }
            
            // ÂÖ®„Çπ„ÇØ„É™„Éó„Éà„ÅåË™≠„ÅøËæº„Åæ„Çå„Å¶„ÅÑ„Çã„Åã„ÉÅ„Çß„ÉÉ„ÇØ
            status.allLoaded = status.browserAdaptiveTimeout && status.parallelInitializer;
            
            if (status.allLoaded) {
                console.log('[Script Check] ‚úÖ All core scripts loaded successfully');
                // „Ç´„Çπ„Çø„É†„Ç§„Éô„É≥„Éà„ÇíÁô∫ÁÅ´
                window.dispatchEvent(new CustomEvent('coreScriptsLoaded', { detail: status }));
            } else {
                console.warn('[Script Check] ‚ö†Ô∏è Missing scripts:', {
                    browserAdaptiveTimeout: status.browserAdaptiveTimeout,
                    parallelInitializer: status.parallelInitializer
                });
            }
            
            return status;
        };
        
        // DOMË™≠„ÅøËæº„ÅøÂÆå‰∫ÜÂæå„Å´„Çπ„ÇØ„É™„Éó„ÉàÁ¢∫Ë™ç
        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(() => {
                window.checkScriptAvailability();
            }, 100); // Áü≠„ÅÑÈÅÖÂª∂„Åß„Çπ„ÇØ„É™„Éó„ÉàË™≠„ÅøËæº„ÅøÂÆå‰∫Ü„ÇíÂæÖ„Å§
        });
    </script>
</head>
<body>
    <div class="game-container">
        <header class="header">
            <h1 class="title">Ultimate Squash Game</h1>
            <p class="subtitle">Python/Pyodide WebAssemblyÁâà - ËªΩÈáè25KB</p>
            <button class="control-button" style="position: absolute; right: 20px; top: 20px;" onclick="window.rankingController.showRanking()">üåê „Ç™„É≥„É©„Ç§„É≥„É©„É≥„Ç≠„É≥„Ç∞</button>
        </header>
        
        <div class="canvas-wrapper">
            <canvas id="gameCanvas" width="640" height="480"></canvas>
            <div class="loading-overlay" id="loadingOverlay">
                <div class="loading-spinner"></div>
                <div class="loading-text">„Ç≤„Éº„É†Ë™≠„ÅøËæº„Åø‰∏≠...</div>
                <div class="loading-progress" id="loadingProgress">Pyodide„ÇíÂàùÊúüÂåñ‰∏≠...</div>
            </div>
            <div class="performance-info" id="performanceInfo">
                FPS: <span id="fpsCounter">60</span> | 
                Memory: <span id="memoryUsage">1.2MB</span>
            </div>
            <div class="powerup-display" id="powerupDisplay" style="display: none;">
                <h4>„Éë„ÉØ„Éº„Ç¢„ÉÉ„ÉóÁä∂Ê≥Å</h4>
                <div id="powerupList"></div>
            </div>
        </div>
        
        <div class="controls">
            <div class="control-info">
                <div class="control-item">
                    <span class="key">‚Üê</span><span class="key">‚Üí</span>
                    <span>„É©„Ç±„ÉÉ„ÉàÁßªÂãï</span>
                </div>
                <div class="control-item">
                    <span class="key">Space</span>
                    <span>„Éù„Éº„Ç∫/ÂÜçÈñã</span>
                </div>
                <div class="control-item">
                    <span class="key">R</span>
                    <span>„É™„Çπ„Çø„Éº„Éà</span>
                </div>
                <div class="control-item">
                    <span class="key">H</span>
                    <span>„É©„É≥„Ç≠„É≥„Ç∞Ë°®Á§∫</span>
                </div>
                <div class="control-item">
                    <span class="key">P</span>
                    <span>„Éë„ÉØ„Éº„Ç¢„ÉÉ„ÉóË°®Á§∫</span>
                </div>
                <div class="control-item">
                    <span class="key">A</span>
                    <span>„Ç¢„ÇØ„Çª„Ç∑„Éì„É™„ÉÜ„Ç£</span>
                </div>
            </div>
        </div>
        
        <!-- „Ç¢„ÇØ„Çª„Ç∑„Éì„É™„ÉÜ„Ç£„Éë„Éç„É´ -->
        <div class="accessibility-panel" id="accessibilityPanel">
            <h4>„Ç¢„ÇØ„Çª„Ç∑„Éì„É™„ÉÜ„Ç£Ë®≠ÂÆö</h4>
            <div class="accessibility-option">
                <label for="colorblindMode">Ëâ≤Ë¶ö„É¢„Éº„Éâ</label>
                <select id="colorblindMode" onchange="applyColorblindMode(this.value)">
                    <option value="none">Ê®ôÊ∫ñ</option>
                    <option value="protanopia">PÂûãÔºàËµ§Á∑ëËâ≤Ë¶öÔºâ</option>
                    <option value="deuteranopia">DÂûãÔºàËµ§Á∑ëËâ≤Ë¶öÔºâ</option>
                    <option value="tritanopia">TÂûãÔºàÈùíÈªÑËâ≤Ë¶öÔºâ</option>
                    <option value="achromatopsia">ÂÖ®Ëâ≤Ë¶ö</option>
                </select>
            </div>
            <div class="accessibility-option">
                <label>
                    <input type="checkbox" id="highContrastMode" onchange="toggleHighContrast()">
                    È´ò„Ç≥„É≥„Éà„É©„Çπ„Éà„É¢„Éº„Éâ
                </label>
            </div>
            <div class="accessibility-option">
                <label for="gammaControl">Êòé„Çã„ÅïË™øÊï¥: <span id="gammaValue">1.0</span></label>
                <input type="range" id="gammaControl" min="0.5" max="2" step="0.1" value="1" onchange="applyGamma(this.value)">
            </div>
            <div class="accessibility-option">
                <label>
                    <input type="checkbox" id="reduceMotion" onchange="toggleReduceMotion()">
                    „É¢„Éº„Ç∑„Éß„É≥ËªΩÊ∏õ
                </label>
            </div>
            <div class="accessibility-option">
                <label for="soundVolume">ÂäπÊûúÈü≥„ÅÆÈü≥Èáè</label>
                <input type="range" id="soundVolume" min="0" max="100" step="10" value="50" onchange="updateSoundVolume(this.value)">
            </div>
        </div>
        
        <!-- „Ç¢„ÇØ„Çª„Ç∑„Éì„É™„ÉÜ„Ç£„Éà„Ç∞„É´ -->
        <div class="accessibility-toggle" id="accessibilityToggle" onclick="toggleAccessibilityPanel()">
            ‚ôø „Ç¢„ÇØ„Çª„Ç∑„Éì„É™„ÉÜ„Ç£
        </div>
        
        <!-- PWA„Ç§„É≥„Çπ„Éà„Éº„É´„Éú„Çø„É≥ -->
        <div class="install-button" id="installButton" style="display: none;" onclick="installPWA()">
            üì• „Ç§„É≥„Çπ„Éà„Éº„É´
        </div>
        
        <button id="soundToggle" onclick="toggleSound()">üîä „Çµ„Ç¶„É≥„Éâ ON</button>
        
        <!-- WebSocketÊé•Á∂ö„Çπ„ÉÜ„Éº„Çø„Çπ -->
        <div class="connection-status" id="connectionStatus">
            üî¥ Êú™Êé•Á∂ö
        </div>
        
        <!-- „ÉÅ„É£„É¨„É≥„Ç∏„Ç∑„Çπ„ÉÜ„É†UI -->
        <div class="challenge-container">
            <button id="challengeButton" class="challenge-button" onclick="openChallengeMenu()">
                üèÜ „ÉÅ„É£„É¨„É≥„Ç∏
            </button>
            <div id="challengeMenu" class="challenge-menu" style="display: none;">
                <div class="challenge-selector">
                    <h3>ÈÄ±Êõø„Çè„Çä„ÉÅ„É£„É¨„É≥„Ç∏</h3>
                    <div id="challengeList"></div>
                    <button onclick="loadRandomChallenge()">„É©„É≥„ÉÄ„É†„ÉÅ„É£„É¨„É≥„Ç∏</button>
                    <button onclick="closeChallengeMenu()">Èñâ„Åò„Çã</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- „Ç®„É©„Éº„É¢„Éº„ÉÄ„É´ -->
    <div class="error-modal" id="errorModal">
        <div class="error-content">
            <h2 class="error-title">„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü</h2>
            <p class="error-message" id="errorMessage">
                „Ç≤„Éº„É†„ÅÆË™≠„ÅøËæº„Åø‰∏≠„Å´„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü„ÄÇ
            </p>
            <button class="error-button" onclick="closeErrorModal()">ÂÜçË©¶Ë°å</button>
        </div>
    </div>
    
    <!-- ÂêçÂâçÂÖ•Âäõ„É¢„Éº„ÉÄ„É´ -->
    <div class="modal" id="nameInputModal">
        <div class="modal-content">
            <h2 class="modal-title">Êñ∞Ë®òÈå≤ÈÅîÊàêÔºÅ</h2>
            <p>„Åä„ÇÅ„Åß„Å®„ÅÜ„Åî„Åñ„ÅÑ„Åæ„ÅôÔºÅ„Éè„Ç§„Çπ„Ç≥„Ç¢„Å´„É©„É≥„ÇØ„Ç§„É≥„Åó„Åæ„Åó„Åü„ÄÇ</p>
            <p>„Çπ„Ç≥„Ç¢: <span id="newScoreValue">0</span></p>
            <input type="text" id="playerNameInput" class="modal-input" placeholder="„ÅÇ„Å™„Åü„ÅÆÂêçÂâç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ" maxlength="20" value="Player" onkeydown="if(event.key==='Enter') confirmScoreEntry()">
            <br>
            <button class="modal-button" onclick="confirmScoreEntry()">Ë®òÈå≤„Åô„Çã</button>
            <button class="modal-button" onclick="cancelScoreEntry()">„Ç≠„É£„É≥„Çª„É´</button>
        </div>
    </div>
    
    <!-- „É©„É≥„Ç≠„É≥„Ç∞Ë°®Á§∫„É¢„Éº„ÉÄ„É´ -->
    <div class="modal" id="rankingModal">
        <div class="modal-content">
            <h2 class="modal-title">üèÜ „Éè„Ç§„Çπ„Ç≥„Ç¢ „É©„É≥„Ç≠„É≥„Ç∞</h2>
            <div id="rankingList" class="ranking-list">
                <!-- „É©„É≥„Ç≠„É≥„Ç∞„Éá„Éº„Çø„Åå„Åì„Åì„Å´ÂãïÁöÑ„Å´ËøΩÂä†„Åï„Çå„Åæ„Åô -->
            </div>
            <button class="modal-button" onclick="closeRankingModal()">Èñâ„Åò„Çã</button>
            <button class="modal-button" onclick="clearRanking()">„É©„É≥„Ç≠„É≥„Ç∞„ÇØ„É™„Ç¢</button>
        </div>
    </div>
    
    <!-- SVG„Éï„Ç£„É´„Çø„ÉºÔºàËâ≤Ë¶ö„É¢„Éº„ÉâÁî®Ôºâ -->
    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
        <defs>
            <!-- Protanopia (PÂûãËâ≤Ë¶ö) „Éï„Ç£„É´„Çø„Éº -->
            <filter id="protanopia-filter">
                <feColorMatrix type="matrix" values="
                    0.567, 0.433, 0,     0, 0
                    0.558, 0.442, 0,     0, 0
                    0,     0.242, 0.758, 0, 0
                    0,     0,     0,     1, 0" />
            </filter>
            
            <!-- Deuteranopia (DÂûãËâ≤Ë¶ö) „Éï„Ç£„É´„Çø„Éº -->
            <filter id="deuteranopia-filter">
                <feColorMatrix type="matrix" values="
                    0.625, 0.375, 0,   0, 0
                    0.700, 0.300, 0,   0, 0
                    0,     0.300, 0.700, 0, 0
                    0,     0,     0,   1, 0" />
            </filter>
            
            <!-- Tritanopia (TÂûãËâ≤Ë¶ö) „Éï„Ç£„É´„Çø„Éº -->
            <filter id="tritanopia-filter">
                <feColorMatrix type="matrix" values="
                    0.950, 0.050, 0,     0, 0
                    0,     0.433, 0.567, 0, 0
                    0,     0.475, 0.525, 0, 0
                    0,     0,     0,     1, 0" />
            </filter>
        </defs>
    </svg>
    
    <!-- PyodideË™≠„ÅøËæº„Åø -->
    <script src="https://cdn.jsdelivr.net/pyodide/v0.26.4/full/pyodide.js"></script>
    
    <script>
        // Service WorkerÁôªÈå≤ÔºàÊó©ÊúüÂÆüË°åÔºâ
        let serviceWorkerReady = false;
        let cacheStatus = { pyodideFiles: 0, gameFiles: 0 };
        
        if ('serviceWorker' in navigator) {
            // Service Worker„ÇíÂç≥Â∫ß„Å´ÁôªÈå≤
            navigator.serviceWorker.register('./sw.js')
                .then(async (registration) => {
                    console.log('[Main] Service Worker registered');
                    
                    // Service Worker„Åå„Ç¢„ÇØ„ÉÜ„Ç£„Éñ„Å´„Å™„Çã„ÅÆ„ÇíÂæÖ„Å§
                    if (registration.active) {
                        serviceWorkerReady = true;
                        await checkCacheStatus();
                    } else if (registration.installing || registration.waiting) {
                        registration.addEventListener('updatefound', async () => {
                            const newWorker = registration.installing || registration.waiting;
                            newWorker.addEventListener('statechange', async () => {
                                if (newWorker.state === 'activated') {
                                    serviceWorkerReady = true;
                                    await checkCacheStatus();
                                }
                            });
                        });
                    }
                })
                .catch((error) => {
                    console.error('[Main] Service Worker registration failed:', error);
                });
        }
        
        // „Ç≠„É£„ÉÉ„Ç∑„É•Áä∂ÊÖã„ÇíÁ¢∫Ë™ç
        async function checkCacheStatus() {
            if (!navigator.serviceWorker.controller) return;
            
            return new Promise((resolve) => {
                const messageChannel = new MessageChannel();
                messageChannel.port1.onmessage = (event) => {
                    if (event.data.type === 'CACHE_STATUS_RESPONSE') {
                        cacheStatus = {
                            pyodideFiles: event.data.pyodideFiles,
                            gameFiles: event.data.gameFiles
                        };
                        console.log('[Main] Cache status:', cacheStatus);
                        resolve();
                    }
                };
                
                navigator.serviceWorker.controller.postMessage(
                    { type: 'CACHE_STATUS' },
                    [messageChannel.port2]
                );
            });
        }
        
        // „Ç∞„É≠„Éº„Éê„É´Â§âÊï∞
        window.DEBUG_MODE = false;  // Êú¨Áï™Áí∞Â¢É„Åß„ÅØfalse„Å´Ë®≠ÂÆö
        let pyodide = null;
        let gameLoopId = null;  // gameLoop ‚Üí gameLoopId„Å´Â§âÊõ¥„Åó„Å¶redeclaration„Ç®„É©„Éº„ÇíÂõûÈÅø
        let gameState = null;
        let canvas = null;
        let ctx = null;
        let soundSystem = null;  // „Çµ„Ç¶„É≥„Éâ„Ç∑„Çπ„ÉÜ„É†
        let performanceMonitor = null;
        let pythonBridge = null;  // Python-JS Bridge
        let challengeManager = null;  // „ÉÅ„É£„É¨„É≥„Ç∏„Éû„Éç„Éº„Ç∏„É£„Éº
        
        // Êñ∞Ê©üËÉΩÁî®„Ç∞„É≠„Éº„Éê„É´Â§âÊï∞
        let scoreRanking = null;
        let pendingScoreData = null;
        
        // „Çµ„Ç¶„É≥„Éâ„Ç∑„Çπ„ÉÜ„É†
        class SoundSystem {
            constructor() {
                this.audioContext = null;
                this.soundEnabled = true;
                this.sounds = {};
                this.bgmGain = null;
                this.sfxGain = null;
                this.bgmInterval = null;
                this.bgmBuffer = null;
                this.bgmSource = null;
                this.isInitialized = false;
            }
            
            async initAudio() {
                if (this.isInitialized) return;
                
                try {
                    this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    
                    // AudioContext„ÅÆÁä∂ÊÖãÁ¢∫Ë™ç„Å®resume
                    if (this.audioContext.state === 'suspended') {
                        await this.audioContext.resume();
                    }
                    
                    // „É°„Ç§„É≥„Ç≤„Ç§„É≥„Éé„Éº„Éâ
                    const mainGain = this.audioContext.createGain();
                    mainGain.connect(this.audioContext.destination);
                    
                    // BGMÁî®„Ç≤„Ç§„É≥„Éé„Éº„Éâ
                    this.bgmGain = this.audioContext.createGain();
                    this.bgmGain.gain.value = 0.3;
                    this.bgmGain.connect(mainGain);
                    
                    // SFXÁî®„Ç≤„Ç§„É≥„Éé„Éº„Éâ
                    this.sfxGain = this.audioContext.createGain();
                    this.sfxGain.gain.value = 0.7;
                    this.sfxGain.connect(mainGain);
                    
                    // 8-bitÈ¢®„ÅÆÈü≥„ÇíÁîüÊàê
                    this.createSounds();
                    
                    // BGMÁî®„ÅÆAudioBuffer„Çí‰ΩúÊàê
                    await this.createBGMBuffer();
                    
                    this.isInitialized = true;
                    console.log('„Çµ„Ç¶„É≥„Éâ„Ç∑„Çπ„ÉÜ„É†„ÇíÂàùÊúüÂåñ„Åó„Åæ„Åó„Åü');
                } catch (error) {
                    console.warn('„Çµ„Ç¶„É≥„Éâ„Ç∑„Çπ„ÉÜ„É†„ÅÆÂàùÊúüÂåñ„Å´Â§±Êïó:', error);
                    this.soundEnabled = false;
                }
            }
            
            createSounds() {
                if (!this.audioContext) return;
                
                // „Éú„Éº„É´Ë°ùÁ™ÅÈü≥Ôºà„Éî„ÉÉ„ÉÅÂ§âË™øÔºâ
                this.sounds.ballHit = (pitch = 1.0) => {
                    const oscillator = this.audioContext.createOscillator();
                    const gainNode = this.audioContext.createGain();
                    
                    oscillator.type = 'square';
                    oscillator.frequency.setValueAtTime(220 * pitch, this.audioContext.currentTime);
                    oscillator.frequency.exponentialRampToValueAtTime(110 * pitch, this.audioContext.currentTime + 0.1);
                    
                    gainNode.gain.setValueAtTime(0.3, this.audioContext.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, this.audioContext.currentTime + 0.1);
                    
                    oscillator.connect(gainNode);
                    gainNode.connect(this.sfxGain);
                    
                    oscillator.start();
                    oscillator.stop(this.audioContext.currentTime + 0.1);
                };
                
                // „Çπ„Ç≥„Ç¢Áç≤ÂæóÈü≥
                this.sounds.scoreUp = () => {
                    const oscillator = this.audioContext.createOscillator();
                    const gainNode = this.audioContext.createGain();
                    
                    oscillator.type = 'sawtooth';
                    oscillator.frequency.setValueAtTime(330, this.audioContext.currentTime);
                    oscillator.frequency.exponentialRampToValueAtTime(660, this.audioContext.currentTime + 0.2);
                    
                    gainNode.gain.setValueAtTime(0.2, this.audioContext.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, this.audioContext.currentTime + 0.2);
                    
                    oscillator.connect(gainNode);
                    gainNode.connect(this.sfxGain);
                    
                    oscillator.start();
                    oscillator.stop(this.audioContext.currentTime + 0.2);
                };
                
                // „Éë„ÉØ„Éº„Ç¢„ÉÉ„ÉóÈü≥
                this.sounds.powerUp = () => {
                    const oscillator = this.audioContext.createOscillator();
                    const gainNode = this.audioContext.createGain();
                    
                    oscillator.type = 'triangle';
                    oscillator.frequency.setValueAtTime(440, this.audioContext.currentTime);
                    oscillator.frequency.exponentialRampToValueAtTime(880, this.audioContext.currentTime + 0.3);
                    
                    gainNode.gain.setValueAtTime(0.3, this.audioContext.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, this.audioContext.currentTime + 0.3);
                    
                    oscillator.connect(gainNode);
                    gainNode.connect(this.sfxGain);
                    
                    oscillator.start();
                    oscillator.stop(this.audioContext.currentTime + 0.3);
                };
                
                // „Ç≤„Éº„É†„Ç™„Éº„Éê„ÉºÈü≥
                this.sounds.gameOver = () => {
                    const oscillator = this.audioContext.createOscillator();
                    const gainNode = this.audioContext.createGain();
                    
                    oscillator.type = 'sine';
                    oscillator.frequency.setValueAtTime(220, this.audioContext.currentTime);
                    oscillator.frequency.exponentialRampToValueAtTime(110, this.audioContext.currentTime + 0.5);
                    
                    gainNode.gain.setValueAtTime(0.4, this.audioContext.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, this.audioContext.currentTime + 0.5);
                    
                    oscillator.connect(gainNode);
                    gainNode.connect(this.sfxGain);
                    
                    oscillator.start();
                    oscillator.stop(this.audioContext.currentTime + 0.5);
                };
                
                // „Ç≤„Éº„É†„Ç™„Éº„Éê„ÉºÈü≥
                this.sounds.gameOver = () => {
                    const oscillator = this.audioContext.createOscillator();
                    const gainNode = this.audioContext.createGain();
                    
                    oscillator.type = 'sawtooth';
                    oscillator.frequency.setValueAtTime(330, this.audioContext.currentTime);
                    oscillator.frequency.exponentialRampToValueAtTime(165, this.audioContext.currentTime + 1.0);
                    
                    gainNode.gain.setValueAtTime(0.3, this.audioContext.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, this.audioContext.currentTime + 1.0);
                    
                    oscillator.connect(gainNode);
                    gainNode.connect(this.sfxGain);
                    
                    oscillator.start();
                    oscillator.stop(this.audioContext.currentTime + 1.0);
                };
            }
            
            async createBGMBuffer() {
                if (!this.audioContext) return;
                
                const sampleRate = this.audioContext.sampleRate;
                const duration = 4.8; // 8Èü≥ √ó 0.6Áßí
                const bufferSize = sampleRate * duration;
                
                this.bgmBuffer = this.audioContext.createBuffer(1, bufferSize, sampleRate);
                const data = this.bgmBuffer.getChannelData(0);
                
                const notes = [330, 370, 440, 494, 523, 440, 370, 330]; // C4-A4-F4-G4-C5-F4-A4-C4
                const noteDuration = 0.6;
                
                for (let noteIndex = 0; noteIndex < notes.length; noteIndex++) {
                    const noteStartSample = Math.floor(noteIndex * noteDuration * sampleRate);
                    const noteEndSample = Math.floor((noteIndex + 1) * noteDuration * sampleRate);
                    
                    for (let i = noteStartSample; i < noteEndSample && i < bufferSize; i++) {
                        const t = (i - noteStartSample) / sampleRate;
                        const freq = notes[noteIndex];
                        
                        // SquareÊ≥¢ÁîüÊàê
                        const phase = (t * freq * 2 * Math.PI) % (2 * Math.PI);
                        const squareWave = phase < Math.PI ? 1 : -1;
                        
                        // „Ç®„É≥„Éô„É≠„Éº„ÉóÔºà„Éï„Çß„Éº„Éâ„Ç§„É≥„Éª„Éï„Çß„Éº„Éâ„Ç¢„Ç¶„ÉàÔºâ
                        const fadeTime = 0.05;
                        let envelope = 1;
                        if (t < fadeTime) {
                            envelope = t / fadeTime;
                        } else if (t > noteDuration - fadeTime) {
                            envelope = (noteDuration - t) / fadeTime;
                        }
                        
                        data[i] = squareWave * envelope * 0.1;
                    }
                }
            }
            
            playSound(soundName, ...args) {
                if (!this.soundEnabled) return;
                
                // ÂàùÊúüÂåñ„ÅåÂøÖË¶Å„Å™Â†¥Âêà„ÅØÂÆüË°å
                if (!this.isInitialized) {
                    this.initAudio().then(() => {
                        this.playSound(soundName, ...args);
                    });
                    return;
                }
                
                if (!this.audioContext) return;
                
                // „Ç™„Éº„Éá„Ç£„Ç™„Ç≥„É≥„ÉÜ„Ç≠„Çπ„Éà„ÇíÂÜçÈñãÔºà„É¶„Éº„Ç∂„Éº„Ç§„É≥„Çø„É©„ÇØ„Ç∑„Éß„É≥ÂæåÔºâ
                if (this.audioContext.state === 'suspended') {
                    this.audioContext.resume();
                }
                
                const sound = this.sounds[soundName];
                if (sound) {
                    sound(...args);
                }
            }
            
            async startBGM() {
                if (!this.soundEnabled) return;
                
                // ÂàùÊúüÂåñ„ÅåÂøÖË¶Å„Å™Â†¥Âêà„ÅØÂÆüË°å
                if (!this.isInitialized) {
                    await this.initAudio();
                }
                
                if (!this.audioContext || !this.bgmBuffer) return;
                
                // Êó¢Â≠ò„ÅÆBGM„ÇíÂÅúÊ≠¢
                this.stopBGM();
                
                // AudioContext„ÇíÂÜçÈñã
                if (this.audioContext.state === 'suspended') {
                    await this.audioContext.resume();
                }
                
                // BGMGain„Çí„Éï„Çß„Éº„Éâ„Ç§„É≥
                this.bgmGain.gain.setValueAtTime(0, this.audioContext.currentTime);
                this.bgmGain.gain.linearRampToValueAtTime(0.3, this.audioContext.currentTime + 0.5);
                
                // AudioBufferSourceNode„Çí‰ΩøÁî®„Åó„Åü„É´„Éº„ÉóÂÜçÁîü
                this.bgmSource = this.audioContext.createBufferSource();
                this.bgmSource.buffer = this.bgmBuffer;
                this.bgmSource.loop = true;
                this.bgmSource.connect(this.bgmGain);
                this.bgmSource.start();
            }
            
            stopBGM() {
                if (this.bgmSource) {
                    // „Éï„Çß„Éº„Éâ„Ç¢„Ç¶„Éà
                    if (this.audioContext && this.bgmGain) {
                        this.bgmGain.gain.setValueAtTime(this.bgmGain.gain.value, this.audioContext.currentTime);
                        this.bgmGain.gain.linearRampToValueAtTime(0, this.audioContext.currentTime + 0.5);
                    }
                    
                    // 0.5ÁßíÂæå„Å´ÂÅúÊ≠¢
                    setTimeout(() => {
                        if (this.bgmSource) {
                            this.bgmSource.stop();
                            this.bgmSource.disconnect();
                            this.bgmSource = null;
                        }
                    }, 500);
                }
                
                if (this.bgmInterval) {
                    clearInterval(this.bgmInterval);
                    this.bgmInterval = null;
                }
            }
            
            async toggle() {
                this.soundEnabled = !this.soundEnabled;
                const button = document.getElementById('soundToggle');
                
                if (this.soundEnabled) {
                    button.textContent = 'üîä „Çµ„Ç¶„É≥„Éâ ON';
                    button.classList.remove('muted');
                    
                    // ÂàùÊúüÂåñ„ÅåÂøÖË¶Å„Å™Â†¥Âêà„ÅØÂÆüË°åÔºà„É¶„Éº„Ç∂„Éº„Ç§„É≥„Çø„É©„ÇØ„Ç∑„Éß„É≥ÂæåÔºâ
                    if (!this.isInitialized) {
                        await this.initAudio();
                    }
                    
                    await this.startBGM();
                } else {
                    button.textContent = 'üîá „Çµ„Ç¶„É≥„Éâ OFF';
                    button.classList.add('muted');
                    this.stopBGM();
                }
            }
            
            get muted() {
                return !this.soundEnabled;
            }
            
            setMuted(muteState) {
                this.soundEnabled = !muteState;
                const button = document.getElementById('soundToggle');
                if (button) {
                    if (muteState) {
                        button.textContent = 'üîá „Çµ„Ç¶„É≥„Éâ OFF';
                        button.classList.add('muted');
                        this.stopBGM();
                    } else {
                        button.textContent = 'üîä „Çµ„Ç¶„É≥„Éâ ON';
                        button.classList.remove('muted');
                        if (this.isInitialized) {
                            this.startBGM();
                        }
                    }
                }
            }
            
            processSoundEvents(frameData) {
                // „Éï„É¨„Éº„É†„Éá„Éº„Çø„Å´Âü∫„Å•„ÅÑ„Å¶„Çµ„Ç¶„É≥„Éâ„Ç§„Éô„É≥„Éà„ÇíÂá¶ÁêÜ
                if (!this.soundEnabled || !frameData) return;
                
                // „Éú„Éº„É´„Åå„Éë„Éâ„É´„Å´Ë°ùÁ™Å„Åó„ÅüÂ†¥Âêà
                if (frameData.ballHit) {
                    // „Éú„Éº„É´„ÅÆÈÄüÂ∫¶„Å´Âü∫„Å•„ÅÑ„Å¶„Éî„ÉÉ„ÉÅ„ÇíÂ§âÂåñ
                    const speed = Math.sqrt(frameData.ballVelocityX**2 + frameData.ballVelocityY**2);
                    const pitch = Math.min(2.0, 1.0 + speed / 10);
                    this.playSound('ballHit', pitch);
                }
                
                // „Çπ„Ç≥„Ç¢„ÅåÂ§âÂåñ„Åó„ÅüÂ†¥Âêà
                if (frameData.scoreChanged) {
                    this.playSound('scoreUp');
                }
                
                // „Éë„ÉØ„Éº„Ç¢„ÉÉ„Éó„ÇíÂèñÂæó„Åó„ÅüÂ†¥Âêà
                if (frameData.powerUpCollected) {
                    this.playSound('powerUp');
                }
                
                // „Ç≤„Éº„É†„Ç™„Éº„Éê„Éº„ÅÆÂ†¥Âêà
                if (frameData.gameOver) {
                    this.playSound('gameOver');
                }
            }
        }
        
        // „Çµ„Ç¶„É≥„Éâ„Ç∑„Çπ„ÉÜ„É†„ÅØ„É°„Ç§„É≥ÂàùÊúüÂåñ„Åß‰ΩúÊàê„Åï„Çå„Çã
        let gameStartTime = Date.now(); // „Ç≤„Éº„É†ÈñãÂßãÊôÇÂàª„ÇíË®òÈå≤
        
        // „Ç¢„ÇØ„Çª„Ç∑„Éì„É™„ÉÜ„Ç£Ë®≠ÂÆöÁî®„Ç∞„É≠„Éº„Éê„É´Â§âÊï∞
        let accessibilitySettings = {
            colorblindMode: 'none',
            highContrast: false,
            gamma: 1.0,
            reduceMotion: false,
            soundVolume: 0.5,
            canvasColors: {
                standard: {
                    background: '#000000',
                    ball: 'rgb(255, 255, 255)',
                    racket: 'rgb(0, 255, 0)',
                    text: 'white',
                    ballAlt1: 'rgb(255, 200, 0)',
                    ballAlt2: 'rgb(0, 200, 255)',
                    powerupColors: {
                        wide_racket: '#00ff00',
                        slow_ball: '#00ffff',
                        extra_points: '#ffff00',
                        shield: '#ff00ff'
                    }
                },
                highContrast: {
                    background: '#000000',
                    ball: '#FFFFFF',
                    racket: '#FFFF00',
                    text: '#FFFFFF',
                    ballAlt1: '#FFFFFF',
                    ballAlt2: '#FFFFFF',
                    powerupColors: {
                        wide_racket: '#FFFFFF',
                        slow_ball: '#FFFFFF',
                        extra_points: '#FFFFFF',
                        shield: '#FFFFFF'
                    }
                }
            }
        };
        
        // „É≠„Éº„Ç´„É´„Çπ„Éà„É¨„Éº„Ç∏„Åã„ÇâË®≠ÂÆö„ÇíË™≠„ÅøËæº„Åø
        function loadAccessibilitySettings() {
            try {
                const saved = localStorage.getItem('ultimateSquashAccessibility');
                if (saved) {
                    const settings = JSON.parse(saved);
                    Object.assign(accessibilitySettings, settings);
                    applyAccessibilitySettings();
                }
            } catch (error) {
                console.error('Failed to load accessibility settings:', error);
            }
        }
        
        // Ë®≠ÂÆö„Çí„É≠„Éº„Ç´„É´„Çπ„Éà„É¨„Éº„Ç∏„Å´‰øùÂ≠ò
        function saveAccessibilitySettings() {
            try {
                localStorage.setItem('ultimateSquashAccessibility', JSON.stringify(accessibilitySettings));
            } catch (error) {
                console.error('Failed to save accessibility settings:', error);
            }
        }
        
        // „Çπ„Ç≥„Ç¢„É©„É≥„Ç≠„É≥„Ç∞„Ç∑„Çπ„ÉÜ„É†
        class ScoreRanking {
            constructor() {
                this.storageKey = 'ultimateSquashHighScores';
                this.maxScores = 10;
            }
            
            getHighScores() {
                const stored = localStorage.getItem(this.storageKey);
                return stored ? JSON.parse(stored) : [];
            }
            
            addScore(score, playerName = 'Player', combo = 0, powerUps = 0) {
                const scores = this.getHighScores();
                const newScore = {
                    score: score,
                    name: playerName,
                    date: new Date().toISOString(),
                    combo: combo,
                    powerUps: powerUps
                };
                
                scores.push(newScore);
                scores.sort((a, b) => b.score - a.score);
                scores.splice(this.maxScores);
                
                localStorage.setItem(this.storageKey, JSON.stringify(scores));
                return scores.findIndex(s => s === newScore) + 1;
            }
            
            isHighScore(score) {
                const scores = this.getHighScores();
                return (
                    scores.length < this.maxScores ||
                    score > (scores[scores.length - 1]?.score || 0)
                );
            }
            
            clearScores() {
                localStorage.removeItem(this.storageKey);
            }
        }

        // „Éë„Éï„Ç©„Éº„Éû„É≥„ÇπÁõ£Ë¶ñ
        class PerformanceMonitor {
            constructor() {
                this.frameCount = 0;
                this.lastTime = performance.now();
                this.fps = 60;
                this.memoryUsage = 0;
            }
            
            update() {
                this.frameCount++;
                const currentTime = performance.now();
                
                if (currentTime - this.lastTime >= 1000) {
                    this.fps = Math.round(this.frameCount * 1000 / (currentTime - this.lastTime));
                    this.frameCount = 0;
                    this.lastTime = currentTime;
                    
                    // „É°„É¢„É™‰ΩøÁî®Èáè„ÇíÊõ¥Êñ∞
                    if (performance.memory) {
                        this.memoryUsage = (performance.memory.usedJSHeapSize / 1024 / 1024).toFixed(1);
                    }
                    
                    this.updateDisplay();
                }
            }
            
            updateDisplay() {
                document.getElementById('fpsCounter').textContent = this.fps;
                document.getElementById('memoryUsage').textContent = this.memoryUsage + 'MB';
            }
        }
        
        // HTML„Ç®„Çπ„Ç±„Éº„ÉóÈñ¢Êï∞ÔºàXSSÂØæÁ≠ñÔºâ
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // „Ç®„É©„Éº„Éè„É≥„Éâ„É™„É≥„Ç∞
        function showError(message, details = '') {
            console.error('Game Error:', message, details);
            document.getElementById('errorMessage').textContent = message;
            document.getElementById('errorModal').style.display = 'flex';
        }
        
        function closeErrorModal() {
            document.getElementById('errorModal').style.display = 'none';
            // ÂÜçË©¶Ë°å
            initializeGame();
        }
        
        // „Çπ„Ç≥„Ç¢Èñ¢ÈÄ£„É¢„Éº„ÉÄ„É´Ê©üËÉΩ
        function showNameInputModal(scoreData) {
            pendingScoreData = scoreData;
            document.getElementById('newScoreValue').textContent = scoreData.score;
            document.getElementById('playerNameInput').value = 'Player';
            document.getElementById('nameInputModal').style.display = 'flex';
            setTimeout(() => {
                document.getElementById('playerNameInput').focus();
                document.getElementById('playerNameInput').select();
            }, 100);
        }
        
        async function confirmScoreEntry() {
            const playerName = document.getElementById('playerNameInput').value.trim() || 'Player';
            if (pendingScoreData) {
                // „Ç™„É≥„É©„Ç§„É≥„É©„É≥„Ç≠„É≥„Ç∞„Å´ÈÄÅ‰ø°
                try {
                    const gameMode = gameState?.mode || 'normal'; // „Ç≤„Éº„É†„É¢„Éº„Éâ„ÇíÂèñÂæóÔºà„Éá„Éï„Ç©„É´„Éà: normalÔºâ
                    const duration = Math.floor((Date.now() - gameStartTime) / 1000); // ÁßíÂçò‰Ωç
                    
                    await window.rankingController.submitScore(
                        playerName,
                        pendingScoreData.score,
                        gameMode,
                        duration
                    );
                    console.log('„Çπ„Ç≥„Ç¢„Çí„Ç™„É≥„É©„Ç§„É≥„É©„É≥„Ç≠„É≥„Ç∞„Å´ÈÄÅ‰ø°„Åó„Åæ„Åó„Åü');
                } catch (error) {
                    console.error('„Ç™„É≥„É©„Ç§„É≥„É©„É≥„Ç≠„É≥„Ç∞„Å∏„ÅÆÈÄÅ‰ø°„Å´Â§±Êïó„Åó„Åæ„Åó„Åü:', error);
                }
            }
            document.getElementById('nameInputModal').style.display = 'none';
            pendingScoreData = null;
            window.rankingController.showRanking(); // Êõ¥Êñ∞„Åï„Çå„Åü„É©„É≥„Ç≠„É≥„Ç∞„ÇíË°®Á§∫
        }
        
        function cancelScoreEntry() {
            document.getElementById('nameInputModal').style.display = 'none';
            pendingScoreData = null;
            if (pyodide) {
                pyodide.runPython('pending_high_score_check = None');
            }
        }
        
        function showRankingModal() {
            window.rankingController.showRanking();
        }
        
        function closeRankingModal() {
            document.getElementById('rankingModal').style.display = 'none';
        }
        
        function clearRanking() {
            if (confirm('Êú¨ÂΩì„Å´„É©„É≥„Ç≠„É≥„Ç∞„Çí„ÇØ„É™„Ç¢„Åó„Åæ„Åô„ÅãÔºü')) {
                if (scoreRanking) {
                    scoreRanking.clearScores();
                }
                showRankingModal(); // „É™„Éï„É¨„ÉÉ„Ç∑„É•
            }
        }
        
        // „Éë„ÉØ„Éº„Ç¢„ÉÉ„ÉóË°®Á§∫Ê©üËÉΩ
        function togglePowerupDisplay() {
            const display = document.getElementById('powerupDisplay');
            if (display.style.display === 'none') {
                display.style.display = 'block';
                updatePowerupDisplay();
            } else {
                display.style.display = 'none';
            }
        }
        
        function updatePowerupDisplay() {
            if (!pyodide) return;
            
            try {
                const powerupData = pyodide.runPython(`
import json
powerup_info = {
    'multi_ball': {
        'active': getattr(game_state, 'multi_ball_active', False),
        'threshold': getattr(game_state, 'multi_ball_threshold', 5),
        'hits': getattr(game_state, 'consecutive_hits', 0)
    },
    'powerups': getattr(game_state, 'active_powerups', {})
}
json.dumps(powerup_info)
                `);
                
                const data = JSON.parse(powerupData);
                const powerupList = document.getElementById('powerupList');
                
                let html = `
                    <div class="powerup-item ${data.multi_ball.active ? 'powerup-active' : 'powerup-inactive'}">
                        <span>„Éû„É´„ÉÅ„Éú„Éº„É´</span>
                        <span>${data.multi_ball.hits}/${data.multi_ball.threshold}</span>
                    </div>
                `;
                
                const powerupTypes = {
                    'wide_racket': '„ÉØ„Ç§„Éâ„É©„Ç±„ÉÉ„Éà',
                    'slow_ball': '„Çπ„É≠„Éº„Éú„Éº„É´',
                    'extra_points': '„Ç®„ÇØ„Çπ„Éà„É©„Éù„Ç§„É≥„Éà',
                    'shield': '„Ç∑„Éº„É´„Éâ'
                };
                
                for (const [type, name] of Object.entries(powerupTypes)) {
                    const isActive = data.powerups[type] && data.powerups[type].active;
                    const remaining = isActive ? Math.ceil(data.powerups[type].remaining / 1000) : 0;
                    
                    html += `
                        <div class="powerup-item ${isActive ? 'powerup-active' : 'powerup-inactive'}">
                            <span>${name}</span>
                            <span class="powerup-timer">${isActive ? remaining + 's' : 'OFF'}</span>
                        </div>
                    `;
                }
                
                powerupList.innerHTML = html;
            } catch (error) {
                console.error('PowerUp display error:', error);
            }
        }
        
        // „Ç¢„ÇØ„Çª„Ç∑„Éì„É™„ÉÜ„Ç£„Éë„Éç„É´„ÅÆË°®Á§∫Âàá„ÇäÊõø„Åà
        function toggleAccessibilityPanel() {
            const panel = document.getElementById('accessibilityPanel');
            const currentDisplay = window.getComputedStyle(panel).display;
            panel.style.display = currentDisplay === 'none' ? 'block' : 'none';
        }
        
        // Ëâ≤Ë¶ö„É¢„Éº„Éâ„ÅÆÈÅ©Áî®
        function applyColorblindMode(mode) {
            accessibilitySettings.colorblindMode = mode;
            const body = document.body;
            
            // Êó¢Â≠ò„ÅÆ„ÇØ„É©„Çπ„ÇíÂâäÈô§
            body.classList.remove('colorblind-protanopia', 'colorblind-deuteranopia', 
                                  'colorblind-tritanopia', 'colorblind-achromatopsia');
            
            // Êñ∞„Åó„ÅÑ„ÇØ„É©„Çπ„ÇíÈÅ©Áî®
            if (mode !== 'none') {
                body.classList.add(`colorblind-${mode}`);
            }
            
            saveAccessibilitySettings();
        }
        
        // È´ò„Ç≥„É≥„Éà„É©„Çπ„Éà„É¢„Éº„Éâ„ÅÆÂàá„ÇäÊõø„Åà
        function toggleHighContrast() {
            const checkbox = document.getElementById('highContrastMode');
            accessibilitySettings.highContrast = checkbox.checked;
            document.body.classList.toggle('high-contrast', checkbox.checked);
            
            // PythonÂÅ¥„Å´È´ò„Ç≥„É≥„Éà„É©„Çπ„ÉàË®≠ÂÆö„ÇíÂèçÊò†
            if (pyodide) {
                updateGameColors();
            }
            
            saveAccessibilitySettings();
        }
        
        // „Ç¨„É≥„ÉûÂÄ§„ÅÆÈÅ©Áî®
        function applyGamma(value) {
            accessibilitySettings.gamma = parseFloat(value);
            
            // „Ç¨„É≥„ÉûÂÄ§„ÅÆË°®Á§∫„ÇíÊõ¥Êñ∞
            const gammaValueElement = document.getElementById('gammaValue');
            if (gammaValueElement) {
                gammaValueElement.textContent = parseFloat(value).toFixed(1);
            }
            
            // „Ç≠„É£„É≥„Éê„Çπ„Å´„Éñ„É©„Ç§„Éà„Éç„Çπ„Éï„Ç£„É´„Çø„Éº„ÇíÈÅ©Áî®
            const canvas = document.getElementById('gameCanvas');
            if (canvas) {
                const currentFilter = canvas.style.filter || '';
                const filterParts = currentFilter.split(' ').filter(f => !f.includes('brightness'));
                filterParts.push(`brightness(${value})`);
                canvas.style.filter = filterParts.join(' ');
            }
            
            // CanvasÊèèÁîªÊôÇ„Å´„Ç¨„É≥„ÉûË£úÊ≠£„ÇíÈÅ©Áî®
            saveAccessibilitySettings();
        }
        
        // „É¢„Éº„Ç∑„Éß„É≥ËªΩÊ∏õ„ÅÆÂàá„ÇäÊõø„Åà
        function toggleReduceMotion() {
            const checkbox = document.getElementById('reduceMotion');
            accessibilitySettings.reduceMotion = checkbox.checked;
            
            // CSS„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥„ÇíÁÑ°ÂäπÂåñ
            if (checkbox.checked) {
                document.documentElement.style.setProperty('--animation-duration', '0s');
            } else {
                document.documentElement.style.removeProperty('--animation-duration');
            }
            
            saveAccessibilitySettings();
        }
        
        // Èü≥Èáè„ÅÆÊõ¥Êñ∞
        function updateSoundVolume(value) {
            accessibilitySettings.soundVolume = parseFloat(value) / 100;
            // Èü≥ÈáèË®≠ÂÆö„ÇíPythonÂÅ¥„Å´ÂèçÊò†ÔºàÂ∞ÜÊù•ÁöÑ„Å™ÂÆüË£ÖÁî®Ôºâ
            saveAccessibilitySettings();
        }
        
        // Ë®≠ÂÆö„ÅÆÈÅ©Áî®
        function applyAccessibilitySettings() {
            // Ëâ≤Ë¶ö„É¢„Éº„Éâ
            if (accessibilitySettings.colorblindMode !== 'none') {
                applyColorblindMode(accessibilitySettings.colorblindMode);
            }
            document.getElementById('colorblindMode').value = accessibilitySettings.colorblindMode;
            
            // È´ò„Ç≥„É≥„Éà„É©„Çπ„Éà
            document.getElementById('highContrastMode').checked = accessibilitySettings.highContrast;
            if (accessibilitySettings.highContrast) {
                document.body.classList.add('high-contrast');
            }
            
            // „Ç¨„É≥„Éû
            document.getElementById('gammaControl').value = accessibilitySettings.gamma;
            const gammaValueElement = document.getElementById('gammaValue');
            if (gammaValueElement) {
                gammaValueElement.textContent = accessibilitySettings.gamma.toFixed(1);
            }
            applyGamma(accessibilitySettings.gamma);
            
            // „É¢„Éº„Ç∑„Éß„É≥ËªΩÊ∏õ
            document.getElementById('reduceMotion').checked = accessibilitySettings.reduceMotion;
            if (accessibilitySettings.reduceMotion) {
                document.documentElement.style.setProperty('--animation-duration', '0s');
            }
            
            // Èü≥Èáè
            document.getElementById('soundVolume').value = accessibilitySettings.soundVolume * 100;
        }
        
        // „Ç≤„Éº„É†ÂÜÖ„ÅÆËâ≤„ÇíÊõ¥Êñ∞
        function updateGameColors() {
            if (!pyodide) return;
            
            const colors = accessibilitySettings.highContrast ? 
                          accessibilitySettings.canvasColors.highContrast : 
                          accessibilitySettings.canvasColors.standard;
            
            try {
                pyodide.runPython(`
# Ëâ≤Ë®≠ÂÆö„ÇíÊõ¥Êñ∞
if game_state:
    # „Éú„Éº„É´„ÅÆËâ≤
    for i, ball in enumerate(game_state.balls):
        if i == 0:
            ball.color = ${JSON.stringify(colors.ball).replace('rgb', '')};
        elif i == 1:
            ball.color = ${JSON.stringify(colors.ballAlt1).replace('rgb', '')};
        else:
            ball.color = ${JSON.stringify(colors.ballAlt2).replace('rgb', '')};
    
    # „É©„Ç±„ÉÉ„Éà„ÅÆËâ≤
    if game_state.racket:
        game_state.racket.color = ${JSON.stringify(colors.racket).replace('rgb', '')};
                `);
            } catch (error) {
                console.error('Failed to update game colors:', error);
                // „É¶„Éº„Ç∂„Éº„Å∏„ÅÆÈÄöÁü•ÔºàÈùû‰æµË•≤ÁöÑÔºâ
                if (window.showNotification && typeof window.showNotification === 'function') {
                    window.showNotification('Ëâ≤Ë®≠ÂÆö„ÅÆÊõ¥Êñ∞„Å´Â§±Êïó„Åó„Åæ„Åó„Åü', 'warning');
                }
            }
        }
        
        // „É≠„Éº„Éá„Ç£„É≥„Ç∞Áä∂ÊÖã„ÅÆÊõ¥Êñ∞
        function updateLoadingProgress(text) {
            document.getElementById('loadingProgress').textContent = text;
        }
        
        function hideLoadingScreen() {
            const overlay = document.getElementById('loadingOverlay');
            overlay.style.opacity = '0';
            overlay.style.pointerEvents = 'none';
            setTimeout(() => {
                overlay.style.display = 'none';
            }, 500);
        }
        
        // Phase 4: ‰∏¶ÂàóÂàùÊúüÂåñ„Å®„Ç≤„Éº„É†ÈñãÂßã
        async function initializeGame() {
            try {
                // Service Worker„ÅåÊ∫ñÂÇô„Åß„Åç„Çã„Åæ„ÅßÂ∞ë„ÅóÂæÖ„Å§ÔºàÊúÄÂ§ß2ÁßíÔºâ
                let waitTime = 0;
                while (!serviceWorkerReady && waitTime < 2000) {
                    await new Promise(resolve => setTimeout(resolve, 100));
                    waitTime += 100;
                }
                
                // Phase 4: ‰∏¶ÂàóÂàùÊúüÂåñ„Ç∑„Çπ„ÉÜ„É†„ÅÆÈñãÂßã
                console.log('[Main] Starting Phase 4: Parallel Initialization');
                
                // ‰∏¶ÂàóÂàùÊúüÂåñ„Ç∑„Çπ„ÉÜ„É†„ÅÆÂàùÊúüÂåñ
                const parallelInitializer = new ParallelInitializer();
                window.parallelInitializer = parallelInitializer;
                
                // ÂàùÊúüÂåñ„Ç§„Éô„É≥„Éà„ÅÆ„Éè„É≥„Éâ„É™„É≥„Ç∞
                parallelInitializer.on('initializationStarted', (data) => {
                    updateLoadingProgress('‰∏¶ÂàóÂàùÊúüÂåñ„ÇíÈñãÂßã„Åó„Å¶„ÅÑ„Åæ„Åô...');
                    console.log('[Main] Parallel initialization started:', data);
                });
                
                parallelInitializer.on('stageStarted', (data) => {
                    const stageMessages = {
                        'pyodide': 'PyodideÂàùÊúüÂåñ‰∏≠...',
                        'pygame-ce': 'Pygame-CEË™≠„ÅøËæº„Åø‰∏≠...',
                        'game-code': '„Ç≤„Éº„É†„Ç≥„Éº„ÉâË™≠„ÅøËæº„Åø‰∏≠...',
                        'audio-system': '„Ç™„Éº„Éá„Ç£„Ç™„Ç∑„Çπ„ÉÜ„É†ÂàùÊúüÂåñ‰∏≠...',
                        'canvas-setup': 'CanvasÁµ±ÂêàË®≠ÂÆö‰∏≠...',
                        'finalization': 'ÊúÄÁµÇÁµ±ÂêàÂá¶ÁêÜ‰∏≠...'
                    };
                    
                    const message = stageMessages[data.stage] || data.message;
                    updateLoadingProgress(message);
                    
                    // „Ç≠„É£„ÉÉ„Ç∑„É•Áä∂ÊÖãÊÉÖÂ†±„ÇíËøΩÂä†
                    if (data.stage === 'pyodide' && cacheStatus.pyodideFiles > 0) {
                        updateLoadingProgress(`${message} („Ç≠„É£„ÉÉ„Ç∑„É•Ê∏à„Åø: ${cacheStatus.pyodideFiles}„Éï„Ç°„Ç§„É´)`);
                    }
                    
                    console.log(`[Main] Stage started: ${data.stage}`);
                });
                
                parallelInitializer.on('stageProgress', (data) => {
                    const progressMessage = `${data.message} (${Math.round(data.progress)}%)`;
                    updateLoadingProgress(progressMessage);
                });
                
                parallelInitializer.on('stageCompleted', (data) => {
                    console.log(`[Main] Stage completed: ${data.stage} in ${data.duration}ms`);
                });
                
                parallelInitializer.on('initializationCompleted', (stats) => {
                    console.log('[Main] Parallel initialization completed:', stats);
                    
                    // „ÉÜ„Çπ„ÉàÁî®„Éá„Éº„Çø„ÇíË®≠ÂÆö
                    window.actualGameTestData = {
                        pyodideInitialized: true,
                        parallelInitializationTime: stats.totalDuration,
                        parallelInitializationStats: stats
                    };
                    
                    // Ê¨°„ÅÆ„Çπ„ÉÜ„ÉÉ„Éó„Å´ÈÄ≤„ÇÄ
                    continueGameInitialization();
                });
                
                parallelInitializer.on('initializationError', (error) => {
                    console.error('[Main] Parallel initialization failed:', error);
                    
                    // „Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ: ÂæìÊù•„ÅÆÈÄêÊ¨°ÂàùÊúüÂåñ
                    console.log('[Main] Falling back to sequential initialization');
                    fallbackSequentialInitialization();
                });
                
                // ‰∏¶ÂàóÂàùÊúüÂåñ„ÅÆÈñãÂßã
                const initSuccess = await parallelInitializer.startInitialization();
                
                if (!initSuccess) {
                    // ÂàùÊúüÂåñÂ§±ÊïóÊôÇ„ÅÆ„Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØÂá¶ÁêÜ
                    console.warn('[Main] Parallel initialization failed, using fallback');
                    await fallbackSequentialInitialization();
                }
                
            } catch (error) {
                console.error('[Main] Game initialization failed:', error);
                updateLoadingProgress('ÂàùÊúüÂåñ„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ„É™„É≠„Éº„Éâ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
                throw error;
            }
        }
        
        // ‰∏¶ÂàóÂàùÊúüÂåñÂÆå‰∫ÜÂæå„ÅÆÂá¶ÁêÜ
        async function continueGameInitialization() {
            try {
                updateLoadingProgress('„Ç≤„Éº„É†„Ç∑„Çπ„ÉÜ„É†„ÇíÂàùÊúüÂåñ‰∏≠...');
                
                // Pyodide„Åå‰∏¶ÂàóÂàùÊúüÂåñ„ÅßÊ∫ñÂÇô„Åï„Çå„Å¶„ÅÑ„Çã„ÅØ„Åö„Å™„ÅÆ„Åß„ÄÅ„Åù„Çå„Çí‰ΩøÁî®
                pyodide = window.pyodide;
                
                // Canvas„ÅÆÂàùÊúüÂåñÔºà‰∏¶ÂàóÂàùÊúüÂåñ„ÅßÊ∫ñÂÇôÊ∏à„ÅøÔºâ
                canvas = document.getElementById('gameCanvas');
                if (!canvas) {
                    throw new Error('Canvas not found after parallel initialization');
                }
                ctx = canvas.getContext('2d');
                
                // „Éë„Éï„Ç©„Éº„Éû„É≥„ÇπÁõ£Ë¶ñ„ÇíÈñãÂßã
                performanceMonitor = new PerformanceMonitor();
                
                // „Çπ„Ç≥„Ç¢„É©„É≥„Ç≠„É≥„Ç∞„Ç∑„Çπ„ÉÜ„É†„ÇíÂàùÊúüÂåñ
                scoreRanking = new ScoreRanking();
                
                // „Ç¢„ÇØ„Çª„Ç∑„Éì„É™„ÉÜ„Ç£Ë®≠ÂÆö„ÇíË™≠„ÅøËæº„Åø
                loadAccessibilitySettings();
                
                // „Çø„ÉÉ„ÉÅ„Ç§„Éô„É≥„Éà„É™„Çπ„Éä„Éº„ÇíË®≠ÂÆö
                setupTouchEvents();
                
                // „Ç≤„Éº„É†Áä∂ÊÖã„ÇíÂàùÊúüÂåñ
                await initializeGameState();
                
                updateLoadingProgress('„Ç≤„Éº„É†ÈñãÂßãÊ∫ñÂÇôÂÆå‰∫Ü');
                
                // „ÉÜ„Çπ„ÉàÁî®„Éá„Éº„Çø„ÇíÊõ¥Êñ∞ÔºàÂàùÊúüÂåñÂÆå‰∫ÜÔºâ
                if (window.actualGameTestData) {
                    window.actualGameTestData.pyodideInitialized = true;
                }
                
                // „É≠„Éº„Éá„Ç£„É≥„Ç∞ÁîªÈù¢„ÇíÈùûË°®Á§∫
                hideLoadingScreen();
                
                // „Çµ„Ç¶„É≥„Éâ„Ç∑„Çπ„ÉÜ„É†„ÇíÂàùÊúüÂåñ
                soundSystem = new SoundSystem();
                
                // WebSocketÊé•Á∂ö„Çπ„ÉÜ„Éº„Çø„Çπ„ÇíÂàùÊúüÂåñ
                updateConnectionStatus('disconnected');
                
                // „É¢„Éê„Ç§„É´„Ç≥„É≥„Éà„É≠„Éº„É´„ÇíËøΩÂä†
                addMobileControls();
                
                // WebSocketÊé•Á∂ö„ÇíË©¶Ë°åÔºàÈùûÂêåÊúü„ÄÅÂ§±Êïó„Åó„Å¶„ÇÇ„Ç≤„Éº„É†„ÅØÁ∂ôÁ∂öÔºâ
                initializeWebSocketConnection();
                
                // „Ç≤„Éº„É†„É´„Éº„ÉóÈñãÂßã
                startGameLoop();
                
                if (window.DEBUG_MODE) {
                    console.log('üéÆ Ultimate Squash Game loaded successfully with parallel initialization!');
                }
                
            } catch (error) {
                console.error('[Main] Game initialization continuation failed:', error);
                showError(
                    '„Ç≤„Éº„É†„ÅÆÂàùÊúüÂåñ„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ„Éñ„É©„Ç¶„Ç∂„ÅåÊúÄÊñ∞Áâà„ÅãÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ',
                    error.message
                );
            }
        }
        
        // „Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ: ÂæìÊù•„ÅÆÈÄêÊ¨°ÂàùÊúüÂåñ
        async function fallbackSequentialInitialization() {
            try {
                console.log('[Main] Starting fallback sequential initialization');
                updateLoadingProgress('„Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØÂàùÊúüÂåñ„ÇíÈñãÂßã„Åó„Å¶„ÅÑ„Åæ„Åô...');
                
                // ÂæìÊù•„ÅÆÈÄêÊ¨°ÂàùÊúüÂåñÂá¶ÁêÜ
                if (cacheStatus.pyodideFiles > 0) {
                    updateLoadingProgress(`Pyodide„ÇíÂàùÊúüÂåñ‰∏≠... („Ç≠„É£„ÉÉ„Ç∑„É•Ê∏à„Åø: ${cacheStatus.pyodideFiles}„Éï„Ç°„Ç§„É´)`);
                } else {
                    updateLoadingProgress('Pyodide„ÇíÂàùÊúüÂåñ‰∏≠... (ÂàùÂõû„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ)');
                }
                
                // PyodideÂàùÊúüÂåñ
                const startTime = performance.now();
                pyodide = await loadPyodide({
                    indexURL: "https://cdn.jsdelivr.net/pyodide/v0.26.4/full/"
                });
                
                window.pyodide = pyodide;
                const loadTime = performance.now() - startTime;
                console.log(`[Main] Pyodide loaded (fallback) in ${Math.round(loadTime)}ms`);
                
                // „ÉÜ„Çπ„ÉàÁî®„Éá„Éº„Çø„ÇíË®≠ÂÆö
                window.actualGameTestData = {
                    pyodideInitialized: true,
                    pyodideLoadTime: loadTime,
                    fallbackMode: true
                };
                
                updateLoadingProgress('Pygame-CE„ÇíË™≠„ÅøËæº„Åø‰∏≠...');
                await pyodide.loadPackage(["pygame-ce"]);
                
                updateLoadingProgress('„Ç≤„Éº„É†„Ç≥„Éº„Éâ„ÇíË™≠„ÅøËæº„Åø‰∏≠...');
                await loadGameCode();
                
                updateLoadingProgress('„Ç≤„Éº„É†„ÇíÂàùÊúüÂåñ‰∏≠...');
                
                // CanvasÂàùÊúüÂåñ
                canvas = document.getElementById('gameCanvas');
                ctx = canvas.getContext('2d');
                
                // „Åù„ÅÆ‰ªñ„ÅÆ„Ç∑„Çπ„ÉÜ„É†ÂàùÊúüÂåñ
                performanceMonitor = new PerformanceMonitor();
                scoreRanking = new ScoreRanking();
                loadAccessibilitySettings();
                setupTouchEvents();
                
                // „Ç≤„Éº„É†Áä∂ÊÖã„ÇíÂàùÊúüÂåñ
                await initializeGameState();
                
                updateLoadingProgress('„Ç≤„Éº„É†ÈñãÂßãÊ∫ñÂÇôÂÆå‰∫Ü');
                
                // „ÉÜ„Çπ„ÉàÁî®„Éá„Éº„Çø„ÇíÊõ¥Êñ∞ÔºàÂàùÊúüÂåñÂÆå‰∫ÜÔºâ
                if (window.actualGameTestData) {
                    window.actualGameTestData.pyodideInitialized = true;
                }
                
                // „É≠„Éº„Éá„Ç£„É≥„Ç∞ÁîªÈù¢„ÇíÈùûË°®Á§∫
                hideLoadingScreen();
                
                // „Çµ„Ç¶„É≥„Éâ„Ç∑„Çπ„ÉÜ„É†„ÇíÂàùÊúüÂåñ
                soundSystem = new SoundSystem();
                
                // WebSocketÊé•Á∂ö„Çπ„ÉÜ„Éº„Çø„Çπ„ÇíÂàùÊúüÂåñ
                updateConnectionStatus('disconnected');
                
                // „É¢„Éê„Ç§„É´„Ç≥„É≥„Éà„É≠„Éº„É´„ÇíËøΩÂä†
                addMobileControls();
                
                // WebSocketÊé•Á∂ö„ÇíË©¶Ë°åÔºàÈùûÂêåÊúü„ÄÅÂ§±Êïó„Åó„Å¶„ÇÇ„Ç≤„Éº„É†„ÅØÁ∂ôÁ∂öÔºâ
                initializeWebSocketConnection();
                
                // „Ç≤„Éº„É†„É´„Éº„ÉóÈñãÂßã
                startGameLoop();
                
                if (window.DEBUG_MODE) {
                    console.log('üéÆ Ultimate Squash Game loaded successfully!');
                }
                
            } catch (error) {
                showError(
                    '„Ç≤„Éº„É†„ÅÆÂàùÊúüÂåñ„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ„Éñ„É©„Ç¶„Ç∂„ÅåÊúÄÊñ∞Áâà„ÅãÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ',
                    error.message
                );
            }
        }
        
        // „Ç≤„Éº„É†„Ç≥„Éº„Éâ„ÅÆË™≠„ÅøËæº„Åø
        async function loadGameCode() {
            // ÊúÄÈÅ©Âåñ„Åï„Çå„ÅüPython„Ç≥„Éº„Éâ„ÇíÂüã„ÇÅËæº„Åø
            const gameModules = {
                'model.pygame_game_state': `import time
from typing import List, Dict, Optional, Callable
from dataclasses import dataclass
import math
import random
try:
    import js
except ImportError:
    # Pyodide„ÅÆjs„É¢„Ç∏„É•„Éº„É´„Åå„Ç§„É≥„Éù„Éº„Éà„Åß„Åç„Å™„ÅÑÂ†¥Âêà„ÅÆ„Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ
    class MockJs:
        def __init__(self):
            self.window = self
            self.Date = self
            self.gameStartTime = 0
        def now(self):
            return int(time.time() * 1000)
        def showRanking(self):
            pass
        @property
        def rankingController(self):
            return self
    js = MockJs()

class PygameBall:
    def __init__(self, x: float = 320, y: float = 240, dx: float = 200, dy: float = 200, 
                 radius: float = 10, color: tuple = (255, 255, 255)):
        self.x = float(x)
        self.y = float(y)
        self.dx = float(dx)
        self.dy = float(dy)
        self.radius = float(radius)
        self.color = color
        self.trail = []
        self.max_trail_length = 10

class PygameRacket:
    def __init__(self, x: float = 295, y: float = 450, size: float = 50, 
                 height: float = 10, color: tuple = (0, 255, 0)):
        self.x = float(x)
        self.y = float(y)
        self.size = float(size)
        self.height = float(height)
        self.color = color
        self.speed = 300
        self.left_bound = 0
        self.right_bound = 640

class PygameScore:
    def __init__(self):
        self.player_score = 0
        self.level = 1
        self.hits = 0
        self.misses = 0
        self.start_time = time.time()

class PygameGameStateObserver:
    def on_game_state_changed(self, game_state: 'PygameGameState'):
        pass

class PygameGameState:
    def __init__(self):
        self.balls = [PygameBall()]
        self.racket = PygameRacket()
        self.score = PygameScore()
        self.is_paused = False
        self.is_gameover = False
        self.observers = []
        self.canvas_width = 640
        self.canvas_height = 480
        
        # „Éû„É´„ÉÅ„Éú„Éº„É´Ê©üËÉΩ
        self.multi_ball_active = False
        self.multi_ball_threshold = 5  # 5ÈÄ£Á∂ö„Éí„ÉÉ„Éà„Åß„Éû„É´„ÉÅ„Éú„Éº„É´Áô∫Âãï
        self.consecutive_hits = 0
        self.max_balls = 3
        
        # „Éë„ÉØ„Éº„Ç¢„ÉÉ„Éó„Ç∑„Çπ„ÉÜ„É†
        self.active_powerups = {}
        self.powerup_spawn_chance = 0.1  # 10%„ÅÆÁ¢∫Áéá
        self.powerup_positions = []  # „Éë„ÉØ„Éº„Ç¢„ÉÉ„Éó„Ç¢„Ç§„ÉÜ„É†„ÅÆÂ∫ßÊ®ô
        
        # ADA (AI Dynamic Adjustment) „Ç∑„Çπ„ÉÜ„É†
        self.ada_system = {
            'miss_count': 0,
            'hit_count': 0,
            'total_attempts': 0,
            'miss_ratio': 0.0,
            'base_ball_speed': 290.0,
            'current_speed_multiplier': 1.0,
            'angle_randomness': 0.0,
            'evaluation_window': 10,  # 10Âõû„ÅÆ„Ç¢„ÇØ„Ç∑„Éß„É≥„ÅßË©ï‰æ°
            'last_evaluation_time': 0,  # „Çø„Ç§„É†„Çπ„Çø„É≥„Éó„Éô„Éº„Çπ„Å´Â§âÊõ¥
            'adjustment_history': []
        }
    
    def add_observer(self, observer: PygameGameStateObserver):
        self.observers.append(observer)
    
    def notify_observers(self):
        for observer in self.observers:
            observer.on_game_state_changed(self)
    
    def evaluate_ada_difficulty(self):
        """ADA„Ç∑„Çπ„ÉÜ„É†„Å´„Çà„ÇãÈõ£ÊòìÂ∫¶Ë©ï‰æ°„Å®Ë™øÊï¥"""
        ada = self.ada_system
        
        # ÂçÅÂàÜ„Å™„Éá„Éº„Çø„ÅåËìÑÁ©ç„Åï„Çå„Åü„ÇâË©ï‰æ°ÂÆüË°å
        if ada['total_attempts'] >= ada['evaluation_window']:
            ada['miss_ratio'] = ada['miss_count'] / ada['total_attempts']
            
            # Ë¶Å‰ª∂ÂÆöÁæ©Êõ∏„Å´Âü∫„Å•„ÅèË™øÊï¥„É´„Éº„É´
            # „Éü„ÇπÁéá > 30% ‚Üí ÈÄüÂ∫¶ -20%
            # „Éü„ÇπÁéá < 10% ‚Üí ÈÄüÂ∫¶ +15%
            old_multiplier = ada['current_speed_multiplier']
            
            if ada['miss_ratio'] > 0.30:
                ada['current_speed_multiplier'] = max(0.5, ada['current_speed_multiplier'] * 0.8)
                ada['angle_randomness'] = max(0.0, ada['angle_randomness'] - 0.1)
            elif ada['miss_ratio'] < 0.10:
                ada['current_speed_multiplier'] = min(2.0, ada['current_speed_multiplier'] * 1.15)
                ada['angle_randomness'] = min(0.3, ada['angle_randomness'] + 0.05)
            
            # Ë™øÊï¥Â±•Ê≠¥„ÇíË®òÈå≤
            adjustment = {
                'miss_ratio': ada['miss_ratio'],
                'speed_change': ada['current_speed_multiplier'] - old_multiplier,
                'new_speed_multiplier': ada['current_speed_multiplier'],
                'angle_randomness': ada['angle_randomness'],
                'timestamp': time.time()
            }
            ada['adjustment_history'].append(adjustment)
            
            # Â±•Ê≠¥„ÅåÈï∑„Åô„Åé„ÇãÂ†¥Âêà„ÅØÂè§„ÅÑ„ÇÇ„ÅÆ„ÇíÂâäÈô§
            if len(ada['adjustment_history']) > 20:
                ada['adjustment_history'].pop(0)
            
            # „Ç´„Ç¶„É≥„Çø„Éº„É™„Çª„ÉÉ„Éà
            ada['miss_count'] = 0
            ada['hit_count'] = 0
            ada['total_attempts'] = 0
            ada['last_evaluation_time'] = time.time()
    
    def record_ada_hit(self):
        """ADA„Ç∑„Çπ„ÉÜ„É†„Å´„Éí„ÉÉ„Éà„ÇíË®òÈå≤"""
        ada = self.ada_system
        ada['hit_count'] += 1
        ada['total_attempts'] += 1
        self.evaluate_ada_difficulty()
    
    def record_ada_miss(self):
        """ADA„Ç∑„Çπ„ÉÜ„É†„Å´„Éü„Çπ„ÇíË®òÈå≤"""
        ada = self.ada_system
        ada['miss_count'] += 1
        ada['total_attempts'] += 1
        self.evaluate_ada_difficulty()
    
    def apply_ada_ball_physics(self, ball):
        """ADA„Ç∑„Çπ„ÉÜ„É†„Å´„Çà„Çã„Éú„Éº„É´Áâ©ÁêÜ„ÅÆË™øÊï¥"""
        ada = self.ada_system
        
        # ÈÄüÂ∫¶Ë™øÊï¥ÔºàÂõ∫ÂÆöÂü∫Ê∫ñÈÄüÂ∫¶„Åã„Çâ„ÅÆÂÄçÁéáË£úÊ≠£Ôºâ
        speed_factor = ada['current_speed_multiplier']
        original_speed = (ball.dx ** 2 + ball.dy ** 2) ** 0.5
        if original_speed > 0:
            # Á¥ØÁ©ç„ÇíÈò≤„Åê„Åü„ÇÅ„ÄÅÂõ∫ÂÆöÂü∫Ê∫ñÈÄüÂ∫¶„Åã„ÇâÁõÆÊ®ôÂÄ§„ÇíÁÆóÂá∫
            target_speed = ada['base_ball_speed'] * speed_factor
            ball.dx = (ball.dx / original_speed) * target_speed
            ball.dy = (ball.dy / original_speed) * target_speed
        
        # ËßíÂ∫¶„Å´„É©„É≥„ÉÄ„É†ÊÄß„ÇíËøΩÂä†
        if ada['angle_randomness'] > 0:
            angle_offset = random.uniform(-ada['angle_randomness'], ada['angle_randomness'])
            current_angle = math.atan2(ball.dy, ball.dx)
            new_angle = current_angle + angle_offset
            
            # Êñ∞„Åó„ÅÑËßíÂ∫¶„ÅßÈÄüÂ∫¶„ÇíÂÜçË®àÁÆó
            speed = (ball.dx ** 2 + ball.dy ** 2) ** 0.5
            ball.dx = math.cos(new_angle) * speed
            ball.dy = math.sin(new_angle) * speed
    
    def activate_multi_ball(self):
        """„Éû„É´„ÉÅ„Éú„Éº„É´„É¢„Éº„Éâ„ÇíÁô∫Âãï"""
        self.multi_ball_active = True
        # Êñ∞„Åó„ÅÑ„Éú„Éº„É´„Çí2„Å§ËøΩÂä†
        for i in range(min(2, self.max_balls - len(self.balls))):
            new_ball = PygameBall(
                x=320 + (i - 0.5) * 100,  # Â∑¶Âè≥„Å´ÈÖçÁΩÆ
                y=240,
                dx=150 * (1 if i == 0 else -1),  # Áï∞„Å™„ÇãÊñπÂêë
                dy=250,
                color=(255, 200, 0) if i == 0 else (0, 200, 255)  # Áï∞„Å™„ÇãËâ≤
            )
            self.balls.append(new_ball)
    
    def activate_powerup(self, powerup_type):
        """„Éë„ÉØ„Éº„Ç¢„ÉÉ„Éó„ÇíÁô∫Âãï"""
        import time
        
        if powerup_type == 'wide_racket':
            self.active_powerups['wide_racket'] = {
                'active': True,
                'start_time': time.time() * 1000,
                'duration': 10000,  # 10Áßí
                'remaining': 10000
            }
            self.racket.size = 100  # „É©„Ç±„ÉÉ„Éà„Çµ„Ç§„Ç∫2ÂÄç
            
        elif powerup_type == 'slow_ball':
            if 'slow_ball' not in self.active_powerups:  # ÈáçË§áÈò≤Ê≠¢
                self.active_powerups['slow_ball'] = {
                    'active': True,
                    'start_time': time.time() * 1000,
                    'duration': 8000,  # 8Áßí
                    'remaining': 8000
                }
                # „Éú„Éº„É´ÈÄüÂ∫¶„Çí30%„Å´Ê∏õÈÄü
                for ball in self.balls:
                    ball.dx *= 0.3
                    ball.dy *= 0.3
                
        elif powerup_type == 'extra_points':
            self.active_powerups['extra_points'] = {
                'active': True,
                'start_time': time.time() * 1000,
                'duration': 15000,  # 15Áßí
                'remaining': 15000
            }
            
        elif powerup_type == 'shield':
            self.active_powerups['shield'] = {
                'active': True,
                'uses': 1  # 1Âõû‰ΩøÁî®ÂèØËÉΩ
            }
    
    def update_powerups(self):
        """„Éë„ÉØ„Éº„Ç¢„ÉÉ„Éó„ÅÆÊôÇÈñìÁÆ°ÁêÜ"""
        import time
        current_time = time.time() * 1000
        
        for powerup_type, powerup in list(self.active_powerups.items()):
            if powerup.get('active', False):
                if 'duration' in powerup:
                    elapsed = current_time - powerup['start_time']
                    powerup['remaining'] = max(0, powerup['duration'] - elapsed)
                    
                    if elapsed >= powerup['duration']:
                        # „Éë„ÉØ„Éº„Ç¢„ÉÉ„ÉóÁµÇ‰∫Ü
                        if powerup_type == 'wide_racket':
                            self.racket.size = 50  # ÂÖÉ„ÅÆ„Çµ„Ç§„Ç∫„Å´Êàª„Åô
                        elif powerup_type == 'slow_ball':
                            # „Éú„Éº„É´ÈÄüÂ∫¶„ÇíÂÖÉ„Å´Êàª„Åô
                            for ball in self.balls:
                                ball.dx /= 0.3
                                ball.dy /= 0.3
                        
                        powerup['active'] = False

    def update_ball_position(self, ball: PygameBall, dt: float = 0.016):
        # ADA„Ç∑„Çπ„ÉÜ„É†„Å´„Çà„ÇãÁâ©ÁêÜË™øÊï¥„ÇíÈÅ©Áî®
        self.apply_ada_ball_physics(ball)
        
        ball.x += ball.dx * dt
        ball.y += ball.dy * dt
        
        if ball.x <= ball.radius or ball.x >= self.canvas_width - ball.radius:
            ball.dx = -ball.dx
        if ball.y <= ball.radius:
            ball.dy = -ball.dy
        if ball.y >= self.canvas_height - ball.radius:
            # „Ç∑„Éº„É´„Éâ„Éë„ÉØ„Éº„Ç¢„ÉÉ„Éó„ÅÆ„ÉÅ„Çß„ÉÉ„ÇØ
            if self.active_powerups.get('shield', {}).get('active', False):
                ball.dy = -abs(ball.dy)  # Ë∑≥„Å≠Ëøî„Åô
                self.active_powerups['shield']['active'] = False  # „Ç∑„Éº„É´„ÉâÊ∂àË≤ª
                # ADA„Ç∑„Çπ„ÉÜ„É†: „Ç∑„Éº„É´„Éâ„Åß„ÅÆÊïëÊ∏à„ÇÇ„Éí„ÉÉ„Éà„Å®„Åó„Å¶Ë®òÈå≤
                self.record_ada_hit()
            else:
                # ADA„Ç∑„Çπ„ÉÜ„É†: „Éü„Çπ„ÇíË®òÈå≤
                self.record_ada_miss()
                self.is_gameover = True
        
        if (ball.y + ball.radius >= self.racket.y and 
            ball.x >= self.racket.x and ball.x <= self.racket.x + self.racket.size):
            ball.dy = -abs(ball.dy)
            self.score.hits += 1
            self.consecutive_hits += 1
            
            # ADA„Ç∑„Çπ„ÉÜ„É†: „Éí„ÉÉ„Éà„ÇíË®òÈå≤
            self.record_ada_hit()
            
            # „Ç®„ÇØ„Çπ„Éà„É©„Éù„Ç§„É≥„ÉàÂäπÊûú
            points = 10
            if self.active_powerups.get('extra_points', {}).get('active', False):
                points *= 2
            self.score.player_score += points
            
            # „Éû„É´„ÉÅ„Éú„Éº„É´Âà§ÂÆö
            if (self.consecutive_hits >= self.multi_ball_threshold and 
                not self.multi_ball_active and len(self.balls) == 1):
                self.activate_multi_ball()
                
            # „Éë„ÉØ„Éº„Ç¢„ÉÉ„Éó„Çπ„Éù„Éº„É≥Âà§ÂÆö
            if random.random() < self.powerup_spawn_chance:
                self.spawn_powerup()
        else:
            # „Éí„ÉÉ„Éà„Åó„Å™„Åã„Å£„ÅüÂ†¥Âêà„ÅØÈÄ£Á∂ö„Éí„ÉÉ„Éà„É™„Çª„ÉÉ„Éà
            if ball.y >= self.canvas_height - ball.radius:
                self.consecutive_hits = 0
        
        # „Éë„ÉØ„Éº„Ç¢„ÉÉ„ÉóÊõ¥Êñ∞
        self.update_powerups()
        
        self.notify_observers()
    
    def spawn_powerup(self):
        """„Éë„ÉØ„Éº„Ç¢„ÉÉ„Éó„Ç¢„Ç§„ÉÜ„É†„Çí„Çπ„Éù„Éº„É≥"""
        powerup_types = ['wide_racket', 'slow_ball', 'extra_points', 'shield']
        powerup_type = random.choice(powerup_types)
        
        powerup_item = {
            'type': powerup_type,
            'x': random.randint(50, self.canvas_width - 50),
            'y': random.randint(100, 300),
            'collected': False
        }
        self.powerup_positions.append(powerup_item)
    
    def check_powerup_collision(self):
        """„Éë„ÉØ„Éº„Ç¢„ÉÉ„Éó„Ç¢„Ç§„ÉÜ„É†„Å®„Éú„Éº„É´„ÅÆË°ùÁ™ÅÂà§ÂÆö"""
        for ball in self.balls:
            for powerup in self.powerup_positions[:]:
                if not powerup['collected']:
                    dist = ((ball.x - powerup['x'])**2 + (ball.y - powerup['y'])**2)**0.5
                    if dist < 20:  # Ë°ùÁ™ÅÂà§ÂÆö
                        powerup['collected'] = True
                        self.activate_powerup(powerup['type'])
                        self.powerup_positions.remove(powerup)
    
    def update_racket_position(self, x: float):
        self.racket.x = max(0, min(x, self.canvas_width - self.racket.size))
        self.notify_observers()`,
                
                'view.optimized_web_game_view': `import json
from typing import Dict, List
# „É¢„Ç∏„É•„Éº„É´„Ç§„É≥„Éù„Éº„Éà„ÇíÂâäÈô§ - Áõ¥Êé•„ÇØ„É©„ÇπÂÆöÁæ©„Çí‰ΩøÁî®

class PygameGameStateObserver:
    def on_game_state_changed(self, game_state):
        pass

class OptimizedWebCanvasView(PygameGameStateObserver):
    def __init__(self, canvas_id: str = "gameCanvas"):
        self.canvas_id = canvas_id
        self.canvas_width = 640
        self.canvas_height = 480
        self.frame_data = {}
        
    def on_game_state_changed(self, game_state: PygameGameState):
        self.frame_data = self._convert_to_canvas_data(game_state)
    
    def _convert_to_canvas_data(self, game_state: PygameGameState) -> Dict:
        draw_commands = []
        
        draw_commands.append({
            'type': 'fillRect',
            'x': 0, 'y': 0,
            'width': self.canvas_width,
            'height': self.canvas_height,
            'color': '#000000'
        })
        
        for ball in game_state.balls:
            draw_commands.append({
                'type': 'fillCircle',
                'x': ball.x, 'y': ball.y,
                'radius': ball.radius,
                'color': f'rgb{ball.color}'
            })
        
        if game_state.racket:
            draw_commands.append({
                'type': 'fillRect',
                'x': game_state.racket.x,
                'y': game_state.racket.y,
                'width': game_state.racket.size,
                'height': game_state.racket.height,
                'color': f'rgb{game_state.racket.color}'
            })
        
        # „Éë„ÉØ„Éº„Ç¢„ÉÉ„Éó„Ç¢„Ç§„ÉÜ„É†„ÅÆÊèèÁîª
        for powerup in game_state.powerup_positions:
            if not powerup['collected']:
                color_map = {
                    'wide_racket': '#00ff00',
                    'slow_ball': '#00ffff',
                    'extra_points': '#ffff00',
                    'shield': '#ff00ff'
                }
                draw_commands.append({
                    'type': 'fillCircle',
                    'x': powerup['x'], 'y': powerup['y'],
                    'radius': 15,
                    'color': color_map.get(powerup['type'], '#ffffff')
                })
                # „Éë„ÉØ„Éº„Ç¢„ÉÉ„Éó„Çø„Ç§„Éó„ÅÆ„ÉÜ„Ç≠„Çπ„Éà
                draw_commands.append({
                    'type': 'fillText',
                    'text': powerup['type'][0].upper(),
                    'x': powerup['x'] - 5, 'y': powerup['y'] + 5,
                    'color': 'black',
                    'font': '12px Arial'
                })
        
        # „Çπ„Ç≥„Ç¢Ë°®Á§∫Ôºà„Éû„É´„ÉÅ„Éú„Éº„É´ÊÉÖÂ†±„ÇÇÂê´„ÇÄÔºâ
        score_text = f'Score: {game_state.score.player_score} | Level: {game_state.score.level}'
        if game_state.multi_ball_active:
            score_text += f' | Multi-Ball! Hits: {game_state.consecutive_hits}'
        elif game_state.consecutive_hits > 0:
            score_text += f' | Combo: {game_state.consecutive_hits}/{game_state.multi_ball_threshold}'
            
        draw_commands.append({
            'type': 'fillText',
            'text': score_text,
            'x': 10, 'y': 30,
            'color': 'white',
            'font': '20px Arial'
        })
        
        # ADA„Ç∑„Çπ„ÉÜ„É†ÊÉÖÂ†±Ë°®Á§∫
        ada = game_state.ada_system
        if ada['total_attempts'] > 0:
            ada_text = f'ADA: Miss {ada["miss_ratio"]:.1%} | Speed x{ada["current_speed_multiplier"]:.2f}'
            if ada['angle_randomness'] > 0:
                ada_text += f' | Angle ¬±{ada["angle_randomness"]:.2f}'
            
            draw_commands.append({
                'type': 'fillText',
                'text': ada_text,
                'x': 10, 'y': 55,
                'color': '#ffff00',
                'font': '14px Arial'
            })
        
        # ADAË™øÊï¥Â±•Ê≠¥„ÅÆË°®Á§∫ÔºàÁõ¥Ëøë„ÅÆË™øÊï¥„ÅÆ„ÅøÔºâ
        if ada['adjustment_history']:
            last_adjustment = ada['adjustment_history'][-1]
            if abs(last_adjustment['speed_change']) > 0.01:
                adjustment_text = f'ADAË™øÊï¥: „Éü„ÇπÁéá{last_adjustment["miss_ratio"]:.1%} ‚Üí '
                if last_adjustment['speed_change'] > 0:
                    adjustment_text += f'Èõ£ÊòìÂ∫¶UP (Speed +{last_adjustment["speed_change"]:.2f})'
                else:
                    adjustment_text += f'Èõ£ÊòìÂ∫¶DOWN (Speed {last_adjustment["speed_change"]:.2f})'
                
                draw_commands.append({
                    'type': 'fillText',
                    'text': adjustment_text,
                    'x': 10, 'y': 75,
                    'color': '#ff8800',
                    'font': '12px Arial'
                })
        
        return {
            'canvas_id': self.canvas_id,
            'draw_commands': draw_commands,
            'game_state': {
                'paused': game_state.is_paused,
                'gameover': game_state.is_gameover
            }
        }
    
    def get_javascript_interface_data(self) -> str:
        return json.dumps(self.frame_data, ensure_ascii=False)`
            };
            
            for (const [moduleName, moduleCode] of Object.entries(gameModules)) {
                pyodide.runPython(moduleCode);
            }
        }
        
        // „Ç≤„Éº„É†Áä∂ÊÖã„ÅÆÂàùÊúüÂåñ
        async function initializeGameState() {
            pyodide.runPython(`
# „É¢„Ç∏„É•„Éº„É´„Ç§„É≥„Éù„Éº„Éà„ÇíÂâäÈô§„Åó„Å¶„ÄÅÁõ¥Êé•„ÇØ„É©„ÇπÂÆöÁæ©„Çí‰ΩøÁî®
game_state = PygameGameState()
game_view = OptimizedWebCanvasView()
game_state.add_observer(game_view)

def update_game(dt=0.016):
    if not game_state.is_paused and not game_state.is_gameover:
        for ball in game_state.balls[:]:  # „Ç≥„Éî„Éº„Çí‰ΩúÊàêÔºàÂâäÈô§„Å´ÂØæÂøúÔºâ
            game_state.update_ball_position(ball, dt)
        
        # „Éë„ÉØ„Éº„Ç¢„ÉÉ„Éó„Ç¢„Ç§„ÉÜ„É†„Å®„ÅÆË°ùÁ™ÅÂà§ÂÆö
        game_state.check_powerup_collision()
        
        # „Ç≤„Éº„É†„Ç™„Éº„Éê„ÉºÊôÇ„Å´„Çπ„Ç≥„Ç¢Ë®òÈå≤
        if game_state.is_gameover:
            check_high_score()
            
    return game_view.get_javascript_interface_data()

def check_high_score():
    """„Ç≤„Éº„É†„Ç™„Éº„Éê„ÉºÊôÇ„ÅÆ„Éè„Ç§„Çπ„Ç≥„Ç¢„ÉÅ„Çß„ÉÉ„ÇØ"""
    # „Éè„Ç§„Çπ„Ç≥„Ç¢„ÅÆÂ†¥Âêà„ÅÆ„Åøpending_high_score_check„ÇíË®≠ÂÆö
    import json
    global pending_high_score_check
    
    # „Çπ„Ç≥„Ç¢„Åå0‰ª•‰∏ã„ÅÆÂ†¥Âêà„ÅØ‰Ωï„ÇÇ„Åó„Å™„ÅÑ
    if game_state.score.player_score <= 0:
        return
    
    # ‰∏ÄÂ∫¶„Å†„Åë„Éè„Ç§„Çπ„Ç≥„Ç¢„ÉÅ„Çß„ÉÉ„ÇØ„ÇíÂÆüË°åÔºàÈáçË§áÈò≤Ê≠¢Ôºâ
    if pending_high_score_check is None:
        pending_high_score_check = json.dumps({
            'score': game_state.score.player_score,
            'combo': game_state.consecutive_hits,
            'powerUps': len([p for p in game_state.active_powerups.values() if p.get("active", False)])
        })
    
def get_pending_high_score():
    """JavaScriptÂÅ¥„Åã„ÇâÂëº„Å≥Âá∫„Åï„Çå„ÇãÈñ¢Êï∞"""
    global pending_high_score_check
    return pending_high_score_check

def get_ada_system_status():
    """ADA„Ç∑„Çπ„ÉÜ„É†„ÅÆÁèæÂú®„ÅÆÁä∂ÊÖã„ÇíÂèñÂæó"""
    import json
    ada = game_state.ada_system
    return json.dumps({
        'miss_ratio': ada['miss_ratio'],
        'speed_multiplier': ada['current_speed_multiplier'],
        'angle_randomness': ada['angle_randomness'],
        'total_attempts': ada['total_attempts'],
        'last_adjustments': ada['adjustment_history'][-5:] if ada['adjustment_history'] else []
    })

pending_high_score_check = None

def handle_key_input(key):
    if key == 'ArrowLeft' and game_state.racket.x > 0:
        game_state.update_racket_position(game_state.racket.x - 20)
    elif key == 'ArrowRight' and game_state.racket.x < 590:
        game_state.update_racket_position(game_state.racket.x + 20)
    elif key == ' ':
        game_state.is_paused = not game_state.is_paused
    elif key == 'r' or key == 'R':
        restart_game()
    elif key == 'h' or key == 'H':
        # „É©„É≥„Ç≠„É≥„Ç∞Ë°®Á§∫„ÇíJavaScript„ÅßÂÆüË°å
        js.window.rankingController.showRanking()
        return None
    elif key == 'p' or key == 'P':
        # „Éë„ÉØ„Éº„Ç¢„ÉÉ„ÉóË°®Á§∫Âàá„ÇäÊõø„Åà„ÇíJavaScript„ÅßÂÆüË°å
        return 'toggle_powerup'
    return None

def restart_game():
    global game_state, pending_high_score_check
    pending_high_score_check = None  # „É™„Çπ„Çø„Éº„ÉàÊôÇ„Å´„Éè„Ç§„Çπ„Ç≥„Ç¢„ÉÅ„Çß„ÉÉ„ÇØ„Çí„ÇØ„É™„Ç¢
    game_state = PygameGameState()
    game_state.add_observer(game_view)
    # ADA„Ç∑„Çπ„ÉÜ„É†„ÇÇÊñ∞„Åó„ÅÑ„Ç≤„Éº„É†Áä∂ÊÖã„ÅßÂàùÊúüÂåñ„Åï„Çå„Çã
    # JavaScriptÂÅ¥„ÅÆ„Ç≤„Éº„É†ÈñãÂßãÊôÇÂàª„ÇíÊõ¥Êñ∞
    js.gameStartTime = js.Date.now()
            `);
        }
        
        // CanvasÊèèÁîªÈñ¢Êï∞
        function drawFrame(frameData) {
            try {
                const data = JSON.parse(frameData);
                const commands = data.draw_commands || [];
                
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                
                // „Ç¨„É≥„ÉûË£úÊ≠£„ÇíÈÅ©Áî®
                if (accessibilitySettings.gamma !== 1.0) {
                    ctx.filter = `brightness(${accessibilitySettings.gamma})`;
                } else {
                    ctx.filter = 'none';
                }
                
                const colors = accessibilitySettings.highContrast ? 
                              accessibilitySettings.canvasColors.highContrast : 
                              accessibilitySettings.canvasColors.standard;
                
                for (const cmd of commands) {
                    switch (cmd.type) {
                        case 'fillRect':
                            // ËÉåÊôØ„ÅÆÂ†¥Âêà„ÅØË®≠ÂÆöËâ≤„Çí‰ΩøÁî®
                            if (cmd.width === canvas.width && cmd.height === canvas.height) {
                                ctx.fillStyle = colors.background;
                            } else {
                                ctx.fillStyle = cmd.color;
                                // È´ò„Ç≥„É≥„Éà„É©„Çπ„Éà„É¢„Éº„Éâ„Åß„É©„Ç±„ÉÉ„Éà„ÅÆÂ†¥Âêà
                                if (accessibilitySettings.highContrast && cmd.color.includes('0, 255, 0')) {
                                    ctx.fillStyle = colors.racket;
                                }
                            }
                            ctx.fillRect(cmd.x, cmd.y, cmd.width, cmd.height);
                            break;
                        case 'fillCircle':
                            ctx.fillStyle = cmd.color;
                            // È´ò„Ç≥„É≥„Éà„É©„Çπ„Éà„É¢„Éº„Éâ„Åß„ÅÆËâ≤Â§âÊõ¥
                            if (accessibilitySettings.highContrast) {
                                // „Éë„ÉØ„Éº„Ç¢„ÉÉ„Éó„Ç¢„Ç§„ÉÜ„É†„ÅÆÂ†¥Âêà
                                if (cmd.radius === 15) {
                                    ctx.fillStyle = colors.powerupColors.wide_racket;
                                } else {
                                    // „Éú„Éº„É´„ÅÆÂ†¥Âêà
                                    ctx.fillStyle = colors.ball;
                                }
                            }
                            ctx.beginPath();
                            ctx.arc(cmd.x, cmd.y, cmd.radius, 0, 2 * Math.PI);
                            ctx.fill();
                            break;
                        case 'fillText':
                            ctx.fillStyle = accessibilitySettings.highContrast ? colors.text : cmd.color;
                            ctx.font = cmd.font;
                            ctx.fillText(cmd.text, cmd.x, cmd.y);
                            break;
                    }
                }
            } catch (error) {
                console.error('Draw error:', error);
            }
        }
        
        // „Ç≤„Éº„É†„É´„Éº„Éó
        function gameLoop() {
            try {
                const frameData = pyodide.runPython('update_game()');
                drawFrame(frameData);
                performanceMonitor.update();
                
                // „Çµ„Ç¶„É≥„Éâ„Ç§„Éô„É≥„ÉàÂá¶ÁêÜ
                if (soundSystem && frameData) {
                    soundSystem.processSoundEvents(frameData);
                }
                
                // „Éë„ÉØ„Éº„Ç¢„ÉÉ„ÉóË°®Á§∫„ÇíÂÆöÊúüÁöÑ„Å´Êõ¥Êñ∞
                if (Math.random() < 0.1) { // 10%„ÅÆÁ¢∫Áéá„ÅßÊõ¥Êñ∞ÔºàË≤†Ëç∑ËªΩÊ∏õÔºâ
                    updatePowerupDisplay();
                }
                
                // „Éè„Ç§„Çπ„Ç≥„Ç¢„ÉÅ„Çß„ÉÉ„ÇØ
                checkPendingHighScore();
                
                // ADA„Ç∑„Çπ„ÉÜ„É†„Éá„Éê„ÉÉ„Ç∞ÊÉÖÂ†±„ÅÆÊõ¥Êñ∞ÔºàÈñãÁô∫ËÄÖ„É¢„Éº„Éâ„Éª5FPS„Å´Âà∂ÈôêÔºâ
                if (window.location.hash === '#debug') {
                    const now = Date.now();
                    if (now - debugUpdateTimer >= DEBUG_UPDATE_INTERVAL) {
                        updateADADebugInfo();
                        debugUpdateTimer = now;
                    }
                }
            } catch (error) {
                console.error('Game loop error:', error);
            }
            
            gameLoopId = requestAnimationFrame(gameLoop);
        }
        
        // ‰øùÁïô‰∏≠„ÅÆ„Éè„Ç§„Çπ„Ç≥„Ç¢„ÉÅ„Çß„ÉÉ„ÇØ„ÇíÂá¶ÁêÜ
        function checkPendingHighScore() {
            try {
                const pending = pyodide.runPython('get_pending_high_score()');
                if (pending && pending !== 'None' && pending !== 'null') {
                    const scoreData = JSON.parse(pending);
                    // ÂÆüÈöõ„Å´„Éè„Ç§„Çπ„Ç≥„Ç¢„Åã„Å©„ÅÜ„Åã„ÉÅ„Çß„ÉÉ„ÇØ
                    if (scoreRanking && scoreRanking.isHighScore(scoreData.score)) {
                        showNameInputModal(scoreData);
                    }
                    // „Éè„Ç§„Çπ„Ç≥„Ç¢„Åß„ÇÇ„Åù„ÅÜ„Åß„Å™„Åè„Å¶„ÇÇ„ÄÅ„ÉÅ„Çß„ÉÉ„ÇØÊ∏à„Åø„Å™„ÅÆ„ÅßPythonÂÅ¥„Åß„ÇØ„É™„Ç¢
                    pyodide.runPython('pending_high_score_check = None');
                }
            } catch (error) {
                // pending_high_score_check„ÅåNone„ÅÆÂ†¥Âêà„ÅØÊ≠£Â∏∏„Å™Âãï‰Ωú
                console.debug('High score check skipped:', error.message);
            }
        }
        
        function startGameLoop() {
            if (gameLoopId) {
                cancelAnimationFrame(gameLoopId);
            }
            gameLoopId = requestAnimationFrame(gameLoop);
        }
        
        // „Çµ„Ç¶„É≥„Éâ„ÅÆÂàá„ÇäÊõø„ÅàÈñ¢Êï∞
        function toggleSound() {
            if (soundSystem) {
                const newMuteState = !soundSystem.muted;
                soundSystem.setMuted(newMuteState);
                
                const button = document.getElementById('soundToggle');
                if (button) {
                    if (newMuteState) {
                        button.textContent = 'üîá „Çµ„Ç¶„É≥„Éâ OFF';
                        button.style.opacity = '0.6';
                    } else {
                        button.textContent = 'üîä „Çµ„Ç¶„É≥„Éâ ON';
                        button.style.opacity = '1.0';
                    }
                }
            }
        }
        
        // WebSocketÊé•Á∂ö„Çπ„ÉÜ„Éº„Çø„ÇπÊõ¥Êñ∞
        function updateConnectionStatus(status) {
            const statusElement = document.getElementById('connectionStatus');
            if (statusElement) {
                switch (status) {
                    case 'connected':
                        statusElement.textContent = 'üü¢ Êé•Á∂ö‰∏≠';
                        statusElement.style.color = '#4ecdc4';
                        break;
                    case 'connecting':
                        statusElement.textContent = 'üü° Êé•Á∂ö‰∏≠...';
                        statusElement.style.color = '#ffc107';
                        break;
                    case 'disconnected':
                    default:
                        statusElement.textContent = 'üî¥ Êú™Êé•Á∂ö';
                        statusElement.style.color = '#ff6b6b';
                        break;
                }
            }
        }
        
        // „ÉÅ„É£„É¨„É≥„Ç∏„É°„Éã„É•„Éº„ÅÆÈñãÈñâ
        function openChallengeMenu() {
            const menu = document.getElementById('challengeMenu');
            if (menu) {
                menu.style.display = 'block';
                // Âà©Áî®ÂèØËÉΩ„Å™„ÉÅ„É£„É¨„É≥„Ç∏„É™„Çπ„Éà„ÇíË™≠„ÅøËæº„Åø
                loadChallengeList();
            }
        }
        
        function closeChallengeMenu() {
            const menu = document.getElementById('challengeMenu');
            if (menu) {
                menu.style.display = 'none';
            }
        }
        
        // „ÉÅ„É£„É¨„É≥„Ç∏„É™„Çπ„Éà„ÅÆË™≠„ÅøËæº„Åø
        function loadChallengeList() {
            const challengeList = document.getElementById('challengeList');
            if (challengeList) {
                challengeList.innerHTML = `
                    <div class="challenge-item">
                        <p>„Éè„Ç§„Çπ„Ç≥„Ç¢„ÉÅ„É£„É¨„É≥„Ç∏: 100ÁÇπ‰ª•‰∏ä</p>
                        <button onclick="startChallenge('high_score', {target: 100})">ÈñãÂßã</button>
                    </div>
                    <div class="challenge-item">
                        <p>ÈÄüÂ∫¶„ÉÅ„É£„É¨„É≥„Ç∏: 30Áßí‰ª•ÂÜÖ</p>
                        <button onclick="startChallenge('time_limit', {limit: 30})">ÈñãÂßã</button>
                    </div>
                    <div class="challenge-item">
                        <p>Á≤æÂ∫¶„ÉÅ„É£„É¨„É≥„Ç∏: „Éü„Çπ5Âõû‰ª•‰∏ã</p>
                        <button onclick="startChallenge('accuracy', {maxMisses: 5})">ÈñãÂßã</button>
                    </div>
                `;
            }
        }
        
        // „É©„É≥„ÉÄ„É†„ÉÅ„É£„É¨„É≥„Ç∏„ÅÆË™≠„ÅøËæº„Åø
        function loadRandomChallenge() {
            const challenges = [
                { type: 'high_score', params: { target: Math.floor(Math.random() * 100) + 50 } },
                { type: 'time_limit', params: { limit: Math.floor(Math.random() * 30) + 20 } },
                { type: 'accuracy', params: { maxMisses: Math.floor(Math.random() * 10) + 3 } }
            ];
            
            const randomChallenge = challenges[Math.floor(Math.random() * challenges.length)];
            startChallenge(randomChallenge.type, randomChallenge.params);
        }
        
        // „ÉÅ„É£„É¨„É≥„Ç∏„ÅÆÈñãÂßã
        function startChallenge(type, params) {
            // „Éá„Éê„ÉÉ„Ç∞„É¢„Éº„ÉâÂà∂Âæ°
            const DEBUG = false;
            if (DEBUG) {
                console.log(`üèÜ „ÉÅ„É£„É¨„É≥„Ç∏ÈñãÂßã: ${type}`, params);
            }
            
            // „ÉÅ„É£„É¨„É≥„Ç∏„Éá„Éº„Çø„ÇíWebSocket„ÅßÈÄÅ‰ø°ÔºàÂÆüË£Ö‰∫àÂÆöÔºâ
            if (window.pythonBridge && window.pythonBridge.sendMessage) {
                window.pythonBridge.sendMessage({
                    type: 'challenge_start',
                    challenge: { type, params }
                });
            }
            
            // „É°„Éã„É•„Éº„ÇíÈñâ„Åò„Çã
            closeChallengeMenu();
            
            // UI „Éï„Ç£„Éº„Éâ„Éê„ÉÉ„ÇØ
            const button = document.getElementById('challengeButton');
            if (button) {
                button.textContent = `üèÜ ${type} ÂÆüË°å‰∏≠`;
                button.style.background = 'rgba(40, 167, 69, 0.9)';
            }
        }
        
        // WebSocketÊé•Á∂ö„ÅÆÂàùÊúüÂåñ„ÇíË©¶Ë°å
        async function initializeWebSocketConnection() {
            // „Éá„Éê„ÉÉ„Ç∞„É¢„Éº„ÉâÂà∂Âæ°ÔºàÊú¨Áï™Áí∞Â¢É„Åß„ÅØfalse„Å´Ë®≠ÂÆöÔºâ
            const DEBUG = false;
            const log = DEBUG ? console.log : () => {};
            
            log('üîå initializeWebSocketConnection „ÅåÂëº„Å≥Âá∫„Åï„Çå„Åæ„Åó„Åü');
            
            try {
                log('üì° Êé•Á∂ö„Çπ„ÉÜ„Éº„Çø„Çπ„Çí"connecting"„Å´Êõ¥Êñ∞‰∏≠...');
                updateConnectionStatus('connecting');
                
                log('üì¶ Python-JS Bridge„Çí„Ç§„É≥„Éù„Éº„Éà‰∏≠...');
                // Python-JS Bridge „ÇíÂãïÁöÑ„Å´„Ç§„É≥„Éù„Éº„Éà
                const { PythonJSBridge } = await import('./js/bridge/python-js-bridge.js');
                log('‚úÖ Python-JS Bridge„Ç§„É≥„Éù„Éº„ÉàÊàêÂäü');
                
                pythonBridge = new PythonJSBridge();
                log('üîó PythonJSBridge„Ç§„É≥„Çπ„Çø„É≥„Çπ‰ΩúÊàêÂÆå‰∫Ü');
                
                // WebSocketÊé•Á∂ö„ÇíË©¶Ë°å
                log('üåê WebSocketÊé•Á∂ö„ÇíË©¶Ë°å‰∏≠...');
                await pythonBridge.connect();
                log('WebSocketÊé•Á∂öÊàêÂäü„ÄÅ„Çπ„ÉÜ„Éº„Çø„Çπ„ÇíÊõ¥Êñ∞‰∏≠...');
                updateConnectionStatus('connected');
                log('„Çπ„ÉÜ„Éº„Çø„ÇπÊõ¥Êñ∞ÂÆå‰∫Ü');
                
                // „Ç∞„É≠„Éº„Éê„É´„Å´Ë®≠ÂÆö
                window.pythonBridge = pythonBridge;
                
                log('‚úÖ WebSocketÊé•Á∂ö„ÅåÁ¢∫Á´ã„Åï„Çå„Åæ„Åó„Åü');
                
                // „ÉÅ„É£„É¨„É≥„Ç∏„Éû„Éç„Éº„Ç∏„É£„Éº„ÅÆÂàùÊúüÂåñÔºàÊé•Á∂öÁä∂ÊÖã„Å´Èñ¢„Çè„Çâ„Åö‰∏ÄÂ∫¶„Å†„ÅëÂÆüË°åÔºâ
                await initializeChallengeManager(log);
                
            } catch (error) {
                console.error('‚ùå WebSocketÊé•Á∂ö„Ç®„É©„Éº:', error);
                updateConnectionStatus('disconnected');
                
                // „Ç™„Éï„É©„Ç§„É≥„É¢„Éº„Éâ„Åß„ÇÇÂü∫Êú¨Ê©üËÉΩ„ÅØÂà©Áî®ÂèØËÉΩ
                await initializeChallengeManager(log);
            }
        }
        
        // „ÉÅ„É£„É¨„É≥„Ç∏„Éû„Éç„Éº„Ç∏„É£„Éº„ÅÆÂàùÊúüÂåñ„ÇíÂÖ±ÈÄöÂåñ
        async function initializeChallengeManager(log = console.log) {
            if (window.challengeManager) {
                log('‚úÖ „ÉÅ„É£„É¨„É≥„Ç∏„Éû„Éç„Éº„Ç∏„É£„Éº„ÅØÊó¢„Å´ÂàùÊúüÂåñ„Åï„Çå„Å¶„ÅÑ„Åæ„Åô');
                return;
            }
            
            try {
                log('üéØ „ÉÅ„É£„É¨„É≥„Ç∏„Éû„Éç„Éº„Ç∏„É£„Éº„ÇíÂàùÊúüÂåñ‰∏≠...');
                const { ChallengeGenerator } = await import('./js/weekly-challenge.js');
                challengeManager = new ChallengeGenerator();
                window.challengeManager = challengeManager;
                log('‚úÖ „ÉÅ„É£„É¨„É≥„Ç∏„Éû„Éç„Éº„Ç∏„É£„Éº„ÅåÂàùÊúüÂåñ„Åï„Çå„Åæ„Åó„Åü');
            } catch (challengeError) {
                console.warn('‚ö†Ô∏è „ÉÅ„É£„É¨„É≥„Ç∏„Éû„Éç„Éº„Ç∏„É£„Éº„ÅÆÂàùÊúüÂåñ„Å´Â§±Êïó:', challengeError.message);
                // „É¶„Éº„Ç∂„Éº„Å∏„ÅÆ„Éï„Ç£„Éº„Éâ„Éê„ÉÉ„ÇØÔºàÈùû‰æµË•≤ÁöÑ„Å™ÈÄöÁü•Ôºâ
                if (window.showNotification && typeof window.showNotification === 'function') {
                    window.showNotification('‰∏ÄÈÉ®„ÅÆÊ©üËÉΩ„ÅåÂà©Áî®„Åß„Åç„Åæ„Åõ„Çì', 'warning');
                }
            }
        }
        
        // ADA„Éá„Éê„ÉÉ„Ç∞Êõ¥Êñ∞Áî®„ÅÆ„Çø„Ç§„Éû„ÉºÂ§âÊï∞
        let debugUpdateTimer = 0;
        const DEBUG_UPDATE_INTERVAL = 200; // 200ms = 5FPS
        
        // ADA„Ç∑„Çπ„ÉÜ„É†„Éá„Éê„ÉÉ„Ç∞ÊÉÖÂ†±„ÅÆÊõ¥Êñ∞
        function updateADADebugInfo(forceUpdate = false) {
            try {
                const adaStatus = JSON.parse(pyodide.runPython('get_ada_system_status()'));
                
                // „Éá„Éê„ÉÉ„Ç∞ÊÉÖÂ†±„ÅÆË°®Á§∫„Ç®„É™„Ç¢„Çí‰ΩúÊàê„Åæ„Åü„ÅØÊõ¥Êñ∞
                let debugPanel = document.getElementById('ada-debug-panel');
                if (!debugPanel) {
                    debugPanel = document.createElement('div');
                    debugPanel.id = 'ada-debug-panel';
                    debugPanel.style.cssText = `
                        position: fixed;
                        top: 100px;
                        right: 20px;
                        background: rgba(0, 0, 0, 0.8);
                        color: white;
                        padding: 10px;
                        border-radius: 5px;
                        font-family: monospace;
                        font-size: 12px;
                        z-index: 1000;
                        max-width: 300px;
                    `;
                    document.body.appendChild(debugPanel);
                }
                
                // ADA„Ç∑„Çπ„ÉÜ„É†„ÅÆÁä∂ÊÖãÊÉÖÂ†±„ÇíË°®Á§∫
                debugPanel.innerHTML = `
                    <h4>ADA Debug Info</h4>
                    <p>Miss Ratio: ${(adaStatus.miss_ratio * 100).toFixed(1)}%</p>
                    <p>Speed Multiplier: ${adaStatus.speed_multiplier.toFixed(2)}</p>
                    <p>Angle Randomness: ${adaStatus.angle_randomness.toFixed(2)}</p>
                    <p>Total Attempts: ${adaStatus.total_attempts}</p>
                    <h5>Recent Adjustments:</h5>
                    <ul>
                        ${adaStatus.last_adjustments.map(adj => 
                            `<li>Miss: ${(adj.miss_ratio * 100).toFixed(1)}% ‚Üí Speed: ${adj.new_speed_multiplier.toFixed(2)}</li>`
                        ).join('')}
                    </ul>
                `;
            } catch (error) {
                console.debug('ADA debug info update error:', error);
            }
        }
        
        // „Ç≠„Éº„Éú„Éº„Éâ„Ç§„Éô„É≥„Éà
        document.addEventListener('keydown', function(event) {
            // A„Ç≠„Éº„Åß„Ç¢„ÇØ„Çª„Ç∑„Éì„É™„ÉÜ„Ç£„Éë„Éç„É´„ÅÆ„Éà„Ç∞„É´
            if (event.key === 'a' || event.key === 'A') {
                toggleAccessibilityPanel();
                return;
            }
            
            if (pyodide) {
                try {
                    const result = pyodide.runPython(`handle_key_input('${event.key}')`);
                    
                    // ÁâπÊÆä„Å™„Ç¢„ÇØ„Ç∑„Éß„É≥„ÅÆÂá¶ÁêÜ
                    if (result === 'show_ranking') {
                        showRankingModal();
                    } else if (result === 'toggle_powerup') {
                        togglePowerupDisplay();
                    }
                    
                    // R„Ç≠„Éº„Åß„É™„Çπ„Çø„Éº„Éà„Åó„ÅüÂ†¥Âêà„ÄÅJavaScriptÂÅ¥„Åß„ÇÇÁ¢∫ÂÆü„Å´„ÇØ„É™„Ç¢
                    if (event.key === 'r' || event.key === 'R') {
                        pyodide.runPython('pending_high_score_check = None');
                    }
                } catch (error) {
                    console.error('Key input error:', error);
                }
            }
        });
        
        // „Çø„ÉÉ„ÉÅ„Ç§„Éô„É≥„Éà„ÅÆË®≠ÂÆö
        function setupTouchEvents() {
            if (!canvas) return;
            
            // Êó¢Â≠ò„ÅÆ„Ç§„Éô„É≥„Éà„É™„Çπ„Éä„Éº„Çí„ÇØ„É™„Éº„É≥„Ç¢„ÉÉ„Éó
            if (window.touchEventCleanup) {
                window.touchEventCleanup();
            }
            
            let touchStartX = null;
            let touchStartTime = null;
            
            const touchStartHandler = function(event) {
                event.preventDefault();
                const touch = event.touches[0];
                const rect = canvas.getBoundingClientRect();
                touchStartX = touch.clientX - rect.left;
                touchStartTime = Date.now();
                
                // „Çø„ÉÉ„ÉÅ‰ΩçÁΩÆ„Å´Âü∫„Å•„ÅÑ„Å¶„É©„Ç±„ÉÉ„Éà„ÇíÁßªÂãï
                if (pyodide) {
                    try {
                        const racketX = Math.max(0, Math.min(touchStartX - 30, canvas.width - 60));
                        pyodide.runPython(`game_state.update_racket_position(${racketX})`);
                    } catch (error) {
                        console.error('Touch input error:', error);
                    }
                }
            };
            
            const touchMoveHandler = function(event) {
                event.preventDefault();
                const touch = event.touches[0];
                const rect = canvas.getBoundingClientRect();
                const touchX = touch.clientX - rect.left;
                
                // „Çø„ÉÉ„ÉÅÁßªÂãï„Å´ËøΩÂæì„Åó„Å¶„É©„Ç±„ÉÉ„Éà„ÇíÁßªÂãï
                if (pyodide) {
                    try {
                        const racketX = Math.max(0, Math.min(touchX - 30, canvas.width - 60));
                        pyodide.runPython(`game_state.update_racket_position(${racketX})`);
                    } catch (error) {
                        console.error('Touch move error:', error);
                    }
                }
            };
            
            const touchEndHandler = function(event) {
                event.preventDefault();
                
                // touchStartTime„Åånull„ÅÆÂ†¥Âêà„ÅØÊó©Êúü„É™„Çø„Éº„É≥
                if (touchStartTime === null) return;
                
                const touchEndTime = Date.now();
                const touchDuration = touchEndTime - touchStartTime;
                
                // „ÉÄ„Éñ„É´„Çø„ÉÉ„Éó„Åß„Ç≤„Éº„É†ÂÜçÈñã/‰∏ÄÊôÇÂÅúÊ≠¢
                if (touchDuration < 300) {
                    if (event.timeStamp - (window.lastTapTime || 0) < 300) {
                        // „ÉÄ„Éñ„É´„Çø„ÉÉ„ÉóÊ§úÂá∫
                        if (pyodide) {
                            try {
                                pyodide.runPython('game_state.is_paused = not game_state.is_paused');
                            } catch (error) {
                                console.error('Double tap error:', error);
                            }
                        }
                    }
                    window.lastTapTime = event.timeStamp;
                }
                
                // „É™„Çª„ÉÉ„Éà
                touchStartX = null;
                touchStartTime = null;
            };
            
            canvas.addEventListener('touchstart', touchStartHandler);
            canvas.addEventListener('touchmove', touchMoveHandler);
            canvas.addEventListener('touchend', touchEndHandler);
            
            // „ÇØ„É™„Éº„É≥„Ç¢„ÉÉ„ÉóÈñ¢Êï∞„Çí‰øùÂ≠ò
            window.touchEventCleanup = function() {
                canvas.removeEventListener('touchstart', touchStartHandler);
                canvas.removeEventListener('touchmove', touchMoveHandler);
                canvas.removeEventListener('touchend', touchEndHandler);
            };
        }
        
        // „É¢„Éê„Ç§„É´„Ç≥„É≥„Éà„É≠„Éº„É´„Éú„Çø„É≥„ÅÆËøΩÂä†
        function addMobileControls() {
            const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
            
            // Êó¢Â≠ò„ÅÆ„Ç≥„É≥„Éà„É≠„Éº„É´„Éë„Éç„É´„Çí„ÉÅ„Çß„ÉÉ„ÇØ
            if (isMobile && !document.getElementById('mobileControls')) {
                // „É¢„Éê„Ç§„É´„Ç≥„É≥„Éà„É≠„Éº„É´„Éë„Éç„É´„Çí‰ΩúÊàê
                const controlPanel = document.createElement('div');
                controlPanel.id = 'mobileControls';
                controlPanel.style.cssText = `
                    position: fixed;
                    bottom: 20px;
                    left: 50%;
                    transform: translateX(-50%);
                    display: flex;
                    gap: 10px;
                    z-index: 1000;
                `;
                
                // „É™„Çπ„Çø„Éº„Éà„Éú„Çø„É≥
                const restartBtn = document.createElement('button');
                restartBtn.textContent = 'üîÑ „É™„Çπ„Çø„Éº„Éà';
                restartBtn.setAttribute('aria-label', '„Ç≤„Éº„É†„Çí„É™„Çπ„Çø„Éº„Éà');
                restartBtn.style.cssText = `
                    padding: 10px 20px;
                    font-size: 16px;
                    background: #007BFF;
                    color: white;
                    border: none;
                    border-radius: 5px;
                    touch-action: manipulation;
                `;
                restartBtn.addEventListener('click', function() {
                    if (pyodide) {
                        pyodide.runPython('restart_game()');
                        pyodide.runPython('pending_high_score_check = None');
                    }
                });
                
                // „É©„É≥„Ç≠„É≥„Ç∞„Éú„Çø„É≥
                const rankingBtn = document.createElement('button');
                rankingBtn.textContent = 'üèÜ „É©„É≥„Ç≠„É≥„Ç∞';
                rankingBtn.setAttribute('aria-label', '„É©„É≥„Ç≠„É≥„Ç∞„ÇíË°®Á§∫');
                rankingBtn.style.cssText = `
                    padding: 10px 20px;
                    font-size: 16px;
                    background: #28A745;
                    color: white;
                    border: none;
                    border-radius: 5px;
                    touch-action: manipulation;
                `;
                rankingBtn.addEventListener('click', function() {
                    showRankingModal();
                });
                
                controlPanel.appendChild(restartBtn);
                controlPanel.appendChild(rankingBtn);
                document.body.appendChild(controlPanel);
                
                // „Ç≤„Éº„É†Ë™¨Êòé„Å´„Çø„ÉÉ„ÉÅÊìç‰Ωú„ÅÆË™¨Êòé„ÇíËøΩÂä†ÔºàÊó¢Â≠ò„ÅÆË™¨Êòé„Åå„Å™„ÅÑÂ†¥Âêà„ÅÆ„ÅøÔºâ
                if (!document.getElementById('touchHelp')) {
                    const touchHelp = document.createElement('div');
                    touchHelp.id = 'touchHelp';
                    touchHelp.style.cssText = `
                        position: absolute;
                        top: 65px;
                        left: 10px;
                        color: #999;
                        font-size: 12px;
                    `;
                    touchHelp.textContent = '„Çø„ÉÉ„ÉÅ: „É©„Ç±„ÉÉ„ÉàÁßªÂãï | „ÉÄ„Éñ„É´„Çø„ÉÉ„Éó: ‰∏ÄÊôÇÂÅúÊ≠¢';
                    canvas.parentElement.appendChild(touchHelp);
                }
            }
        }
        
        // „Ç¶„Ç£„É≥„Éâ„Ç¶„Éï„Ç©„Éº„Ç´„ÇπÁÆ°ÁêÜ
        document.addEventListener('visibilitychange', function() {
            if (document.hidden && pyodide) {
                pyodide.runPython('game_state.is_paused = True');
            }
        });
        
        // „Ç®„É©„Éº„Éè„É≥„Éâ„É©„Éº
        window.addEventListener('error', function(event) {
            showError('‰∫àÊúü„Åó„Å™„ÅÑ„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü', event.error?.message || '');
        });
        
        window.addEventListener('unhandledrejection', function(event) {
            showError('„Éç„ÉÉ„Éà„ÉØ„Éº„ÇØ„Ç®„É©„Éº„Åæ„Åü„ÅØË™≠„ÅøËæº„Åø„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü', event.reason);
        });
        
        // „Ç≤„Éº„É†ÂàùÊúüÂåñÈñãÂßã
        initializeGame();
        
        // PWA„Ç§„É≥„Çπ„Éà„Éº„É´Èñ¢Êï∞
        let deferredPrompt;
        
        async function installPWA() {
            if (deferredPrompt) {
                // „Ç§„É≥„Çπ„Éà„Éº„É´„Éó„É≠„É≥„Éó„Éà„ÇíË°®Á§∫
                deferredPrompt.prompt();
                
                // „É¶„Éº„Ç∂„Éº„ÅÆÈÅ∏Êäû„ÇíÂæÖ„Å§
                const { outcome } = await deferredPrompt.userChoice;
                console.log(`User response to install prompt: ${outcome}`);
                
                // ‰ΩøÁî®Ê∏à„Åø„ÅÆ„Éó„É≠„É≥„Éó„Éà„Çí„ÇØ„É™„Ç¢
                deferredPrompt = null;
                document.getElementById('installButton').style.display = 'none';
            }
        }
        
        // Service WorkerÊõ¥Êñ∞ÈÄöÁü•ÔºàÊó¢„Å´‰∏äÈÉ®„ÅßÁôªÈå≤Ê∏à„ÅøÔºâ
        if ('serviceWorker' in navigator && navigator.serviceWorker.controller) {
            navigator.serviceWorker.addEventListener('controllerchange', () => {
                // Service Worker„ÅåÊõ¥Êñ∞„Åï„Çå„ÅüÂ†¥Âêà
                console.log('Service Worker updated');
            });
            
            // PWA„Ç§„É≥„Çπ„Éà„Éº„É´„Éó„É≠„É≥„Éó„ÉàÂá¶ÁêÜ
            window.addEventListener('beforeinstallprompt', (e) => {
                // „Éá„Éï„Ç©„É´„Éà„ÅÆ„Ç§„É≥„Çπ„Éà„Éº„É´„Éó„É≠„É≥„Éó„Éà„ÇíÈò≤„Åê
                e.preventDefault();
                // Âæå„ÅßË°®Á§∫„Åô„Çã„Åü„ÇÅ„Å´‰øùÂ≠ò
                deferredPrompt = e;
                
                // „Ç§„É≥„Çπ„Éà„Éº„É´„Éú„Çø„É≥„ÇíË°®Á§∫Ôºà„ÇÇ„Åó„ÅÇ„Çå„Å∞Ôºâ
                const installButton = document.getElementById('installButton');
                if (installButton) {
                    installButton.style.display = 'block';
                    
                    installButton.addEventListener('click', async () => {
                        if (deferredPrompt) {
                            // „Ç§„É≥„Çπ„Éà„Éº„É´„Éó„É≠„É≥„Éó„Éà„ÇíË°®Á§∫
                            deferredPrompt.prompt();
                            
                            // „É¶„Éº„Ç∂„Éº„ÅÆÈÅ∏Êäû„ÇíÂæÖ„Å§
                            const { outcome } = await deferredPrompt.userChoice;
                            console.log(`User response to install prompt: ${outcome}`);
                            
                            // ‰ΩøÁî®Ê∏à„Åø„ÅÆ„Éó„É≠„É≥„Éó„Éà„Çí„ÇØ„É™„Ç¢
                            deferredPrompt = null;
                            installButton.style.display = 'none';
                        }
                    });
                }
            });
            
            // PWA„Ç§„É≥„Çπ„Éà„Éº„É´ÊàêÂäüÊôÇ„ÅÆÂá¶ÁêÜ
            window.addEventListener('appinstalled', () => {
                console.log('Ultimate Squash Game was installed');
                // Google AnalyticsÁ≠â„Åß„Éà„É©„ÉÉ„Ç≠„É≥„Ç∞Ôºà„Ç™„Éó„Ç∑„Éß„É≥Ôºâ
            });
        }
    </script>
</body>
</html>