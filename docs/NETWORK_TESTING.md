# ネットワーク条件テストガイド

## 概要
このドキュメントでは、Ultimate Squash Gameの様々なネットワーク状況下での動作を検証するテストについて説明します。

## テスト範囲

### 1. 低速ネットワーク環境
- **3G回線**: 1.6Mbps下り、750kbps上り、150msレイテンシ
- **低速WiFi**: 512kbps下り、256kbps上り、100msレイテンシ
- **2G回線**: 400kbps下り、400kbps上り、400msレイテンシ

### 2. ネットワーク切断・再接続
- 突然の接続切断時の動作
- 再接続時の状態復旧
- 断続的な接続の処理

### 3. 高レイテンシ環境
- 500ms以上の高レイテンシでの操作性
- 可変レイテンシ環境での適応性

### 4. WebSocket接続の安定性
- WebSocket切断・再接続の処理
- 接続不安定時のフォールバック

### 5. パケットロス
- 10%パケットロス環境での動作
- リクエストタイムアウトの処理

### 6. オフラインモード
- 完全オフライン時のゲーム継続性
- ローカル状態の保持

## テスト実行方法

### 自動テスト実行
```bash
# すべてのネットワーク条件テストを実行
./test-network-conditions.sh

# 特定のテストのみ実行
npx playwright test tests/e2e/network-conditions.spec.js --project=network-conditions

# パフォーマンステストのみ実行
npx playwright test tests/e2e/network-performance.spec.js --project=network-conditions
```

### 手動テスト
Chrome DevToolsを使用した手動テスト：

1. **ネットワーク条件の設定**
   - DevTools → Network タブ
   - スロットリング設定で「Slow 3G」等を選択

2. **オフラインテスト**
   - DevTools → Network タブ
   - 「Offline」チェックボックスを有効化

3. **カスタム条件設定**
   - 「Add custom profile」でカスタム設定作成

## テスト項目詳細

### 基本動作テスト
- [ ] ページ読み込み時間が許容範囲内
- [ ] ゲーム要素（Canvas、UI）が正常表示
- [ ] キー入力への応答性
- [ ] スコア表示の更新

### ネットワーク適応テスト
- [ ] 接続状態インジケーターの表示
- [ ] 低速接続時の自動品質調整
- [ ] オフライン時の機能制限
- [ ] 再接続時の状態同期

### エラーハンドリングテスト
- [ ] リソース読み込み失敗時の処理
- [ ] WebSocket接続エラーの処理
- [ ] タイムアウト時の適切なメッセージ表示
- [ ] 致命的エラーからの復旧

## 期待される動作

### 低速ネットワーク時
- ゲーム開始まで15秒以内（3G環境）
- 基本操作の応答性維持
- プログレッシブローディングの動作

### ネットワーク切断時
- ゲーム状態の保持
- オフライン表示の出現
- ローカル操作の継続

### 再接続時
- 自動的な接続復旧
- ゲーム状態の同期
- オンライン機能の復元

## パフォーマンス指標

### 読み込み時間
- **良好**: 3G環境で8秒以内
- **許容**: 3G環境で15秒以内
- **改善必要**: 15秒超過

### 応答性
- **良好**: キー入力から100ms以内
- **許容**: キー入力から500ms以内
- **改善必要**: 500ms超過

### 安定性
- **良好**: エラー率5%未満
- **許容**: エラー率10%未満
- **改善必要**: エラー率10%超過

## トラブルシューティング

### よくある問題

#### テストタイムアウト
```bash
# タイムアウト時間を延長
npx playwright test --timeout=120000
```

#### WebSocket接続エラー
```bash
# WebSocketサーバーの起動確認
python main_websocket_integrated.py
```

#### ネットワーク制御が効かない
```bash
# Chrome起動オプションの確認
--disable-features=NetworkService
```

### ログの確認
```bash
# テスト結果の確認
cat test-results/network-conditions/basic-network-test.log

# スクリーンショットの確認
open test-results/network-conditions/
```

## 継続的な監視

### 自動化推奨事項
1. CI/CDパイプラインに組み込み
2. 定期的な実行スケジュール設定
3. 性能劣化の自動検出
4. アラート設定の構築

### メトリクス収集
- 読み込み時間の変化
- エラー率の推移
- ユーザビリティ指標
- パフォーマンス改善効果

## 改善方針

### 短期的改善
- [ ] タイムアウト設定の最適化
- [ ] エラーメッセージの改善
- [ ] ローディング表示の強化

### 中期的改善
- [ ] プログレッシブWebアプリ機能の強化
- [ ] キャッシュ戦略の最適化
- [ ] オフライン機能の拡張

### 長期的改善
- [ ] Service Workerの実装
- [ ] Background Syncの導入
- [ ] WebRTCによる直接通信

## 関連ファイル

### テストファイル
- `tests/e2e/network-conditions.spec.js` - 基本ネットワーク条件テスト
- `tests/e2e/network-performance.spec.js` - パフォーマンステスト
- `tests/e2e/network-helpers.js` - ヘルパー関数

### 実装ファイル
- `docs/js/network-monitor.js` - ネットワーク監視システム
- `docs/game.html` - メインゲームHTML（監視機能統合済み）

### 設定ファイル
- `playwright.config.js` - Playwright設定（ネットワークテスト用プロジェクト）
- `test-network-conditions.sh` - 自動テスト実行スクリプト

## まとめ

ネットワーク条件テストにより、様々な通信環境でのゲーム品質を保証します。
定期的なテスト実行と結果分析により、すべてのユーザーが快適にゲームを楽しめる環境を維持します。