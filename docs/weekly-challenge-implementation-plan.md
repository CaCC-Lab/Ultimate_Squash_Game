# 週替わりチャレンジ（PCG）TDD実装計画

## 🎯 概要

Ultimate Squash Gameに週替わりチャレンジ機能をTDD（テスト駆動開発）で実装します。
プロシージャル生成により、毎週異なるチャレンジを提供し、プレイヤーの継続的な参加を促進します。

## 🏗️ アーキテクチャ設計

```
┌─────────────────────────────────────────────────────┐
│                    UI Layer                         │
│  ┌─────────────┐  ┌──────────────┐  ┌──────────┐  │
│  │ Challenge   │  │  Progress    │  │  Reward  │  │
│  │   Modal     │  │   Display    │  │  Gallery │  │
│  └─────────────┘  └──────────────┘  └──────────┘  │
└─────────────────────────────────────────────────────┘
                            │
┌─────────────────────────────────────────────────────┐
│                 Challenge Manager                    │
│  ┌─────────────┐  ┌──────────────┐  ┌──────────┐  │
│  │  Challenge  │  │   Progress   │  │  Reward  │  │
│  │   Factory   │  │   Tracker    │  │  System  │  │
│  └─────────────┘  └──────────────┘  └──────────┘  │
└─────────────────────────────────────────────────────┘
                            │
┌─────────────────────────────────────────────────────┐
│                  Game Engine                        │
│  ┌─────────────┐  ┌──────────────┐  ┌──────────┐  │
│  │  Challenge  │  │    Event     │  │  State   │  │
│  │    Mode     │  │   Handler    │  │ Manager  │  │
│  └─────────────┘  └──────────────┘  └──────────┘  │
└─────────────────────────────────────────────────────┘
                            │
┌─────────────────────────────────────────────────────┐
│                   API Layer                         │
│  ┌─────────────┐  ┌──────────────┐  ┌──────────┐  │
│  │  Challenge  │  │ Leaderboard  │  │  Reward  │  │
│  │     API     │  │     API      │  │   API    │  │
│  └─────────────┘  └──────────────┘  └──────────┘  │
└─────────────────────────────────────────────────────┘
```

## 📋 実装フェーズ

### Phase 1: チャレンジタイプシステム（優先度: 高）

#### 実装するクラス
- `ChallengeType`: チャレンジの種類を定義
- `ChallengeFactory`: 週番号に基づいてチャレンジを生成

#### チャレンジタイプ
1. **SCORE_TARGET**: 目標スコア達成
2. **TIME_LIMIT**: 時間制限内でのスコア達成
3. **RESTRICTION**: 制限付きプレイ（パワーアップ禁止など）
4. **COMBO**: 複合条件チャレンジ
5. **SURVIVAL**: 一定時間生き残る
6. **ACCURACY**: ミス回数制限

#### テスト戦略
```javascript
// 1. 基本的なチャレンジタイプの作成
// 2. 達成条件の検証ロジック
// 3. プロシージャル生成の再現性
// 4. 難易度スケーリング
```

### Phase 2: 報酬・バッジシステム（優先度: 高）

#### 実装するクラス
- `Badge`: バッジの定義とレアリティ
- `Achievement`: プレイヤーの実績
- `RewardSystem`: 報酬の判定と付与

#### バッジの種類
1. **完了バッジ**: チャレンジクリア
2. **パーフェクトバッジ**: ノーミスクリア
3. **スピードランバッジ**: 素早いクリア
4. **ストリークバッジ**: 連続クリア
5. **レアバッジ**: 特殊条件達成

#### レアリティ
- COMMON (銅)
- RARE (銀)
- EPIC (金)
- LEGENDARY (虹)

### Phase 3: 進捗トラッキング（優先度: 中）

#### 実装するクラス
- `ChallengeProgress`: 個別チャレンジの進捗
- `ProgressTracker`: 全体的な進捗管理

#### トラッキング項目
- 現在スコア / 目標スコア
- 経過時間
- 試行回数
- ハイスコア
- 制限違反の有無

#### 永続化戦略
- localStorage使用
- 自動保存（5秒ごと）
- クラッシュリカバリー

### Phase 4: ゲームエンジン統合（優先度: 中）

#### 実装するクラス
- `ChallengeGameMode`: チャレンジ用ゲームモード
- `ChallengeManager`: チャレンジの統合管理

#### 統合ポイント
1. ゲーム開始時のパラメータ適用
2. リアルタイムの進捗更新
3. 制限違反の検出
4. 完了/失敗の判定
5. 結果の送信

## 🧪 プロシージャル生成のテスト戦略

### 決定論的生成の確保
```javascript
// 同じ週番号 → 同じシード → 同じチャレンジ
test('週番号1は常に同じチャレンジを生成', () => {
  const challenge1 = factory.createChallenge(1);
  const challenge2 = factory.createChallenge(1);
  expect(challenge1).toEqual(challenge2);
});
```

### バランステスト
```javascript
// 100週分のチャレンジを生成して分析
test('チャレンジの多様性と難易度曲線', () => {
  const challenges = generateChallenges(1, 100);
  const typeDistribution = analyzeTypeDistribution(challenges);
  const difficultyProgression = analyzeDifficulty(challenges);
  
  expect(typeDistribution).toBeBalanced();
  expect(difficultyProgression).toBeIncreasing();
});
```

## 🔄 既存システムとの統合

### WeeklyChallengeクラスの拡張
```javascript
class WeeklyChallenge {
  constructor(date) {
    // 既存のコード
    this.challengeType = this.generateChallengeType();
    this.rewards = this.generateRewards();
  }
  
  generateChallengeType() {
    const factory = new ChallengeFactory();
    return factory.createChallenge(this.weekNumber);
  }
}
```

### UIコンポーネントの拡張
- チャレンジタイプの表示
- 進捗バーの追加
- 報酬プレビュー
- リアルタイム更新

## 📊 メトリクスとモニタリング

### 追跡する指標
1. チャレンジ参加率
2. 完了率（チャレンジタイプ別）
3. 平均試行回数
4. 人気のチャレンジタイプ
5. バッジ獲得率

### A/Bテスト計画
- 難易度カーブの調整
- 報酬の魅力度
- UIの使いやすさ

## 🚀 実装優先順位

1. **Phase 1**: チャレンジタイプシステム（1-2日）
2. **Phase 2**: 報酬・バッジシステム（1-2日）
3. **Phase 3**: 進捗トラッキング（1日）
4. **Phase 4**: ゲームエンジン統合（2日）
5. **統合テストとリファクタリング**（1日）
6. **UI改善と最終調整**（1日）

合計見積もり: 6-8日

## ✅ 成功基準

- テストカバレッジ 90%以上を維持
- すべてのチャレンジタイプが正常に動作
- プロシージャル生成の再現性を確保
- 既存のゲームプレイに影響なし
- パフォーマンスの劣化なし

## 🔧 技術的考慮事項

### セキュリティ
- チャレンジ結果の改ざん防止（HMAC使用）
- クライアントサイド検証 + サーバーサイド検証

### パフォーマンス
- チャレンジ生成のキャッシュ
- 進捗更新のデバウンス
- 効率的なDOM更新

### 拡張性
- 新しいチャレンジタイプの追加が容易
- 報酬システムの拡張が可能
- 多言語対応の準備