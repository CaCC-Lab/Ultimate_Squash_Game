/**
 * CSP Enforcing Mode Migration Tool
 * Report-Onlyãƒ¢ãƒ¼ãƒ‰ã‹ã‚‰Enforcingãƒ¢ãƒ¼ãƒ‰ã¸ã®å®‰å…¨ãªç§»è¡Œ
 */

export class CSPEnforcingMigration {
    constructor() {
        this.config = {
            // ç§»è¡Œå‰ã®è©•ä¾¡æœŸé–“ï¼ˆãƒŸãƒªç§’ï¼‰
            evaluationPeriod: 30000, // 30ç§’ (æœ¬æ¥ã¯1é€±é–“ç¨‹åº¦)
            // è¨±å®¹ã•ã‚Œã‚‹é•åæ•°
            maxAllowedViolations: 5,
            // é‡è¦ãªé•åã®ã—ãã„å€¤
            criticalViolationThreshold: 1,
            // è‡ªå‹•ç§»è¡Œã®æœ‰åŠ¹/ç„¡åŠ¹
            autoMigrationEnabled: false
        };
        
        this.state = {
            isEvaluating: false,
            evaluationStartTime: null,
            violationHistory: [],
            migrationReadiness: null,
            enforcingModeActive: false
        };
        
        this.criticalDirectives = [
            'script-src',
            'object-src',
            'frame-src',
            'base-uri'
        ];
        
        this.bindMethods();
        this.initializeCSPEvaluation();
    }
    
    bindMethods() {
        this.onCSPViolation = this.onCSPViolation.bind(this);
        this.evaluateViolations = this.evaluateViolations.bind(this);
    }
    
    /**
     * CSPè©•ä¾¡ã‚·ã‚¹ãƒ†ãƒ ã®åˆæœŸåŒ–
     */
    initializeCSPEvaluation() {
        // æ—¢å­˜ã®CSPé•åãƒªã‚¹ãƒŠãƒ¼ã‚’æ‹¡å¼µ
        if (typeof window.getCSPViolationSummary === 'function') {
            this.integrateWithExistingReporter();
        }
        
        // ç‹¬è‡ªã®é•åãƒªã‚¹ãƒŠãƒ¼ã‚’è¿½åŠ 
        document.addEventListener('securitypolicyviolation', this.onCSPViolation);
        
        // è©•ä¾¡é–‹å§‹
        this.startEvaluation();
        
        console.log('ğŸ›¡ï¸ [CSP Migration] Evaluation system initialized');
    }
    \n    /**\n     * æ—¢å­˜ã®CSPãƒ¬ãƒãƒ¼ã‚¿ãƒ¼ã¨ã®çµ±åˆ\n     */\n    integrateWithExistingReporter() {\n        // window.cspViolationsãŒå­˜åœ¨ã™ã‚‹å ´åˆã€ãã‚Œã‚’æ´»ç”¨\n        if (window.cspViolations) {\n            // æ—¢å­˜ã®é•åãƒ‡ãƒ¼ã‚¿ã‚’å–ã‚Šè¾¼ã¿\n            Object.entries(window.cspViolations).forEach(([key, count]) => {\n                const [directive, uri] = key.split('|');\n                this.state.violationHistory.push({\n                    timestamp: Date.now(),\n                    directive: directive,\n                    blockedURI: uri,\n                    count: count,\n                    source: 'existing'\n                });\n            });\n            \n            console.log(`ğŸ›¡ï¸ [CSP Migration] Imported ${this.state.violationHistory.length} existing violations`);\n        }\n    }\n    \n    /**\n     * è©•ä¾¡é–‹å§‹\n     */\n    startEvaluation() {\n        if (this.state.isEvaluating) {\n            console.warn('[CSP Migration] Evaluation already in progress');\n            return;\n        }\n        \n        this.state.isEvaluating = true;\n        this.state.evaluationStartTime = Date.now();\n        this.state.violationHistory = [];\n        \n        console.log('ğŸ” [CSP Migration] Starting CSP violation evaluation');\n        \n        // è©•ä¾¡æœŸé–“çµ‚äº†å¾Œã®è‡ªå‹•è©•ä¾¡\n        setTimeout(() => {\n            this.completeEvaluation();\n        }, this.config.evaluationPeriod);\n    }\n    \n    /**\n     * CSPé•åã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©ãƒ¼\n     */\n    onCSPViolation(event) {\n        if (!this.state.isEvaluating) return;\n        \n        const violation = {\n            timestamp: Date.now(),\n            directive: event.violatedDirective,\n            blockedURI: event.blockedURI,\n            sourceFile: event.sourceFile,\n            lineNumber: event.lineNumber,\n            originalPolicy: event.originalPolicy,\n            isCritical: this.isCriticalViolation(event.violatedDirective)\n        };\n        \n        this.state.violationHistory.push(violation);\n        \n        console.log('ğŸš¨ [CSP Migration] Violation recorded:', {\n            directive: violation.directive,\n            blockedURI: violation.blockedURI,\n            isCritical: violation.isCritical\n        });\n        \n        // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ è©•ä¾¡æ›´æ–°\n        this.updateMigrationReadiness();\n    }\n    \n    /**\n     * é‡è¦ãªé•åã‹ã©ã†ã‹ã‚’åˆ¤å®š\n     */\n    isCriticalViolation(directive) {\n        return this.criticalDirectives.some(critical => \n            directive.includes(critical)\n        );\n    }\n    \n    /**\n     * ç§»è¡Œæº–å‚™çŠ¶æ³ã®æ›´æ–°\n     */\n    updateMigrationReadiness() {\n        const violations = this.state.violationHistory;\n        const criticalViolations = violations.filter(v => v.isCritical);\n        const totalViolations = violations.length;\n        \n        this.state.migrationReadiness = {\n            totalViolations: totalViolations,\n            criticalViolations: criticalViolations.length,\n            isReady: (\n                totalViolations <= this.config.maxAllowedViolations &&\n                criticalViolations.length <= this.config.criticalViolationThreshold\n            ),\n            riskLevel: this.calculateRiskLevel(totalViolations, criticalViolations.length),\n            evaluatedAt: Date.now()\n        };\n    }\n    \n    /**\n     * ãƒªã‚¹ã‚¯ãƒ¬ãƒ™ãƒ«è¨ˆç®—\n     */\n    calculateRiskLevel(totalViolations, criticalViolations) {\n        if (criticalViolations > 0) return 'HIGH';\n        if (totalViolations > this.config.maxAllowedViolations) return 'MEDIUM';\n        if (totalViolations > 0) return 'LOW';\n        return 'MINIMAL';\n    }\n    \n    /**\n     * è©•ä¾¡å®Œäº†\n     */\n    completeEvaluation() {\n        if (!this.state.isEvaluating) return;\n        \n        this.state.isEvaluating = false;\n        this.updateMigrationReadiness();\n        \n        const readiness = this.state.migrationReadiness;\n        \n        console.group('ğŸ“Š [CSP Migration] Evaluation Complete');\n        console.log('Total Violations:', readiness.totalViolations);\n        console.log('Critical Violations:', readiness.criticalViolations);\n        console.log('Risk Level:', readiness.riskLevel);\n        console.log('Ready for Enforcing Mode:', readiness.isReady);\n        console.groupEnd();\n        \n        // è‡ªå‹•ç§»è¡Œã®å®Ÿè¡Œ\n        if (readiness.isReady && this.config.autoMigrationEnabled) {\n            this.migrateToEnforcingMode();\n        } else {\n            this.generateMigrationReport();\n        }\n    }\n    \n    /**\n     * Enforcingãƒ¢ãƒ¼ãƒ‰ã¸ã®ç§»è¡Œå®Ÿè¡Œ\n     */\n    async migrateToEnforcingMode() {\n        if (this.state.enforcingModeActive) {\n            console.warn('[CSP Migration] Enforcing mode already active');\n            return;\n        }\n        \n        try {\n            console.log('ğŸ”’ [CSP Migration] Migrating to Enforcing Mode...');\n            \n            // è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®æ›´æ–°\n            await this.updateCSPConfiguration();\n            \n            // ãƒšãƒ¼ã‚¸ã®ãƒªãƒ­ãƒ¼ãƒ‰ï¼ˆæ–°ã—ã„CSPã‚’é©ç”¨ï¼‰\n            this.applyEnforcingCSP();\n            \n            this.state.enforcingModeActive = true;\n            \n            console.log('âœ… [CSP Migration] Migration to Enforcing Mode completed');\n            \n            // ç§»è¡Œå®Œäº†é€šçŸ¥\n            this.notifyMigrationComplete();\n            \n        } catch (error) {\n            console.error('âŒ [CSP Migration] Migration failed:', error);\n            this.handleMigrationFailure(error);\n        }\n    }\n    \n    /**\n     * CSPè¨­å®šã®æ›´æ–°\n     */\n    async updateCSPConfiguration() {\n        // ConfigLoaderã‚’ä½¿ç”¨ã—ã¦è¨­å®šã‚’æ›´æ–°\n        if (window.configLoader && window.configLoader.config) {\n            const config = window.configLoader.config;\n            \n            if (config.security && config.security.csp) {\n                // Report-Onlyã‚’Enforcingã«å¤‰æ›´\n                config.security.csp.reportOnly = false;\n                \n                console.log('ğŸ”§ [CSP Migration] Configuration updated');\n            }\n        }\n    }\n    \n    /**\n     * Enforcing CSPã‚’ãƒšãƒ¼ã‚¸ã«é©ç”¨\n     */\n    applyEnforcingCSP() {\n        // æ–°ã—ã„ãƒ¡ã‚¿ã‚¿ã‚°ã§Enforcing CSPã‚’è¨­å®š\n        const existingMeta = document.querySelector('meta[http-equiv=\"Content-Security-Policy\"]');\n        if (existingMeta) {\n            existingMeta.remove();\n        }\n        \n        const meta = document.createElement('meta');\n        meta.setAttribute('http-equiv', 'Content-Security-Policy');\n        meta.setAttribute('content', this.generateEnforcingCSPContent());\n        \n        document.head.appendChild(meta);\n        \n        console.log('ğŸ›¡ï¸ [CSP Migration] Enforcing CSP applied');\n    }\n    \n    /**\n     * Enforcing CSPã‚³ãƒ³ãƒ†ãƒ³ãƒ„ç”Ÿæˆ\n     */\n    generateEnforcingCSPContent() {\n        const directives = [\n            \"default-src 'self'\",\n            \"script-src 'self' 'unsafe-inline' 'wasm-unsafe-eval' https://cdn.jsdelivr.net\",\n            \"style-src 'self' 'unsafe-inline'\",\n            \"img-src 'self' data: blob:\",\n            \"connect-src 'self' http://localhost:* http://127.0.0.1:* ws://localhost:*\",\n            \"worker-src 'self' blob:\",\n            \"child-src 'self' blob:\",\n            \"object-src 'none'\",\n            \"font-src 'self'\",\n            \"base-uri 'self'\",\n            \"form-action 'self'\"\n        ];\n        \n        return directives.join('; ');\n    }\n    \n    /**\n     * ç§»è¡Œãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ\n     */\n    generateMigrationReport() {\n        const readiness = this.state.migrationReadiness;\n        const violations = this.state.violationHistory;\n        \n        const report = {\n            evaluationPeriod: {\n                start: this.state.evaluationStartTime,\n                end: Date.now(),\n                duration: Date.now() - this.state.evaluationStartTime\n            },\n            violationSummary: {\n                total: readiness.totalViolations,\n                critical: readiness.criticalViolations,\n                riskLevel: readiness.riskLevel\n            },\n            readiness: {\n                isReady: readiness.isReady,\n                recommendation: this.generateRecommendation(readiness)\n            },\n            violationDetails: this.groupViolationsByDirective(violations),\n            nextSteps: this.generateNextSteps(readiness)\n        };\n        \n        console.group('ğŸ“‹ [CSP Migration] Report');\n        console.log('Migration Readiness:', report.readiness);\n        console.log('Violation Summary:', report.violationSummary);\n        console.log('Violation Details:', report.violationDetails);\n        console.log('Next Steps:', report.nextSteps);\n        console.groupEnd();\n        \n        // IndexedDBã«ä¿å­˜\n        this.saveMigrationReport(report);\n        \n        return report;\n    }\n    \n    /**\n     * é•åã‚’ãƒ‡ã‚£ãƒ¬ã‚¯ãƒ†ã‚£ãƒ–åˆ¥ã«ã‚°ãƒ«ãƒ¼ãƒ—åŒ–\n     */\n    groupViolationsByDirective(violations) {\n        const grouped = {};\n        \n        violations.forEach(violation => {\n            const directive = violation.directive;\n            \n            if (!grouped[directive]) {\n                grouped[directive] = {\n                    count: 0,\n                    examples: [],\n                    isCritical: violation.isCritical\n                };\n            }\n            \n            grouped[directive].count += violation.count || 1;\n            \n            if (grouped[directive].examples.length < 3) {\n                grouped[directive].examples.push({\n                    blockedURI: violation.blockedURI,\n                    sourceFile: violation.sourceFile,\n                    lineNumber: violation.lineNumber\n                });\n            }\n        });\n        \n        return grouped;\n    }\n    \n    /**\n     * æ¨å¥¨äº‹é …ç”Ÿæˆ\n     */\n    generateRecommendation(readiness) {\n        if (readiness.isReady) {\n            return 'CSP Enforcing mode can be safely enabled. No critical violations detected.';\n        }\n        \n        if (readiness.criticalViolations > 0) {\n            return 'Critical violations detected. Review and fix security issues before enabling Enforcing mode.';\n        }\n        \n        if (readiness.totalViolations > this.config.maxAllowedViolations) {\n            return 'Too many violations detected. Review and optimize CSP directives or fix violations.';\n        }\n        \n        return 'Continue monitoring. Consider extending evaluation period.';\n    }\n    \n    /**\n     * æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ç”Ÿæˆ\n     */\n    generateNextSteps(readiness) {\n        const steps = [];\n        \n        if (readiness.isReady) {\n            steps.push('Enable CSP Enforcing mode');\n            steps.push('Monitor for any new violations');\n            steps.push('Consider implementing CSP nonces for enhanced security');\n        } else {\n            if (readiness.criticalViolations > 0) {\n                steps.push('Fix critical security violations immediately');\n            }\n            \n            if (readiness.totalViolations > this.config.maxAllowedViolations) {\n                steps.push('Review and update CSP directives');\n                steps.push('Fix non-critical violations');\n            }\n            \n            steps.push('Continue evaluation period');\n            steps.push('Re-evaluate after fixes are implemented');\n        }\n        \n        return steps;\n    }\n    \n    /**\n     * ç§»è¡Œå®Œäº†é€šçŸ¥\n     */\n    notifyMigrationComplete() {\n        // ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã«é€šçŸ¥\n        if (window.performanceDashboard && window.performanceDashboard.isVisible) {\n            this.addNotificationToDashboard('CSP Enforcing Mode Activated', 'success');\n        }\n        \n        // ã‚³ãƒ³ã‚½ãƒ¼ãƒ«é€šçŸ¥\n        console.log('ğŸ‰ [CSP Migration] Migration completed successfully!');\n        \n        // ã‚«ã‚¹ã‚¿ãƒ ã‚¤ãƒ™ãƒ³ãƒˆç™ºç«\n        const event = new CustomEvent('csp:enforcingModeActivated', {\n            detail: {\n                timestamp: Date.now(),\n                migrationReadiness: this.state.migrationReadiness\n            }\n        });\n        \n        window.dispatchEvent(event);\n    }\n    \n    /**\n     * ç§»è¡Œå¤±æ•—å‡¦ç†\n     */\n    handleMigrationFailure(error) {\n        console.error('ğŸš¨ [CSP Migration] Migration failed:', error);\n        \n        // Report-Onlyãƒ¢ãƒ¼ãƒ‰ã«æˆ»ã™\n        this.revertToReportOnly();\n        \n        // ã‚¨ãƒ©ãƒ¼é€šçŸ¥\n        if (window.performanceDashboard && window.performanceDashboard.isVisible) {\n            this.addNotificationToDashboard('CSP Migration Failed', 'error');\n        }\n    }\n    \n    /**\n     * Report-Onlyãƒ¢ãƒ¼ãƒ‰ã¸ã®å¾©å¸°\n     */\n    revertToReportOnly() {\n        const enforcingMeta = document.querySelector('meta[http-equiv=\"Content-Security-Policy\"]');\n        if (enforcingMeta) {\n            enforcingMeta.remove();\n        }\n        \n        this.state.enforcingModeActive = false;\n        \n        console.log('ğŸ”„ [CSP Migration] Reverted to Report-Only mode');\n    }\n    \n    /**\n     * ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã«é€šçŸ¥è¿½åŠ \n     */\n    addNotificationToDashboard(message, type) {\n        // ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã«é€šçŸ¥ã‚’è¿½åŠ \n        // ã“ã®å®Ÿè£…ã¯æ—¢å­˜ã®ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰æ§‹é€ ã«ä¾å­˜\n        console.log(`ğŸ“¢ [CSP Migration] Dashboard notification: ${message} (${type})`);\n    }\n    \n    /**\n     * ç§»è¡Œãƒ¬ãƒãƒ¼ãƒˆã‚’IndexedDBã«ä¿å­˜\n     */\n    async saveMigrationReport(report) {\n        try {\n            if (!window.indexedDB) return;\n            \n            const request = indexedDB.open('CSPMigrationReports', 1);\n            \n            request.onupgradeneeded = (event) => {\n                const db = event.target.result;\n                if (!db.objectStoreNames.contains('reports')) {\n                    const store = db.createObjectStore('reports', { keyPath: 'timestamp' });\n                    store.createIndex('riskLevel', 'violationSummary.riskLevel', { unique: false });\n                }\n            };\n            \n            request.onsuccess = (event) => {\n                const db = event.target.result;\n                const transaction = db.transaction(['reports'], 'readwrite');\n                const store = transaction.objectStore('reports');\n                \n                const reportWithTimestamp = {\n                    ...report,\n                    timestamp: Date.now()\n                };\n                \n                store.add(reportWithTimestamp);\n                \n                console.log('ğŸ’¾ [CSP Migration] Report saved to IndexedDB');\n            };\n            \n        } catch (error) {\n            console.warn('[CSP Migration] Failed to save report:', error);\n        }\n    }\n    \n    /**\n     * æ‰‹å‹•ç§»è¡Œãƒˆãƒªã‚¬ãƒ¼\n     */\n    forceMigration() {\n        console.log('ğŸ”§ [CSP Migration] Force migration triggered');\n        this.migrateToEnforcingMode();\n    }\n    \n    /**\n     * è©•ä¾¡çŠ¶æ³å–å¾—\n     */\n    getEvaluationStatus() {\n        return {\n            isEvaluating: this.state.isEvaluating,\n            evaluationStartTime: this.state.evaluationStartTime,\n            violationCount: this.state.violationHistory.length,\n            migrationReadiness: this.state.migrationReadiness,\n            enforcingModeActive: this.state.enforcingModeActive\n        };\n    }\n    \n    /**\n     * è¨­å®šæ›´æ–°\n     */\n    updateConfig(newConfig) {\n        this.config = { ...this.config, ...newConfig };\n        console.log('âš™ï¸ [CSP Migration] Configuration updated:', this.config);\n    }\n    \n    /**\n     * ãƒªã‚½ãƒ¼ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—\n     */\n    destroy() {\n        document.removeEventListener('securitypolicyviolation', this.onCSPViolation);\n        this.state.isEvaluating = false;\n        this.state.violationHistory = [];\n        \n        console.log('ğŸ§¹ [CSP Migration] Cleanup completed');\n    }\n}\n\n// ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ä½œæˆ\nwindow.cspMigration = new CSPEnforcingMigration();\n\n// é–‹ç™ºç’°å¢ƒã§ã¯è‡ªå‹•ç§»è¡Œã‚’æœ‰åŠ¹åŒ–\nif (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {\n    window.cspMigration.updateConfig({\n        evaluationPeriod: 10000, // 10ç§’\n        autoMigrationEnabled: true\n    });\n    \n    console.log('ğŸ›¡ï¸ [CSP Migration] Development mode: Auto-migration enabled');\n}\n\nexport default CSPEnforcingMigration;"