<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Performance Metrics with IndexedDB Demo</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f0f0f0;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        h1 {
            color: #333;
        }
        
        .controls {
            margin: 20px 0;
            padding: 15px;
            background: #f9f9f9;
            border-radius: 4px;
        }
        
        button {
            padding: 8px 16px;
            margin: 5px;
            border: none;
            border-radius: 4px;
            background: #007bff;
            color: white;
            cursor: pointer;
            font-size: 14px;
        }
        
        button:hover {
            background: #0056b3;
        }
        
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        .status {
            margin: 20px 0;
            padding: 15px;
            background: #e9ecef;
            border-radius: 4px;
            font-family: monospace;
        }
        
        .metrics-display {
            margin: 20px 0;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 4px;
        }
        
        .log {
            margin: 20px 0;
            padding: 15px;
            background: #263238;
            color: #aed581;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .animation-box {
            width: 100px;
            height: 100px;
            background: #ff5722;
            margin: 20px auto;
            border-radius: 8px;
            animation: rotate 2s linear infinite;
        }
        
        @keyframes rotate {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        .query-results {
            margin: 20px 0;
            padding: 15px;
            background: #fff3e0;
            border-radius: 4px;
            max-height: 400px;
            overflow-y: auto;
        }
        
        pre {
            margin: 0;
            white-space: pre-wrap;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ® Performance Metrics + IndexedDB Demo</h1>
        
        <div class="controls">
            <h3>ãƒ¡ãƒˆãƒªã‚¯ã‚¹åé›†ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«</h3>
            <button id="startBtn" onclick="startCollection()">åé›†é–‹å§‹</button>
            <button id="stopBtn" onclick="stopCollection()" disabled>åé›†åœæ­¢</button>
            <button id="togglePersistence" onclick="togglePersistence()">æ°¸ç¶šåŒ–: ON</button>
            <button id="changePersistInterval" onclick="changePersistInterval()">ä¿å­˜é–“éš”å¤‰æ›´</button>
            <button id="clearMetrics" onclick="clearMetrics()">ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã‚¯ãƒªã‚¢</button>
        </div>
        
        <div class="status">
            <h3>ã‚»ãƒƒã‚·ãƒ§ãƒ³æƒ…å ±</h3>
            <pre id="sessionInfo">ã‚»ãƒƒã‚·ãƒ§ãƒ³æœªé–‹å§‹</pre>
        </div>
        
        <div class="controls">
            <h3>ãƒ‡ãƒ¼ã‚¿ã‚¯ã‚¨ãƒª</h3>
            <button onclick="queryRecentMetrics()">ç›´è¿‘ã®ãƒ¡ãƒˆãƒªã‚¯ã‚¹å–å¾—</button>
            <button onclick="queryFPSMetrics()">FPSãƒ‡ãƒ¼ã‚¿ã®ã¿å–å¾—</button>
            <button onclick="getAggregates()">é›†è¨ˆãƒ‡ãƒ¼ã‚¿å–å¾—</button>
            <button onclick="exportData()">ãƒ‡ãƒ¼ã‚¿ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
        </div>
        
        <div class="query-results">
            <h3>ã‚¯ã‚¨ãƒªçµæœ</h3>
            <pre id="queryResults">ã‚¯ã‚¨ãƒªã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„</pre>
        </div>
        
        <!-- ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³è¦ç´ ï¼ˆè² è·ç”Ÿæˆç”¨ï¼‰ -->
        <div class="animation-box" id="animBox"></div>
        
        <div class="log">
            <h3>ãƒ­ã‚°</h3>
            <div id="logContent"></div>
        </div>
    </div>
    
    <script type="module">
        import { metricsCollector } from './performance-metrics-collector.js';
        
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«ã«å…¬é–‹
        window.metricsCollector = metricsCollector;
        
        // ãƒ­ã‚°å‡ºåŠ›
        function log(message) {
            const logContent = document.getElementById('logContent');
            const timestamp = new Date().toLocaleTimeString();
            logContent.innerHTML += `[${timestamp}] ${message}\n`;
            logContent.scrollTop = logContent.scrollHeight;
        }
        
        // åé›†é–‹å§‹
        window.startCollection = async function() {
            try {
                await metricsCollector.start();
                document.getElementById('startBtn').disabled = true;
                document.getElementById('stopBtn').disabled = false;
                log('ãƒ¡ãƒˆãƒªã‚¯ã‚¹åé›†ã‚’é–‹å§‹ã—ã¾ã—ãŸ');
                
                // ã‚»ãƒƒã‚·ãƒ§ãƒ³æƒ…å ±ã®å®šæœŸæ›´æ–°
                updateSessionInfo();
                window.sessionInfoInterval = setInterval(updateSessionInfo, 1000);
                
                // è² è·ç”Ÿæˆã®ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
                startLoadSimulation();
            } catch (error) {
                log(`ã‚¨ãƒ©ãƒ¼: ${error.message}`);
            }
        };
        
        // åé›†åœæ­¢
        window.stopCollection = async function() {
            try {
                await metricsCollector.stop();
                document.getElementById('startBtn').disabled = false;
                document.getElementById('stopBtn').disabled = true;
                log('ãƒ¡ãƒˆãƒªã‚¯ã‚¹åé›†ã‚’åœæ­¢ã—ã¾ã—ãŸ');
                
                if (window.sessionInfoInterval) {
                    clearInterval(window.sessionInfoInterval);
                }
                
                stopLoadSimulation();
            } catch (error) {
                log(`ã‚¨ãƒ©ãƒ¼: ${error.message}`);
            }
        };
        
        // æ°¸ç¶šåŒ–åˆ‡ã‚Šæ›¿ãˆ
        window.togglePersistence = function() {
            const enabled = !metricsCollector.config.enablePersistence;
            metricsCollector.setPersistenceEnabled(enabled);
            document.getElementById('togglePersistence').textContent = `æ°¸ç¶šåŒ–: ${enabled ? 'ON' : 'OFF'}`;
            log(`æ°¸ç¶šåŒ–ã‚’${enabled ? 'æœ‰åŠ¹' : 'ç„¡åŠ¹'}ã«ã—ã¾ã—ãŸ`);
        };
        
        // ä¿å­˜é–“éš”å¤‰æ›´
        window.changePersistInterval = function() {
            const interval = prompt('ä¿å­˜é–“éš”ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆãƒŸãƒªç§’ï¼‰:', metricsCollector.config.persistInterval);
            if (interval && !isNaN(interval)) {
                metricsCollector.setPersistInterval(parseInt(interval));
                log(`ä¿å­˜é–“éš”ã‚’${interval}msã«å¤‰æ›´ã—ã¾ã—ãŸ`);
            }
        };
        
        // ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã‚¯ãƒªã‚¢
        window.clearMetrics = function() {
            metricsCollector.reset();
            log('ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ');
        };
        
        // ã‚»ãƒƒã‚·ãƒ§ãƒ³æƒ…å ±æ›´æ–°
        function updateSessionInfo() {
            const info = metricsCollector.getSessionInfo();
            const summary = metricsCollector.getSummary();
            
            document.getElementById('sessionInfo').textContent = JSON.stringify({
                ...info,
                currentFPS: summary.fps?.current?.toFixed(1),
                avgFrameTime: summary.frameTimes?.avg?.toFixed(2),
                memoryUsage: summary.memoryUsage?.current?.toFixed(1)
            }, null, 2);
        }
        
        // ç›´è¿‘ã®ãƒ¡ãƒˆãƒªã‚¯ã‚¹å–å¾—
        window.queryRecentMetrics = async function() {
            try {
                const results = await metricsCollector.queryStoredMetrics({
                    startTime: Date.now() - 60000, // éå»1åˆ†
                    limit: 100
                });
                document.getElementById('queryResults').textContent = JSON.stringify(results, null, 2);
                log(`${results.length}ä»¶ã®ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã‚’å–å¾—ã—ã¾ã—ãŸ`);
            } catch (error) {
                log(`ã‚¯ã‚¨ãƒªã‚¨ãƒ©ãƒ¼: ${error.message}`);
            }
        };
        
        // FPSãƒ¡ãƒˆãƒªã‚¯ã‚¹ã®ã¿å–å¾—
        window.queryFPSMetrics = async function() {
            try {
                const results = await metricsCollector.queryStoredMetrics({
                    type: 'fps',
                    limit: 50
                });
                document.getElementById('queryResults').textContent = JSON.stringify(results, null, 2);
                log(`${results.length}ä»¶ã®FPSãƒ¡ãƒˆãƒªã‚¯ã‚¹ã‚’å–å¾—ã—ã¾ã—ãŸ`);
            } catch (error) {
                log(`ã‚¯ã‚¨ãƒªã‚¨ãƒ©ãƒ¼: ${error.message}`);
            }
        };
        
        // é›†è¨ˆãƒ‡ãƒ¼ã‚¿å–å¾—
        window.getAggregates = async function() {
            try {
                const endTime = Date.now();
                const startTime = endTime - 300000; // éå»5åˆ†
                const aggregates = await metricsCollector.getStoredAggregates(startTime, endTime);
                document.getElementById('queryResults').textContent = JSON.stringify(aggregates, null, 2);
                log(`${aggregates.length}ä»¶ã®é›†è¨ˆãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã¾ã—ãŸ`);
            } catch (error) {
                log(`é›†è¨ˆãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼: ${error.message}`);
            }
        };
        
        // ãƒ‡ãƒ¼ã‚¿ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
        window.exportData = function() {
            const data = metricsCollector.exportMetrics();
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `metrics_${new Date().toISOString()}.json`;
            a.click();
            URL.revokeObjectURL(url);
            log('ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã—ã¾ã—ãŸ');
        };
        
        // è² è·ç”Ÿæˆã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
        let loadSimulationRunning = false;
        let loadAnimationFrame = null;
        
        function startLoadSimulation() {
            loadSimulationRunning = true;
            
            function simulate() {
                if (!loadSimulationRunning) return;
                
                // ã‚²ãƒ¼ãƒ ãƒ­ã‚¸ãƒƒã‚¯ã®ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
                metricsCollector.startGameLogicTiming();
                
                // é‡ã„å‡¦ç†ã®ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
                let sum = 0;
                for (let i = 0; i < Math.random() * 100000; i++) {
                    sum += Math.sqrt(i);
                }
                
                metricsCollector.endGameLogicTiming();
                
                // ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã®ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
                metricsCollector.startRenderTiming();
                
                const box = document.getElementById('animBox');
                const hue = (Date.now() / 10) % 360;
                box.style.background = `hsl(${hue}, 70%, 50%)`;
                
                metricsCollector.endRenderTiming();
                
                // WebWorkeré…å»¶ã®ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆãƒ©ãƒ³ãƒ€ãƒ ï¼‰
                if (Math.random() > 0.9) {
                    metricsCollector.recordWebWorkerLatency(Math.random() * 50);
                }
                
                loadAnimationFrame = requestAnimationFrame(simulate);
            }
            
            simulate();
        }
        
        function stopLoadSimulation() {
            loadSimulationRunning = false;
            if (loadAnimationFrame) {
                cancelAnimationFrame(loadAnimationFrame);
            }
        }
        
        // åˆæœŸåŒ–å®Œäº†ãƒ­ã‚°
        log('ãƒ‡ãƒ¢ãƒšãƒ¼ã‚¸ãŒèª­ã¿è¾¼ã¾ã‚Œã¾ã—ãŸ');
        log('IndexedDBæ°¸ç¶šåŒ–æ©Ÿèƒ½ãŒåˆ©ç”¨å¯èƒ½ã§ã™');
        
        // ãƒšãƒ¼ã‚¸é›¢è„±æ™‚ã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
        window.addEventListener('beforeunload', async () => {
            if (metricsCollector.isCollecting) {
                await metricsCollector.stop();
            }
            await metricsCollector.cleanup();
        });
    </script>
</body>
</html>