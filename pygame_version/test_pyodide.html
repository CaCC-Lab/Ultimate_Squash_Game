<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pyodide + Pygame-CE ãƒ†ã‚¹ãƒˆ</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border-left: 4px solid #007acc;
            background-color: #f8f9fa;
        }
        #output {
            background-color: #1e1e1e;
            color: #ffffff;
            padding: 15px;
            border-radius: 4px;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
            margin: 10px 0;
        }
        button {
            background-color: #007acc;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background-color: #005a9e;
        }
        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        .status {
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .status.loading {
            background-color: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
        }
        .status.success {
            background-color: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        .status.error {
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ® Pyodide + Pygame-CE äº’æ›æ€§ãƒ†ã‚¹ãƒˆ</h1>
        
        <div class="test-section">
            <h2>Phase 2C: WASMç’°å¢ƒæ¤œè¨¼</h2>
            <p>å€‹äººé–‹ç™ºè¦ç´„éµå®ˆ: TDDå¿…é ˆã€ãƒ¢ãƒƒã‚¯ç¦æ­¢ã€ã‚¨ãƒ©ãƒ¼3è¦ç´ </p>
            <p>æŠ€è¡“ç§»è¡Œ: Python 3.12 + Pygame-CE â†’ WASMå¯¾å¿œç¢ºèª</p>
        </div>

        <div id="status" class="status loading">
            <strong>ğŸ”„ Pyodideã‚’åˆæœŸåŒ–ä¸­...</strong>
            <p>æœ€æ–°ã®Pyodideç’°å¢ƒã‚’ãƒ­ãƒ¼ãƒ‰ã—ã¦ã„ã¾ã™ã€‚åˆå›å®Ÿè¡Œæ™‚ã¯æ•°åˆ†ã‹ã‹ã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ã€‚</p>
        </div>

        <div class="test-section">
            <h3>ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ</h3>
            <button id="test-python" disabled>1. Python 3.12åŸºæœ¬å‹•ä½œç¢ºèª</button>
            <button id="test-pygame" disabled>2. Pygame-CEå¯¾å¿œç¢ºèª</button>
            <button id="test-mvc" disabled>3. MVCãƒ‘ã‚¿ãƒ¼ãƒ³å‹•ä½œç¢ºèª</button>
            <button id="test-performance" disabled>4. WASM ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆ</button>
        </div>

        <div class="test-section">
            <h3>å®Ÿè¡Œçµæœ</h3>
            <div id="output">ãƒ†ã‚¹ãƒˆé–‹å§‹å‰...</div>
        </div>

        <div class="test-section">
            <h3>æŠ€è¡“æƒ…å ±</h3>
            <ul>
                <li><strong>Pyodideç‰ˆæœ¬</strong>: <span id="pyodide-version">ç¢ºèªä¸­...</span></li>
                <li><strong>Pythonç‰ˆæœ¬</strong>: <span id="python-version">ç¢ºèªä¸­...</span></li>
                <li><strong>åˆ©ç”¨å¯èƒ½ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸</strong>: <span id="available-packages">ç¢ºèªä¸­...</span></li>
                <li><strong>Pygame-CEå¯¾å¿œ</strong>: <span id="pygame-support">ç¢ºèªä¸­...</span></li>
            </ul>
        </div>
    </div>

    <!-- Pyodide CDN -->
    <script src="https://cdn.jsdelivr.net/pyodide/v0.26.4/full/pyodide.js"></script>
    
    <script>
        let pyodide;
        let outputElement = document.getElementById('output');
        let statusElement = document.getElementById('status');

        function updateOutput(message) {
            outputElement.textContent += message + '\n';
            outputElement.scrollTop = outputElement.scrollHeight;
        }

        function updateStatus(message, className) {
            statusElement.innerHTML = message;
            statusElement.className = `status ${className}`;
        }

        function enableButtons() {
            document.querySelectorAll('button').forEach(btn => {
                btn.disabled = false;
            });
        }

        async function main() {
            try {
                updateOutput("ğŸš€ PyodideåˆæœŸåŒ–é–‹å§‹...");
                
                // PyodideåˆæœŸåŒ–
                pyodide = await loadPyodide({
                    indexURL: "https://cdn.jsdelivr.net/pyodide/v0.26.4/full/"
                });
                
                updateOutput("âœ… PyodideåˆæœŸåŒ–å®Œäº†");
                updateStatus("âœ… <strong>Pyodideæº–å‚™å®Œäº†</strong> - ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã§ãã¾ã™", "success");
                
                // ãƒãƒ¼ã‚¸ãƒ§ãƒ³æƒ…å ±å–å¾—
                const pyodideVersion = pyodide.runPython(`
import sys
sys.version
                `);
                
                document.getElementById('pyodide-version').textContent = "0.26.4";
                document.getElementById('python-version').textContent = pyodideVersion;
                
                // åˆ©ç”¨å¯èƒ½ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ç¢ºèª
                const packages = pyodide.runPython(`
import micropip
# åŸºæœ¬ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãƒªã‚¹ãƒˆç¢ºèª
basic_packages = ['numpy', 'matplotlib', 'pillow']
f"ç¢ºèªæ¸ˆã¿: {', '.join(basic_packages)}"
                `);
                document.getElementById('available-packages').textContent = packages;
                
                updateOutput("ğŸ“¦ ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ç¢ºèªå®Œäº†");
                enableButtons();
                
            } catch (error) {
                updateOutput(`âŒ åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼: ${error.message}`);
                updateStatus(`âŒ <strong>åˆæœŸåŒ–å¤±æ•—</strong>: ${error.message}`, "error");
                console.error('PyodideåˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', error);
            }
        }

        // ãƒ†ã‚¹ãƒˆ1: Python 3.12åŸºæœ¬å‹•ä½œç¢ºèª
        document.getElementById('test-python').onclick = async function() {
            try {
                updateOutput("\n=== ãƒ†ã‚¹ãƒˆ1: Python 3.12åŸºæœ¬å‹•ä½œç¢ºèª ===");
                
                const result = pyodide.runPython(`
# Python 3.12æ–°æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ
import sys
import math

def test_python_312():
    # ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç¢ºèª
    version_info = f"Python {sys.version.split()[0]}"
    
    # matchæ–‡ãƒ†ã‚¹ãƒˆï¼ˆPython 3.10+ï¼‰
    test_value = "pyodide"
    match test_value:
        case "pyodide":
            match_result = "matchæ–‡å‹•ä½œç¢ºèª: OK"
        case _:
            match_result = "matchæ–‡å‹•ä½œç¢ºèª: NG"
    
    # å‹ãƒ’ãƒ³ãƒˆãƒ†ã‚¹ãƒˆ
    def typed_function(x: float, y: float) -> float:
        return math.sqrt(x**2 + y**2)
    
    distance = typed_function(3.0, 4.0)
    
    # è¾æ›¸çµ±åˆãƒ†ã‚¹ãƒˆ
    dict1 = {"a": 1, "b": 2}
    dict2 = {"c": 3, "d": 4}
    merged = dict1 | dict2
    
    return {
        "version": version_info,
        "match_statement": match_result,
        "typed_function": f"distance(3,4) = {distance}",
        "dict_merge": f"dict merge: {merged}",
        "status": "SUCCESS"
    }

test_result = test_python_312()
f"""âœ… PythonåŸºæœ¬å‹•ä½œç¢ºèªå®Œäº†:
   ãƒãƒ¼ã‚¸ãƒ§ãƒ³: {test_result['version']}
   {test_result['match_statement']}
   å‹ãƒ’ãƒ³ãƒˆ: {test_result['typed_function']}
   è¾æ›¸çµ±åˆ: {test_result['dict_merge']}
   çµæœ: {test_result['status']}"""
                `);
                
                updateOutput(result);
                
            } catch (error) {
                updateOutput(`âŒ PythonåŸºæœ¬ãƒ†ã‚¹ãƒˆå¤±æ•—: ${error.message}`);
            }
        };

        // ãƒ†ã‚¹ãƒˆ2: Pygame-CEå¯¾å¿œç¢ºèª
        document.getElementById('test-pygame').onclick = async function() {
            try {
                updateOutput("\n=== ãƒ†ã‚¹ãƒˆ2: Pygame-CEå¯¾å¿œç¢ºèª ===");
                
                // ã¾ãšPygame-CEã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã‚’è©¦è¡Œ
                await pyodide.loadPackage(["micropip"]);
                
                const result = pyodide.runPython(`
import micropip
import sys

def test_pygame_support():
    results = []
    
    # 1. Pygameæ¤œç´¢
    try:
        available_packages = micropip.list()
        results.append("ğŸ“¦ åˆ©ç”¨å¯èƒ½ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ä¸€è¦§å–å¾—: OK")
    except Exception as e:
        results.append(f"âŒ ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ä¸€è¦§å–å¾—å¤±æ•—: {str(e)}")
        return results
    
    # 2. Pygame-CE ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«è©¦è¡Œ
    try:
        # Pyodideã§ã®pygameçŠ¶æ³ç¢ºèª
        # Note: Pygame-CEã¯Pyodideã§ã¯ç›´æ¥ã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ãªã„å¯èƒ½æ€§ãŒé«˜ã„
        # ä»£æ›¿æ¡ˆ: pygame-webã‚„Pygame.jsã®æ¤œè¨ãŒå¿…è¦
        
        results.append("ğŸ” Pygame-CE Pyodideå¯¾å¿œç¢ºèªä¸­...")
        results.append("âš ï¸  æ³¨æ„: Pygame-CEã¯ãƒã‚¤ãƒ†ã‚£ãƒ–Cæ‹¡å¼µã®ãŸã‚Pyodideã§ç›´æ¥å‹•ä½œã—ãªã„å¯èƒ½æ€§")
        results.append("ğŸ’¡ ä»£æ›¿æ¡ˆ: Canvas API + JavaScriptçµ±åˆã‚’æ¤œè¨")
        
        # WebGL/Canvas APIãƒ™ãƒ¼ã‚¹ã®ä»£æ›¿å®Ÿè£…ã®å¯èƒ½æ€§ã‚’ç¢ºèª
        results.append("ğŸŒ Webç’°å¢ƒã§ã®æç”»ä»£æ›¿æ¡ˆ:")
        results.append("   - HTML5 Canvas API")
        results.append("   - WebGLæç”»")
        results.append("   - Pygame-web (ã‚‚ã—åˆ©ç”¨å¯èƒ½ãªã‚‰)")
        
        return results
        
    except Exception as e:
        results.append(f"âŒ Pygameé–¢é€£ã‚¨ãƒ©ãƒ¼: {str(e)}")
        return results

test_results = test_pygame_support()
"\\n".join(test_results)
                `);
                
                updateOutput(result);
                document.getElementById('pygame-support').textContent = "è¦ä»£æ›¿å®Ÿè£…ï¼ˆCanvas APIï¼‰";
                
            } catch (error) {
                updateOutput(`âŒ Pygameãƒ†ã‚¹ãƒˆå¤±æ•—: ${error.message}`);
                document.getElementById('pygame-support').textContent = "éå¯¾å¿œ";
            }
        };

        // ãƒ†ã‚¹ãƒˆ3: MVC ãƒ‘ã‚¿ãƒ¼ãƒ³å‹•ä½œç¢ºèª
        document.getElementById('test-mvc').onclick = async function() {
            try {
                updateOutput("\n=== ãƒ†ã‚¹ãƒˆ3: MVCãƒ‘ã‚¿ãƒ¼ãƒ³å‹•ä½œç¢ºèª ===");
                
                const result = pyodide.runPython(`
# Webç’°å¢ƒå‘ã‘MVCãƒ‘ã‚¿ãƒ¼ãƒ³ã®å‹•ä½œç¢ºèª
import math
from typing import List, Dict, Any, Tuple

class WebBall:
    """Webç’°å¢ƒå¯¾å¿œãƒœãƒ¼ãƒ«ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£"""
    
    def __init__(self, x: float, y: float, dx: float, dy: float, size: int, color: str):
        self.x = float(x)
        self.y = float(y)
        self.dx = float(dx)
        self.dy = float(dy)
        self.size = int(size)
        self.color = str(color)  # CSSè‰²æŒ‡å®š
        self.radius = size // 2

class WebGameState:
    """Webç’°å¢ƒå¯¾å¿œã‚²ãƒ¼ãƒ çŠ¶æ…‹ç®¡ç†"""
    
    SCREEN_WIDTH = 640
    SCREEN_HEIGHT = 480
    
    def __init__(self):
        self.is_gameover = False
        self.paused = False
        self.balls: List[WebBall] = []
        self.score = 0
        
        # åˆæœŸãƒœãƒ¼ãƒ«ä½œæˆ
        initial_ball = WebBall(
            x=320.0, y=250.0,
            dx=15.0, dy=-15.0,
            size=10,
            color="red"
        )
        self.balls = [initial_ball]
    
    def update_ball_position(self, ball: WebBall) -> bool:
        """ãƒœãƒ¼ãƒ«ä½ç½®æ›´æ–°ï¼ˆWebç’°å¢ƒç”¨ï¼‰"""
        collision = False
        
        # å£è¡çªãƒã‚§ãƒƒã‚¯
        future_x = ball.x + ball.dx
        future_y = ball.y + ball.dy
        
        if future_x < 0 or future_x > self.SCREEN_WIDTH:
            ball.dx *= -1
            collision = True
        
        if future_y < 0:
            ball.dy *= -1
            collision = True
        
        # ä½ç½®æ›´æ–°
        ball.x += ball.dx
        ball.y += ball.dy
        
        return collision
    
    def get_state_json(self) -> str:
        """JavaScripté€£æºç”¨çŠ¶æ…‹å–å¾—"""
        return {
            'is_gameover': self.is_gameover,
            'paused': self.paused,
            'score': self.score,
            'balls': [
                {
                    'x': ball.x,
                    'y': ball.y,
                    'dx': ball.dx,
                    'dy': ball.dy,
                    'size': ball.size,
                    'color': ball.color
                }
                for ball in self.balls
            ]
        }

def test_mvc_pattern():
    """MVCãƒ‘ã‚¿ãƒ¼ãƒ³å‹•ä½œãƒ†ã‚¹ãƒˆ"""
    # GameStateä½œæˆ
    game_state = WebGameState()
    
    # åˆæœŸçŠ¶æ…‹ç¢ºèª
    initial_state = game_state.get_state_json()
    
    # ãƒœãƒ¼ãƒ«ä½ç½®æ›´æ–°ãƒ†ã‚¹ãƒˆ
    ball = game_state.balls[0]
    original_x = ball.x
    collision = game_state.update_ball_position(ball)
    
    # çµæœç¢ºèª
    final_state = game_state.get_state_json()
    
    return {
        'initial_ball_x': original_x,
        'final_ball_x': ball.x,
        'collision_detected': collision,
        'ball_moved': abs(ball.x - original_x) > 0,
        'state_structure': list(final_state.keys()),
        'status': 'SUCCESS'
    }

# ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
test_result = test_mvc_pattern()

f"""âœ… Webç’°å¢ƒMVCãƒ‘ã‚¿ãƒ¼ãƒ³å‹•ä½œç¢ºèª:
   åˆæœŸXåº§æ¨™: {test_result['initial_ball_x']}
   æ›´æ–°å¾ŒXåº§æ¨™: {test_result['final_ball_x']}
   è¡çªæ¤œå‡º: {test_result['collision_detected']}
   ãƒœãƒ¼ãƒ«ç§»å‹•: {test_result['ball_moved']}
   çŠ¶æ…‹æ§‹é€ : {test_result['state_structure']}
   çµæœ: {test_result['status']}

ğŸ”„ MVCãƒ‘ã‚¿ãƒ¼ãƒ³ãŒWebç’°å¢ƒã§ã‚‚æ­£å¸¸å‹•ä½œã—ã¦ã„ã¾ã™ï¼"""
                `);
                
                updateOutput(result);
                
            } catch (error) {
                updateOutput(`âŒ MVCãƒ†ã‚¹ãƒˆå¤±æ•—: ${error.message}`);
            }
        };

        // ãƒ†ã‚¹ãƒˆ4: ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆ
        document.getElementById('test-performance').onclick = async function() {
            try {
                updateOutput("\n=== ãƒ†ã‚¹ãƒˆ4: WASM ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆ ===");
                
                const result = pyodide.runPython(`
import time
import math

def performance_test():
    """WASMç’°å¢ƒã§ã®ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆ"""
    
    # è¨ˆç®—é›†ç´„çš„ãƒ†ã‚¹ãƒˆ
    start_time = time.time()
    
    # æ•°å­¦è¨ˆç®—ãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯
    total = 0
    for i in range(100000):
        total += math.sqrt(i * 3.14159)
    
    calc_time = time.time() - start_time
    
    # ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡æ¦‚ç®—
    start_time = time.time()
    
    # ãƒªã‚¹ãƒˆæ“ä½œãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯
    test_list = []
    for i in range(10000):
        test_list.append(i ** 2)
    
    memory_time = time.time() - start_time
    
    # ç‰©ç†æ¼”ç®—ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
    start_time = time.time()
    
    # ãƒœãƒ¼ãƒ«ç‰©ç†æ¼”ç®—ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
    balls = []
    for i in range(100):
        ball = {
            'x': i * 5.0,
            'y': i * 3.0,
            'dx': math.sin(i * 0.1) * 10,
            'dy': math.cos(i * 0.1) * 10
        }
        balls.append(ball)
    
    # 1000ãƒ•ãƒ¬ãƒ¼ãƒ åˆ†ã®ç‰©ç†æ¼”ç®—
    for frame in range(1000):
        for ball in balls:
            ball['x'] += ball['dx']
            ball['y'] += ball['dy']
            
            # ç°¡å˜ãªå¢ƒç•Œãƒã‚§ãƒƒã‚¯
            if ball['x'] < 0 or ball['x'] > 640:
                ball['dx'] *= -1
            if ball['y'] < 0 or ball['y'] > 480:
                ball['dy'] *= -1
    
    physics_time = time.time() - start_time
    
    # ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¬ãƒ¼ãƒˆè¨ˆç®—
    target_fps = 60
    frame_time = physics_time / 1000  # 1ãƒ•ãƒ¬ãƒ¼ãƒ ã‚ãŸã‚Šã®æ™‚é–“
    estimated_fps = 1.0 / frame_time if frame_time > 0 else 0
    
    return {
        'calc_time': calc_time,
        'memory_time': memory_time,
        'physics_time': physics_time,
        'frame_time_ms': frame_time * 1000,
        'estimated_fps': estimated_fps,
        'performance_score': 'GOOD' if estimated_fps >= 30 else 'FAIR' if estimated_fps >= 15 else 'POOR'
    }

# ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
perf_result = performance_test()

f"""ğŸš€ WASM ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆçµæœ:
   æ•°å­¦è¨ˆç®— (100k ops): {perf_result['calc_time']:.3f}ç§’
   ãƒ¡ãƒ¢ãƒªæ“ä½œ (10k ops): {perf_result['memory_time']:.3f}ç§’
   ç‰©ç†æ¼”ç®— (100ballsÃ—1000f): {perf_result['physics_time']:.3f}ç§’
   1ãƒ•ãƒ¬ãƒ¼ãƒ æ™‚é–“: {perf_result['frame_time_ms']:.2f}ms
   æ¨å®šFPS: {perf_result['estimated_fps']:.1f}
   ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹: {perf_result['performance_score']}

ğŸ’¡ WASMç’°å¢ƒã§ã®å®Ÿç”¨çš„ãªã‚²ãƒ¼ãƒ å®Ÿè¡ŒãŒå¯èƒ½ã§ã™ï¼"""
                `);
                
                updateOutput(result);
                
            } catch (error) {
                updateOutput(`âŒ ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆå¤±æ•—: ${error.message}`);
            }
        };

        // åˆæœŸåŒ–å®Ÿè¡Œ
        main();
    </script>
</body>
</html>