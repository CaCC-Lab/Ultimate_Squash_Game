<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebWorker Phase 4 çµ±åˆãƒ†ã‚¹ãƒˆ - Ultimate Squash Game</title>
    <style>
        body {
            font-family: 'Courier New', monospace;
            background: #1a1a1a;
            color: #00ff00;
            margin: 0;
            padding: 20px;
            line-height: 1.4;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .header {
            text-align: center;
            border-bottom: 2px solid #00ff00;
            padding-bottom: 20px;
            margin-bottom: 30px;
        }
        
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #333;
            border-radius: 5px;
            background: #0f0f0f;
        }
        
        .test-controls {
            text-align: center;
            margin: 30px 0;
        }
        
        .btn {
            background: #003300;
            color: #00ff00;
            border: 2px solid #00ff00;
            padding: 10px 20px;
            margin: 5px;
            cursor: pointer;
            font-family: inherit;
            font-size: 14px;
            border-radius: 5px;
            transition: all 0.3s;
        }
        
        .btn:hover {
            background: #00ff00;
            color: #000;
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .log-container {
            height: 400px;
            overflow-y: auto;
            background: #000;
            border: 1px solid #333;
            padding: 10px;
            font-size: 12px;
            white-space: pre-wrap;
        }
        
        .status-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background: #111;
            border: 1px solid #333;
            margin-bottom: 20px;
        }
        
        .status-indicator {
            padding: 5px 10px;
            border-radius: 3px;
            font-weight: bold;
        }
        
        .status-ready { background: #003300; color: #00ff00; }
        .status-running { background: #333300; color: #ffff00; }
        .status-success { background: #003300; color: #00ff00; }
        .status-error { background: #330000; color: #ff0000; }
        
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        
        .metric-card {
            background: #111;
            border: 1px solid #333;
            padding: 15px;
            border-radius: 5px;
        }
        
        .metric-value {
            font-size: 24px;
            font-weight: bold;
            color: #00ff00;
        }
        
        .metric-label {
            font-size: 12px;
            color: #888;
            margin-top: 5px;
        }
        
        .progress-bar {
            width: 100%;
            height: 20px;
            background: #333;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #003300, #00ff00);
            width: 0%;
            transition: width 0.3s;
        }
        
        .warning { color: #ffaa00; }
        .error { color: #ff4444; }
        .success { color: #00ff00; }
        .info { color: #4488ff; }
    </style>
</head>
<body>
    <div class="container">
        <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
        <div class="header">
            <h1>ğŸ® WebWorker Phase 4 çµ±åˆãƒ†ã‚¹ãƒˆ</h1>
            <p>Ultimate Squash Game - WebWorkerä¸¦åˆ—å‡¦ç†ã‚·ã‚¹ãƒ†ãƒ æ¤œè¨¼</p>
        </div>
        
        <!-- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒãƒ¼ -->
        <div class="status-bar">
            <div>
                <span class="status-indicator" id="status-indicator">æº–å‚™ä¸­</span>
                <span id="test-progress">0/5 ãƒ†ã‚¹ãƒˆå®Œäº†</span>
            </div>
            <div>
                <span id="elapsed-time">00:00</span>
                <span id="current-test">å¾…æ©Ÿä¸­</span>
            </div>
        </div>
        
        <!-- ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ -->
        <div class="progress-bar">
            <div class="progress-fill" id="progress-fill"></div>
        </div>
        
        <!-- ãƒ†ã‚¹ãƒˆåˆ¶å¾¡ -->
        <div class="test-controls">
            <button class="btn" id="start-test" onclick="startIntegrationTest()">
                ğŸš€ çµ±åˆãƒ†ã‚¹ãƒˆé–‹å§‹
            </button>
            <button class="btn" id="stop-test" onclick="stopTest()" disabled>
                ğŸ›‘ ãƒ†ã‚¹ãƒˆåœæ­¢
            </button>
            <button class="btn" onclick="clearLog()">
                ğŸ—‘ï¸ ãƒ­ã‚°ã‚¯ãƒªã‚¢
            </button>
            <button class="btn" onclick="exportResults()">
                ğŸ’¾ çµæœã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
            </button>
        </div>
        
        <!-- ãƒ¡ãƒˆãƒªã‚¯ã‚¹è¡¨ç¤º -->
        <div class="metrics-grid">
            <div class="metric-card">
                <div class="metric-value" id="fps-metric">--</div>
                <div class="metric-label">å®Ÿéš›FPS</div>
            </div>
            <div class="metric-card">
                <div class="metric-value" id="latency-metric">--</div>
                <div class="metric-label">å¹³å‡ãƒ¬ã‚¹ãƒãƒ³ã‚¹ (ms)</div>
            </div>
            <div class="metric-card">
                <div class="metric-value" id="frames-metric">--</div>
                <div class="metric-label">å‡¦ç†ãƒ•ãƒ¬ãƒ¼ãƒ æ•°</div>
            </div>
            <div class="metric-card">
                <div class="metric-value" id="workers-metric">--</div>
                <div class="metric-label">ã‚¢ã‚¯ãƒ†ã‚£ãƒ–Workeræ•°</div>
            </div>
        </div>
        
        <!-- ãƒ­ã‚°è¡¨ç¤º -->
        <div class="test-section">
            <h3>ğŸ“‹ ãƒ†ã‚¹ãƒˆå®Ÿè¡Œãƒ­ã‚°</h3>
            <div class="log-container" id="log-container"></div>
        </div>
        
        <!-- ãƒ†ã‚¹ãƒˆçµæœè©³ç´° -->
        <div class="test-section" id="results-section" style="display: none;">
            <h3>ğŸ“Š ãƒ†ã‚¹ãƒˆçµæœè©³ç´°</h3>
            <div id="results-content"></div>
        </div>
    </div>

    <!-- JavaScriptãƒ­ã‚¸ãƒƒã‚¯ -->
    <script type="module">
        import { WebWorkerIntegrationTest } from './test-webworker-integration.js';
        
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        let testInstance = null;
        let testRunning = false;
        let startTime = 0;
        let timerInterval = null;
        
        // DOMè¦ç´ 
        const statusIndicator = document.getElementById('status-indicator');
        const testProgress = document.getElementById('test-progress');
        const elapsedTime = document.getElementById('elapsed-time');
        const currentTest = document.getElementById('current-test');
        const progressFill = document.getElementById('progress-fill');
        const logContainer = document.getElementById('log-container');
        const startBtn = document.getElementById('start-test');
        const stopBtn = document.getElementById('stop-test');
        const resultsSection = document.getElementById('results-section');
        const resultsContent = document.getElementById('results-content');
        
        // ãƒ¡ãƒˆãƒªã‚¯ã‚¹è¦ç´ 
        const fpsMetric = document.getElementById('fps-metric');
        const latencyMetric = document.getElementById('latency-metric');
        const framesMetric = document.getElementById('frames-metric');
        const workersMetric = document.getElementById('workers-metric');
        
        // ãƒ­ã‚°å‡ºåŠ›ã®ã‚ªãƒ¼ãƒãƒ¼ãƒ©ã‚¤ãƒ‰
        const originalConsoleLog = console.log;
        const originalConsoleError = console.error;
        const originalConsoleWarn = console.warn;
        
        console.log = (...args) => {
            originalConsoleLog(...args);
            appendLog('info', args.join(' '));
        };
        
        console.error = (...args) => {
            originalConsoleError(...args);
            appendLog('error', args.join(' '));
        };
        
        console.warn = (...args) => {
            originalConsoleWarn(...args);
            appendLog('warning', args.join(' '));
        };
        
        // ãƒ­ã‚°è¿½åŠ é–¢æ•°
        function appendLog(type, message) {
            const timestamp = new Date().toLocaleTimeString();
            const logLine = `[${timestamp}] ${message}\n`;
            
            const logDiv = document.createElement('div');
            logDiv.className = type;
            logDiv.textContent = logLine;
            
            logContainer.appendChild(logDiv);
            logContainer.scrollTop = logContainer.scrollHeight;
        }
        
        // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°
        function updateStatus(status, message = '') {
            statusIndicator.textContent = message || status;
            statusIndicator.className = `status-indicator status-${status}`;
        }
        
        // ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹æ›´æ–°
        function updateProgress(current, total) {
            const percentage = (current / total) * 100;
            progressFill.style.width = `${percentage}%`;
            testProgress.textContent = `${current}/${total} ãƒ†ã‚¹ãƒˆå®Œäº†`;
        }
        
        // ã‚¿ã‚¤ãƒãƒ¼æ›´æ–°
        function updateTimer() {
            if (testRunning) {
                const elapsed = (Date.now() - startTime) / 1000;
                const minutes = Math.floor(elapsed / 60);
                const seconds = Math.floor(elapsed % 60);
                elapsedTime.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            }
        }
        
        // ãƒ¡ãƒˆãƒªã‚¯ã‚¹æ›´æ–°
        function updateMetrics(data) {
            if (data.performanceMetrics) {
                fpsMetric.textContent = data.performanceMetrics.actualFPS ? data.performanceMetrics.actualFPS.toFixed(1) : '--';
                latencyMetric.textContent = data.performanceMetrics.averageLatency ? data.performanceMetrics.averageLatency.toFixed(1) : '--';
                framesMetric.textContent = data.performanceMetrics.totalFrames || '--';
            }
            
            // Workeræ•°ã¯å›ºå®šï¼ˆgame-logic, ai, analyticsï¼‰
            workersMetric.textContent = '3';
        }
        
        // ãƒ¡ã‚¤ãƒ³çµ±åˆãƒ†ã‚¹ãƒˆé–¢æ•°
        window.startIntegrationTest = async function() {
            if (testRunning) {
                console.warn('ãƒ†ã‚¹ãƒˆæ—¢ã«å®Ÿè¡Œä¸­ã§ã™');
                return;
            }
            
            console.log('ğŸš€ WebWorker Phase 4 çµ±åˆãƒ†ã‚¹ãƒˆé–‹å§‹');
            
            testRunning = true;
            startTime = Date.now();
            
            // UIæ›´æ–°
            startBtn.disabled = true;
            stopBtn.disabled = false;
            updateStatus('running', 'å®Ÿè¡Œä¸­');
            updateProgress(0, 5);
            resultsSection.style.display = 'none';
            
            // ã‚¿ã‚¤ãƒãƒ¼é–‹å§‹
            timerInterval = setInterval(updateTimer, 1000);
            
            try {
                // ãƒ†ã‚¹ãƒˆã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ä½œæˆ
                testInstance = new WebWorkerIntegrationTest();
                
                // ãƒ†ã‚¹ãƒˆå®Ÿè¡Œå‰ã®æº–å‚™
                currentTest.textContent = 'åˆæœŸåŒ–ä¸­...';
                updateProgress(0, 5);
                
                // ã‚«ã‚¹ã‚¿ãƒ ãƒ†ã‚¹ãƒˆå®Ÿè¡Œï¼ˆæ®µéšçš„ã«é€²æ—æ›´æ–°ï¼‰
                await runCustomTestSuite();
                
                // æˆåŠŸ
                updateStatus('success', 'ãƒ†ã‚¹ãƒˆå®Œäº†');
                updateProgress(5, 5);
                console.log('âœ… çµ±åˆãƒ†ã‚¹ãƒˆå®Œå…¨æˆåŠŸï¼');
                
            } catch (error) {
                updateStatus('error', 'ãƒ†ã‚¹ãƒˆå¤±æ•—');
                console.error('âŒ çµ±åˆãƒ†ã‚¹ãƒˆå¤±æ•—:', error);
            } finally {
                testRunning = false;
                startBtn.disabled = false;
                stopBtn.disabled = true;
                currentTest.textContent = 'å®Œäº†';
                
                if (timerInterval) {
                    clearInterval(timerInterval);
                    timerInterval = null;
                }
                
                // çµæœè¡¨ç¤º
                displayResults();
            }
        };
        
        // ã‚«ã‚¹ã‚¿ãƒ ãƒ†ã‚¹ãƒˆã‚¹ã‚¤ãƒ¼ãƒˆï¼ˆé€²æ—è¡¨ç¤ºä»˜ãï¼‰
        async function runCustomTestSuite() {
            // ã‚¹ãƒ†ãƒƒãƒ—1: åˆæœŸåŒ–
            currentTest.textContent = 'ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–ä¸­...';
            await testInstance.testInitialization();
            updateProgress(1, 5);
            
            // ã‚¹ãƒ†ãƒƒãƒ—2: åŸºæœ¬é€šä¿¡
            currentTest.textContent = 'Workeré€šä¿¡ãƒ†ã‚¹ãƒˆä¸­...';
            await testInstance.testBasicCommunication();
            updateProgress(2, 5);
            
            // ã‚¹ãƒ†ãƒƒãƒ—3: ã‚²ãƒ¼ãƒ ãƒ«ãƒ¼ãƒ—
            currentTest.textContent = 'ã‚²ãƒ¼ãƒ ãƒ«ãƒ¼ãƒ—ãƒ†ã‚¹ãƒˆä¸­...';
            await testInstance.testGameLoop();
            updateProgress(3, 5);
            updateMetrics(testInstance.testResults);
            
            // ã‚¹ãƒ†ãƒƒãƒ—4: ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹
            currentTest.textContent = 'ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆä¸­...';
            await testInstance.testPerformance();
            updateProgress(4, 5);
            updateMetrics(testInstance.testResults);
            
            // ã‚¹ãƒ†ãƒƒãƒ—5: ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
            currentTest.textContent = 'ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ãƒ†ã‚¹ãƒˆä¸­...';
            await testInstance.testErrorHandling();
            updateProgress(5, 5);
            
            // æœ€çµ‚ãƒ¬ãƒãƒ¼ãƒˆ
            await testInstance.generateFinalTestReport();
        }
        
        // ãƒ†ã‚¹ãƒˆåœæ­¢
        window.stopTest = async function() {
            if (!testRunning) return;
            
            console.log('ğŸ›‘ ãƒ†ã‚¹ãƒˆåœæ­¢è¦æ±‚');
            testRunning = false;
            
            if (testInstance) {
                await testInstance.cleanup();
            }
            
            updateStatus('ready', 'åœæ­¢æ¸ˆã¿');
            startBtn.disabled = false;
            stopBtn.disabled = true;
            currentTest.textContent = 'åœæ­¢';
        };
        
        // ãƒ­ã‚°ã‚¯ãƒªã‚¢
        window.clearLog = function() {
            logContainer.innerHTML = '';
        };
        
        // çµæœè¡¨ç¤º
        function displayResults() {
            if (!testInstance || !testInstance.testResults.finalReport) {
                return;
            }
            
            const results = testInstance.testResults;
            const report = results.finalReport;
            
            let html = `
                <div class="metrics-grid">
                    <div class="metric-card">
                        <div class="metric-value ${report.testSuiteSuccess ? 'success' : 'error'}">
                            ${report.testSuiteSuccess ? 'âœ…' : 'âŒ'}
                        </div>
                        <div class="metric-label">ç·åˆåˆ¤å®š</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value">${report.successRate.toFixed(1)}%</div>
                        <div class="metric-label">æˆåŠŸç‡</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value">${(report.totalDuration/1000).toFixed(1)}s</div>
                        <div class="metric-label">å®Ÿè¡Œæ™‚é–“</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value">${report.passedTests}/${report.totalTests}</div>
                        <div class="metric-label">ãƒ†ã‚¹ãƒˆçµæœ</div>
                    </div>
                </div>
                
                <h4>ğŸ“‹ è©³ç´°çµæœ</h4>
                <ul>
                    <li>åˆæœŸåŒ–: ${formatTestResult(results.initialization)}</li>
                    <li>åŸºæœ¬é€šä¿¡: ${formatTestResult(results.pingTests)}</li>
                    <li>ã‚²ãƒ¼ãƒ ãƒ«ãƒ¼ãƒ—: ${formatTestResult(results.gameLoopTest)}</li>
                    <li>ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹: ${formatTestResult(results.performanceMetrics)}</li>
                    <li>ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°: ${formatTestResult(results.errorHandling)}</li>
                </ul>
            `;
            
            if (results.performanceMetrics && results.performanceMetrics.success) {
                const perf = results.performanceMetrics;
                html += `
                    <h4>âš¡ ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹è©³ç´°</h4>
                    <ul>
                        <li>FPSåŠ¹ç‡: ${perf.fpsEfficiency.toFixed(1)}% (${perf.actualFPS.toFixed(1)}/${perf.targetFPS})</li>
                        <li>å¹³å‡ãƒ¬ã‚¹ãƒãƒ³ã‚¹: ${perf.averageLatency.toFixed(1)}ms</li>
                        <li>å‡¦ç†ãƒ•ãƒ¬ãƒ¼ãƒ æ•°: ${perf.totalFrames}</li>
                        <li>ã‚¨ãƒ©ãƒ¼æ•°: ${perf.errorCount}</li>
                    </ul>
                `;
            }
            
            resultsContent.innerHTML = html;
            resultsSection.style.display = 'block';
        }
        
        // ãƒ†ã‚¹ãƒˆçµæœãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
        function formatTestResult(result) {
            if (!result) return 'æœªå®Ÿè¡Œ';
            const icon = result.success ? 'âœ…' : 'âŒ';
            const duration = result.duration ? ` (${result.duration.toFixed(1)}ms)` : '';
            return `${icon} ${result.success ? 'æˆåŠŸ' : 'å¤±æ•—'}${duration}`;
        }
        
        // çµæœã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
        window.exportResults = function() {
            if (!testInstance) {
                console.warn('ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã™ã‚‹ãƒ†ã‚¹ãƒˆçµæœãŒã‚ã‚Šã¾ã›ã‚“');
                return;
            }
            
            const results = {
                timestamp: new Date().toISOString(),
                testResults: testInstance.testResults,
                userAgent: navigator.userAgent,
                platform: navigator.platform
            };
            
            const blob = new Blob([JSON.stringify(results, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = `webworker-test-results-${new Date().toISOString().slice(0, 19).replace(/:/g, '-')}.json`;
            a.click();
            
            URL.revokeObjectURL(url);
            console.log('ğŸ“ ãƒ†ã‚¹ãƒˆçµæœã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã—ã¾ã—ãŸ');
        };
        
        // åˆæœŸåŒ–
        updateStatus('ready', 'æº–å‚™å®Œäº†');
        console.log('ğŸ® WebWorker Phase 4 çµ±åˆãƒ†ã‚¹ãƒˆãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿å®Œäº†');
        console.log('ã€Œçµ±åˆãƒ†ã‚¹ãƒˆé–‹å§‹ã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãƒ†ã‚¹ãƒˆã‚’é–‹å§‹ã—ã¦ãã ã•ã„');
    </script>
</body>
</html>